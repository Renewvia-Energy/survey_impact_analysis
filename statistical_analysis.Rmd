---
title: "Renewvia - Survey Impact Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# Overview

## Descriptive

-   Generating summary statistics

-   Plotting graphs/charts

## **Inferential**

-   For the paired data set, we will use the following

    -   Paired t-Test for ratio

    -   Wilcoxon Signed Rank Test (Sign Test if asymmetric) for ordinal variables

    -   McNemar's Test for binary responses

-   Our independent variables will be the following: PV Size (kWh), No. of Customers, CAPEX (USD) and Consumption (Community & Customer).

-   For each dependent variables, we will run a uni-variate regression tests with each of independent variable. When applicable, we will have a Linear regression t-Test or Logistic regression Wald test

# Libraries

```{r}
# Importing libraries
options(warn=-1)
library(ggplot2)
library(dplyr)
library(lessR)
library(tidyr)
library(ggpubr)
library(exact2x2)
library(stringr)
library(epiDisplay)
library(tibble)
library(ggExtra)
library(vtree)
library(CGPfunctions)
library(psych)
library(nonpar)
library(scales)
library(tidyverse)
library(ggrepel)
library(data.table)
library(forcats)
library(glue)
library(aod)
```

# Input Data

## Community

```{r}
## Locading the project& consumption data
consumption <- read.csv("customer_consumption.csv")
customer_info <- read.csv("customers_info.csv")

temp <- merge(consumption, customer_info, 
              by.x = 'Account.Number',
              by.y = 'customerAccountNumber')  
temp_group <- temp %>% 
                    group_by(projectName) %>% 
                    summarise(consumption = sum(Energy.Consumption, na.rm=TRUE))
projects <- read.csv("project_data.csv")
projects <- merge(projects, temp_group, by.x="project_name", by.y="projectName")
```

## Surveys - Clean

```{r}
## Locading the cleaned data sets
# Intial Survey
initial <- read.csv("data_cleaning/datasets_clean/initial_clean.csv",
                          na.strings=c("","NA"))
initial_clean <- merge(initial, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre <- initial_clean %>%
                    filter(status == "pre_connection") 

# Post-connection
initial_post <- initial_clean %>%
                    filter(status == "post_connection") 

# Household Post-Survey
post <- read.csv("data_cleaning/datasets_clean/post_clean.csv",
                          na.strings=c("","NA"))
post_clean <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')%>% 
                    filter(tariff == "Residential")

## Pairing pre and post responses
paired_clean <- merge(initial_pre, post_clean,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')

# Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_clean/ci_post_clean.csv",
                          na.strings=c("","NA"))
ci_clean <- merge(ci, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
# head(ci_clean)
```

## Surveys - Encoded

```{r}
## Locading the encoded data sets
# Intial Survey
initial_enc <- read.csv("data_cleaning/datasets_encoded/initial_encoded.csv",
                          na.strings=c("","NA")) 
initial_enc <- merge(initial_enc, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre_enc <- initial_enc %>%
                    filter(status == 1)
# Pre-connection
initial_post_enc <- initial_enc %>%
                    filter(status == 2)

# Household Post-Survey
post <- read.csv("data_cleaning/datasets_encoded/post_encoded.csv",
                          na.strings=c("","NA"))
post_enc <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')  %>% 
                    filter(tariff == "Residential")

# Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_encoded/ci_post_encoded.csv",
                          na.strings=c("","NA")) 
ci_enc <- merge(ci, temp,
                 by.x = 'renewvia_id', 
                 by.y = 'Account.Number')

paired_enc <- merge(initial_pre_enc, post_enc,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
```

# Utility Functions

## Descriptive

```{r}
get_stats <- function(data, ct, var_name,data_source,
                      remove_outliers = FALSE, 
                      exclude_zeros = FALSE) {
  if (grepl("_pre", var_name, fixed = TRUE)){
    country_data <- data %>% filter(country_pre == ct)
  } else if (grepl("_post", var_name, fixed = TRUE)){
    country_data <- data %>% filter(country_post == ct)
  } else {country_data <- data %>% filter(country == ct)}
    
  if (remove_outliers == TRUE) {
    print("Excluding outliers")
    quartiles <- quantile(country_data[, var_name], 
                        probs=c(.25, .75), na.rm = TRUE)
  
    IQR <- IQR(country_data[, var_name], na.rm = TRUE)
    
    Lower <- quartiles[1] - 1.5*IQR
    Upper <- quartiles[2] + 1.5*IQR 
    
    country_data <- subset(country_data, 
                              country_data[, var_name] > Lower &
                              country_data[, var_name] < Upper)
  } 
  
  var <- country_data[, var_name]
  
  if (exclude_zeros == TRUE) {
    print("Removing Zeros")
    var <- var[var != 0]
  } 
  
  stats <- t(describe(var, IQR=TRUE, quant=c(.1,.25,.5,.75,.90),))
  print(t.test(var, conf.level = 0.95))
  print(stats)
}
```

## Data Visualization

```{r}
remove_y <- theme(
  axis.text.y = element_blank(),
  axis.ticks.y = element_blank(),
  axis.title.y = element_blank()
)

remove_x <- theme(
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank(),
  axis.title.x = element_blank()
)
```

### Plot graphs with ggplot

```{r}
# For pie and bar charts
plot_func <- function(df, var_name, var_type, 
                      plot_title, lgd, plot_type, 
                      char_remove=NULL,
                      remove_outliers = FALSE) {
  if(is.null(char_remove) == FALSE) {
    df <- df %>% filter(.data[[var_name]] != char_remove)
  }
  
  if(remove_outliers == TRUE) {
      print("Removing outliers")
      quartiles <- quantile(df[, var_name], 
                        probs=c(.25, .75), na.rm = TRUE)
  
      IQR <- IQR(df[, var_name], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      df <- subset(df, 
                     df[, var_name] > Lower &
                     df[, var_name]< Upper)
    }
  if(var_type == "non_cont") {
      var <- df[, var_name]
      var <- var[var != ""]
      
      data <- as.data.frame(t(table(var)))[,2:3] 
      setnames(data, 
               old = c('var','Freq'), 
               new = c('labels','counts'))
      # print(data)
      data_tab <- data %>% mutate(csum = rev(cumsum(rev(counts))),
                       pos = counts/2 + lead(csum, 1),
                       pos = if_else(is.na(pos), counts/2, pos),
                       percentage = counts/sum(counts))
      data_tab$labels <- as.factor(data_tab$labels)
      if (plot_type == 'pie') {
          plot <- data_tab %>% ggplot(aes(x = "", y = counts, 
                                          fill = labels)) +
                              geom_col(width = 1, color = 1) +
                              geom_label_repel(
                                aes(y = pos,
                                    label = glue("{counts} ({percent(percentage)})"),
                                     fill = labels),
                                    show.legend = FALSE) +
                              labs(fill = lgd, title=plot_title) +
                              coord_polar(theta = "y") +
                              theme_void() + 
                              theme(legend.text=element_text(size=6))
      } else if (plot_type == "bar_simple") {
          plot <- data %>% ggplot(aes(y=counts,
                                      x=reorder(labels, counts),
                                      fill=labels)) +
                            geom_col(width = 0.7) +
                            geom_text(aes(label=counts), vjust=-0.3, size=3)+
                            labs(fill = lgd, title=plot_title) +
                            coord_flip() +
                            theme(legend.text=element_text(size=6))
         
      } else if(plot_type == "bar_stack"){
        
         plot <- data_tab %>% ggplot(aes(x = "", y = counts, 
                                  fill = labels)) +
                      geom_col(width = 1, color = 1) +
                      geom_label_repel(
                        aes(y = pos,
                            label = glue("{counts} ({percent(percentage)})"),
                             fill = labels),
                            show.legend = FALSE) +
                      labs(fill = lgd, title=plot_title) +
                      # coord_polar(theta = "y") +
                      theme_void() + 
                      theme(legend.text=element_text(size=6))
      }
        else if (plot_type == "bar_discrete") {
          plot <- data %>% ggplot(aes(y=counts, x=labels)) + 
                            geom_col(width = 0.7) +
                            labs(title=plot_title, x = var_name) 
      } 
  }else if(var_type == "cont") {
      if(plot_type == "hist") {
        plot <- ggplot(df, aes(x=.data[[var_name]])) + 
                      geom_histogram(stat = "count",
                                     fill = 'yellow',
                                     alpha = 0.7,
                                     col = 'black', bins=10) + 
                      geom_vline(xintercept = mean(df[,var_name], na.rm=TRUE),
                                 col="lightblue", lty=1, lwd = 1) +
                      geom_vline(xintercept = median(df[,var_name], na.rm=TRUE),
                               col="purple", lty=2, lwd = 1) +
                      theme_bw() +
                      labs(title=plot_title) 
      }else if(plot_type == "boxplot") {
        plot <- ggplot(df, aes(x=.data[[var_name]])) + 
                geom_boxplot(outlier.colour="red",
                              outlier.size=4)+
                labs(title=plot_title) +
                theme_void()
    }
  }
  return(plot)
}
```

### General Comparison

```{r}
generic_compare <- function(data, var_type, var1, var2, 
                          var1_title, var2_title, 
                          subplot_type, plot_title,
                          lgd_title, 
                          char_remove=NULL){
  var1_plot <- plot_func(data, var1, var_type, lgd = lgd_title,
                          var1_title, subplot_type, char_remove)
  var2_plot <- plot_func(data, var2, var_type,lgd = lgd_title,
                          var2_title, subplot_type, char_remove)
  if (subplot_type == "bar_simple" || subplot_type == "bar_stack") {
        plot <- ggarrange(var2_plot + remove_y, var1_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = TRUE,legend="bottom")
  } else {
        plot <- ggarrange(var2_plot, var1_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = TRUE,
                        legend="right")
  }
  
  return(annotate_figure(plot, top = text_grob(plot_title, 
                 color = "black", face = "bold", size = 12)))
}
```

### Comparison Unpaired Post-Pre

```{r}
compare_pre_post <- function(df_pre, df_post,
                             var_name, var_type, subplot_type, title, 
                             exclude_outliers = FALSE, lgd_title,
                             char_remove=NULL, shared_legend=TRUE) {

  pre_plot <- plot_func(df_pre, var_name, var_type,
                         "Initial", subplot_type, lgd = lgd_title,
                        char_remove, remove_outliers=exclude_outliers)
  post_plot <- plot_func(df_post, var_name, var_type,
                          "Post", subplot_type, lgd = lgd_title,
                         char_remove, remove_outliers=exclude_outliers)
  if (subplot_type == "bar_simple" || subplot_type == "bar_stack") {
        plot <- ggarrange(post_plot + remove_y, pre_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = shared_legend,legend="bottom")
  } else {
        plot <- ggarrange(post_plot, pre_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = shared_legend,
                        legend="right")
  }
      
  return(annotate_figure(plot, 
                         top = text_grob(title, color = "black", 
                                         face = "bold", size = 12)))

}
```

### Comparison Paired Post-Pre

```{r}
compare_paired <- function(data, var_name, view,
                           lgd_title, plot_title,
                          char_remove=NULL){
    var_pre <- as.factor(data[,paste(var_name, "pre", sep="_")])
    var_post <- as.factor(data[,paste(var_name, "post", sep="_")])
    x <- list(labels = c(unique(var_post[is.na(var_post) == FALSE])))
    paired_df <- as.data.frame(x)
    counts_post <- as.data.frame(t(table(var_post)))[,2:3]
    props_post <- as.data.frame(prop.table(table(var_post)))
    setnames(counts_post,
             old = c('var_post','Freq'),
             new = c('labels','counts_post'))
    setnames(props_post,
             old = c('var_post','Freq'),
             new = c('labels','props_post'))
    
    counts_pre <- as.data.frame(t(table(var_pre)))[,2:3]
    props_pre <- as.data.frame(prop.table(table(var_pre)))
    setnames(counts_pre,
             old = c('var_pre','Freq'),
             new = c('labels','counts_pre'))
    setnames(props_pre,
         old = c('var_pre','Freq'),
         new = c('labels','props_pre'))
    
    df_list <- list(paired_df, counts_post, counts_pre, props_pre, props_post)
    merged <- df_list %>% reduce(left_join, by='labels')
    merged <- merged %>% replace(is.na(.), 0)
    merged$diff_counts <- merged$counts_post - merged$counts_pre
    merged$diff_props <- merged$props_post - merged$props_pre
    merged$count_change <- merged$diff_counts/merged$counts_pre
    print(merged)
    
    # side_plot <- 
    count_plot <- merged %>% ggplot(aes(x = labels, y = diff_counts)) +
                      geom_bar(aes(fill = labels), stat="identity") +
                      geom_label_repel(
                        aes(label = 
                              glue("{diff_counts} ({percent(count_change)})"),
                            fill = labels),
                            show.legend = FALSE) +
                      labs(fill = lgd_title, 
                           y="Difference in Counts") +
                        theme(legend.text=element_text(size=6)) + 
                        remove_x
    
    prop_plot <- merged %>% ggplot(aes(x = labels, y = diff_props)) +
                  geom_bar(aes(fill = labels), stat="identity") +
                  geom_label_repel(
                    aes(label = 
                          glue("{percent(diff_props)}"),
                        fill = labels),
                        show.legend = FALSE) +
                  labs(fill = lgd_title,  
                       y="Difference in Proportions") +
                    theme(legend.text=element_text(size=6)) + 
                    remove_x
    
    plot <- ggarrange(count_plot, prop_plot,
                          ncol = 2,  nrow = 1, 
                          common.legend = TRUE,legend="bottom")

    return(annotate_figure(plot, 
                         top = text_grob(plot_title, color = "black", 
                                         face = "bold", size = 12)))
}
```

## Hypothesis Testing

```{r}
# Running the paired t-test
paired_testing <- function(data, var_name, test_type, 
                           plot_diff=FALSE, plot_title=NULL, 
                           remove_outliers=FALSE) {
  pre_name <- paste(var_name, "pre", sep="_")
  post_name <- paste(var_name, "post", sep="_")
  
  sprintf("Removing outliers for both %s and %s", pre_name, post_name)
  vars <- c(pre_name, post_name) 
  if(remove_outliers==TRUE) {
    for(var in vars){
      quartiles <- quantile(data[, var], 
                        probs=c(.25, .75), na.rm = TRUE)
  
      IQR <- IQR(data[, var], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      data <- subset(data, 
                     data[, var] > Lower &
                     data[, var] < Upper)
    } 
  }
  var_pre <- data[, pre_name]
  var_post <- data[, post_name]
  diff <- var_post - var_pre
  # Running the test
  if(test_type == "wilcoxon"){
    #Wilcoxon Signed-Rank Test
    test <- wilcox.test(var_pre, var_post, paired=TRUE)
  }else if(test_type == "sign") {
    #Sign Test
    test <- signtest(diff, m=0, conf.level=0.95, exact=FALSE)
  } else if (test_type == "ttest") {
    #Paired t-Test
    test <- t.test(var_pre, var_post,
         paired = TRUE, alternative = "two.sided")
  } else if(test_type == "mcnemar") {
    cross_tab <- table(var_pre, var_post)
    print(cross_tab)
    test <- mcnemar.test(cross_tab)
  }
  
  # Visualize distribution of score differences
  if(plot_diff == TRUE) {
      hist(diff, main=plot_title)
  }
  return(test)
}
```

## Regression Testing

### Plotting Scatter-plots

```{r}
plot_reg <- function(data, feature, dependent, 
                     remove_outliers=TRUE, which_outliers,
                     reg_type, vals_remove=NULL) {
  
  if(is.null(vals_remove) == FALSE) {
    data <- data[!grepl(vals_remove,data$dependent),]
  }
  
  if(remove_outliers == TRUE) {
    if(which_outliers=="all") {
      vars <- c(feature, dependent) 
      for(var in vars){
        quartiles <- quantile(data[, var], 
                          probs=c(.25, .75), na.rm = TRUE)
      
        IQR <- IQR(data[, var], na.rm = TRUE)
        
        Lower <- quartiles[1] - 1.5*IQR
        Upper <- quartiles[2] + 1.5*IQR 
        
        data <- subset(data, 
                       data[, var] > Lower &
                       data[, var] < Upper)
      }
    }else if(which_outliers=="dependent"){
      var <- dependent
      quartiles <- quantile(data[, var], 
                          probs=c(.25, .75), na.rm = TRUE)
      
      IQR <- IQR(data[, var], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      data <- subset(data, 
                     data[, var] > Lower &
                     data[, var] < Upper)
    }else if(which_outliers=="feature"){
      var <- feature
      quartiles <- quantile(data[, var], 
                          probs=c(.25, .75), na.rm = TRUE)
      
      IQR <- IQR(data[, var], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      data <- subset(data, 
                     data[, var] > Lower &
                     data[, var] < Upper)
    }
  }
  
  if(reg_type == "linear") {
    plot <- ggplot(data,
                aes(x=.data[[feature]], y=.data[[dependent]])) +
                geom_point(color='blue') +
                  geom_smooth(color='red', method = "lm", se = FALSE) +
                theme_classic()
  } else if(reg_type == "logistic") {
    print(head(data))
     plot <- ggplot(data, 
                    aes(x=.data[[feature]], y=.data[[dependent]])) + 
              geom_point(color='blue', alpha=.5) +
             geom_smooth(method = "glm", color='red',
                         method.args= list(family="binomial"), se=FALSE)
                theme_classic()
  }
 
  return(plot)
}
```

### Community Variables

```{r}
ind_vars <- c("pv_size_kwh", "customer_count", "capex_usd", "consumption")

community_reg <- function(df, col_name, dep, title, 
                          var_type, calc_diff=FALSE, 
                          to_remove=NULL, outliers) {
  if (calc_diff == TRUE) {
      pre_name <- paste(col_name, "pre", sep="_")
      post_name <- paste(col_name, "post", sep="_")
      df$col_reg <- df[, post_name] - df[, pre_name]
      names(df)[names(df) == "community_post"] <- "community"
  } else {
      df$col_reg <- df[, col_name]
  }
  
  if(var_type == "categorical") {
    data <- rownames_to_column(as.data.frame.matrix(
                                  table(df[, "community"], 
                                        df[, "col_reg"])), 
                               var = "community")
  } else if(var_type == "ratio") {
    data <- as.data.frame(rowsum(df[, "col_reg"], 
                                 df[, "community"], na.rm = TRUE))
    data$community <- rownames(data)
    
    
  }
  community_data <- merge(x=projects, y=data, by="community")
  print(community_data)
  lst <- list()
  
   for(ind in ind_vars) {
        print(ind)
          p <- plot_reg(data=community_data, feature=ind,  
                        dependent=dep, reg_type="linear",
                        which_outliers = outliers,
                        vals_remove=to_remove)
          lst <- append(lst, list(p))
          pearson_test <- cor.test(community_data[,dep], 
                           community_data[,ind], 
                           method="pearson")
          print(pearson_test)
          
          lm <- lm(community_data[,dep] ~ community_data[,ind])
          details <- summary(lm)
          result <- as.data.frame(details$coefficients,
                                  row.names = c("Intercept", ind))
          print(details)
          print(confint(lm, level=0.95))
      }
  plot <- ggarrange(plotlist = lst, 
                    ncol = 2, nrow = 2, 
                    common.legend = TRUE,
                    legend="right")
  annotate_figure(plot, top = text_grob(title, 
                 color = "black", face = "bold", size = 12))
}

```

### Customer Consumption

```{r}
consumption_reg <- function(df, dep, title, reg_type, 
                            calc_diff=FALSE, 
                            exclude_outliers = FALSE,
                            outliers=NULL, 
                            to_remove=NULL) {

  if(reg_type == "linear") {
    if (calc_diff == TRUE) {
      pre_name <- paste(dep, "pre", sep="_")
      post_name <- paste(dep, "post", sep="_")
      df$col_reg <- df[, post_name] - df[, pre_name]
    } else {
      df$col_reg <- df[, dep]
    }
    
    model <- lm(df$col_reg ~ df$Energy.Consumption)
    print(summary(model))
    print(confint(model, level=0.95))
    p <- plot_reg(data=df, feature="Energy.Consumption",  
                  dependent="col_reg", reg_type="linear", 
                  remove_outliers=exclude_outliers, 
                  which_outliers = outliers,
                  vals_remove=to_remove)
    pearson_test <- cor.test(df$col_reg, 
                           df$Energy.Consumption, 
                           method="pearson")
    print(pearson_test)
    
  } else if(reg_type == "logistic") {
    model <- glm(df$col_reg ~ df$Energy.Consumption, 
               family=binomial)
    print(summary(model))
    print(confint(model, level=0.95))
    p <- plot_reg(data=df, feature="Energy.Consumption",  
                  dependent=dep, reg_type="logistic", 
                  remove_outliers=exclude_outliers,
                  which_outliers = outliers,
                  vals_remove=to_remove)
    test <- wald.test(Sigma = vcov(model), 
                      b = coef(model), Terms = 1)
    print(test)
  }
  
  return(p)
  
}
```

# 1- Gender Equality

## A) Descriptive

### Demographics

```{r}
# What was the gender breakdown of survey respondents, pre and post?
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="gender", var_type="non_cont",
                 lgd_title ="Reasons",
                 subplot_type="pie", title="Gender Breakdown")
```

### Pre-Connection School Enrollment

```{r}
# What was school enrollment by gender pre-connection?
girls <- sum(initial_pre$girls_headcount,na.rm = TRUE)
girls_in_school <- sum(initial_pre$girls_schooling,na.rm = TRUE)
enrollment_rate <- percent(girls_in_school/girls, accuracy = 0.01)

vals <- c(girls, girls_in_school, enrollment_rate)

# creating matrix
tab <- as.data.frame(t(as.matrix(vals)))
setnames(tab, old = c('V1','V2', 'V3'), 
          new = c("Girls", "Girls.In.School", "Enrollment.Rate"))
tab
```

### School Enrollment Change

```{r}
# Was there a change in enrollment by gender afterwards?
generic_compare(data=post_clean, var_type="non_cont",
               var1="girls_schooling_change", 
               var2="boys_schooling_change", 
               lgd_title ="Change",
               var1_title="Girls", var2_title="Boys", 
               subplot_type="pie", plot_title="School Enrollment Change")
```

### Reasons for (un)enrollment

#### Girls' Schooling

```{r}
# Dirving factor for non-enrollment in school for boys and girls
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="girls_unschooled_reasons", 
                 var_type="non_cont",
                 lgd_title ="Reasons",
                 subplot_type="bar_simple", 
                 title="Unpaired - Girls Schooling: Reasons for non-enrollment")

# For Girls
compare_paired(data=paired_clean,
               var_name="girls_unschooled_reasons",
               lgd_title="Reasons",
               plot_title="Girls Schooling: Reasons for non-enrollment")
```

#### Boys' Schooling

```{r}
# For Boys
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="boys_unschooled_reasons", 
                 var_type="non_cont",lgd_title ="Reasons",
                 subplot_type="bar_simple", 
                 title="Unpaired - Boys Schooling: Reasons for non-enrollment")

# Paired
compare_paired(data=paired_clean,
               var_name="boys_unschooled_reasons",
               lgd_title="Reasons",
               plot_title="Paired - Boys Schooling: Reasons for non-enrollment")
```

### Household Chores

#### Water Collection - Responsibility

```{r}
# What is the average age of the person in charge of water collection?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="avg_person_age_water_collection", 
                 var_type="non_cont",
                 lgd_title="Age Group",
                 subplot_type="bar_simple", 
                 title="Unpaired: Age of Person Responsible 
                 for Water Collection")

# Paired
compare_paired(data=paired_clean,
               var_name="avg_person_age_water_collection",
               lgd_title="Age Group",
               plot_title="Paired: Age of Person Responsible 
               for Water Collection")
```

#### Is the person responsible school-aged?

```{r}
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="water_collection_school_aged", 
                 var_type="non_cont",
                 subplot_type="pie",
                 lgd_title="Is the person responsible school-aged?",
                 title="Unpaired: Shcool-Aged Person responsible 
                 for Water Collection")

# Paired
compare_paired(data=paired_clean,
               var_name="water_collection_school_aged",
               lgd_title="Is the person responsible school-aged?",
               plot_title="Paired: Shcool-Aged Person responsible 
                 for Water Collection")
```

#### Cooking Fuel Collection - Are men involved?

```{r}
# unique(paired_clean$cooking_fuel_responsible_post)

# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="cooking_fuel_responsible_binary", 
                 var_type="non_cont",
                 subplot_type="pie",
                 lgd_title="Are men involved?",
                 title="Unpaired: Shcool-Aged Person responsible 
                 for Cooking Fuel Collection")

# Paired
compare_paired(data=paired_clean,
               var_name="cooking_fuel_responsible_binary",
               lgd_title="Are men involved?",
               plot_title="Paired: Shcool-Aged Person responsible 
                 for Cooking Fuel Collection")
```

### Female Businesses Ownership - Subgroup by country, community

```{r}
# How many new women-led businesses were created?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Unpaired - Women Business Owners")

# Paired
compare_paired(data=paired_clean,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Paired: Women Business Owners")
```

#### Subgroup Analysis - Country

```{r}
ctr <- "nigeria"
country_pre <- initial_pre %>% filter(country == ctr)
country_post <- post_clean %>% filter(country == ctr)
compare_pre_post(df_pre=country_pre, df_post=country_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Nigeria Unpaired: Women Business Owners")

# Paired
country_paired <- paired_clean %>% filter(country_post == ctr)
compare_paired(data=country_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Nigeria Paired: Women Business Owners")
```

```{r}
ctr <- "kenya"
country_pre <- initial_pre %>% filter(country == ctr)
country_post <- post_clean %>% filter(country == ctr)
compare_pre_post(df_pre=country_pre, df_post=country_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Kenya Unpaired: Women Business Owners")

# Paired
country_paired <- paired_clean %>% filter(country_post == ctr)
compare_paired(data=country_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Kenya Paired: Women Business Owners")
```

#### Subgroup Analysis - Gender

```{r}
gdr <- "male"
gender_pre <- initial_pre %>% filter(gender == gdr)
gender_post <- post_clean %>% filter(gender == gdr)
compare_pre_post(df_pre=gender_pre, df_post=gender_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Men Unpaired: Women Business Owners")

# Paired
gender_paired <- paired_clean %>% filter(gender_post == gdr)
compare_paired(data=gender_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Men Paired: Women Business Owners")
```

```{r}
gdr <- "female"
gender_pre <- initial_pre %>% filter(gender == gdr)
gender_post <- post_clean %>% filter(gender == gdr)
compare_pre_post(df_pre=gender_pre, df_post=gender_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Women Unpaired: Women Business Owners")

# Paired
gender_paired <- paired_clean %>% filter(gender_post == gdr)
compare_paired(data=gender_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Women Paired: Women Business Owners")
```

### TODO

-   Bar charts by groups, Chi-Square goodness of fit, proportions not counts

-   Qualitative Methods: In respondent's own words, how were women affected from the mini-grid?

## B) Inferential

### School Enrollment Change

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

#### Girls' Schooling - Increase

```{r}
# Check for increase
community_reg(df=post_enc, outliers = "feature",
              col_name="girls_schooling_change", dep="1", 
              var_type="categorical",
              title="Counts of Increase in Girls' School Enrollment by Community")
```

#### Girls' Schooling - Decrease

```{r}
# Check for decrease
community_reg(df=post_enc, outliers = "feature",
              col_name="girls_schooling_change", dep="-1", 
              var_type="categorical",
              title="Counts of Decrease in Girls' School Enrollment by Community")
```

#### Boys' Schooling - Increase

```{r}
# Check for increase
community_reg(df=post_enc, outliers = "feature",
              col_name="boys_schooling_change", dep="1", 
              var_type="categorical",
              title="Counts of Increase in Boys' School Enrollment by Community")
```

#### Boys' Schooling - Decrease

```{r}
# Check for decrease
community_reg(df=post_enc, outliers = "feature",
              col_name="boys_schooling_change", dep="-1", 
              var_type="categorical",
              title="Counts of Increase in Boys' School Enrollment by Community")
```

### Water Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "less than 1 hour" = 1; "1-2 hours" = 2; "2-3 hours" = 3; "3-4 hours" = 4; "greater than 4 hours" = 5

#### Wilcoxon Signed-Rank Test

```{r}
# How long does the water collection process take on a daily basis?
paired_testing(paired_enc, var_name="water_collection_time", 
               test_type = "wilcoxon", plot_diff=TRUE, 
               plot_title="Difference Pre-Post of Water Collection Times")
```

#### Community Variables

```{r}
# Regression - Pre-Post Differences
community_reg(df=paired_enc, outliers = "feature",
              col_name="water_collection_time", dep="V1", 
              var_type="ratio", calc_diff = TRUE,
              title="Cumulative Difference in 
              Water COllection Difference by Community")
```

#### Individual Consumption

```{r}
# Regression - Pre-Post Differences
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "water_collection_time", calc_diff=TRUE,
                title="Individual Difference in 
              Water COllection Difference by Community")
```

### Cooking Fuel Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "No need to collect fuel" = 1; "less than 1 hour" = 2; "1-2 hours" =3; "3-5 hours" = 4; "greater than 4 hours" = 5

#### Wilcoxon Signed-Rank Test

```{r}
# How long does the cooking fuel collection process take on a daily basis?
paired_testing(paired_enc, var_name="cooking_fuel_collection_time", 
               test_type = "wilcoxon", plot_diff=TRUE, 
               plot_title="Difference Pre-Post of Water Collection Times")
```

#### Community Variables

```{r}
# Regression - Pre-Post Differences
community_reg(df=paired_enc, outliers = "feature",
              col_name="cooking_fuel_collection_time", dep="V1", 
              var_type="ratio", calc_diff = TRUE,
              title="Cumulative Difference in 
              Cooking Fuel Collection Time Difference by Community")
```

#### Individual Consumption

```{r}
# Regression - Pre-Post Differences
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "cooking_fuel_collection_time", calc_diff=TRUE,
                title="Individual Difference in 
                Cooking Fuel Collection Time Difference by Community")
```

### Women-led Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Everything else = 0; "adult_female" = 1

```{r}
# Are any household members business owners? Isolate for those with 'adult_'female
paired_testing(paired_enc, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
# Regression - Pre-Post Differences
community_reg(df=paired_enc, outliers = "feature",
              col_name="business_owners_female", dep="1", 
              var_type="categorical", calc_diff = TRUE,
              title="Increase in New Female Business Owners by Community")
```

```{r}
# Regression - Pre-Post Differences
community_reg(df=paired_enc, outliers = "feature",
              col_name="business_owners_female", dep="-1", 
              var_type="categorical", calc_diff = TRUE,
              title="Decrease in New Female Business Owners by Community")
```

#### Subgroup Analysis - Country

```{r}
# Nigeria
ctr <- 1
country_paired <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
# Kenya
ctr <- 2
country_paired <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Subgroup Analysis - Gender

```{r}
# Women
gdr <- 1
gender_paired <- paired_enc %>% filter(gender_post == gdr)
paired_testing(gender_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
# Men
gdr <- 2
gender_paired <- paired_enc %>% filter(gender_post == gdr)
paired_testing(gender_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

### New Female workers

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
# If you answered yes to adding new workers, how many new employees are female?
# Check for increase
community_reg(df=ci_enc, 
              col_name="workforce_change_female", dep="V1", 
              title="New Female Workers Change by Community", 
              outliers="all", var_type="ratio")
```

```{r}
# Regression - Pre-Post Differences
df_reg <- ci_enc %>% filter(workforce_change_female != 0)
consumption_reg(df = df_reg, reg_type ="linear",
                dep= "workforce_change_female", 
                exclude_outliers = TRUE, outliers = "feature",
                title="New Female Workers Change by Community")
```

# 2- Productivity

## A) Descriptive

### Power

#### Sources

```{r}
## What is your primary power source?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, lgd_title ="Types",
                 var_name="power_sources_primary", var_type="non_cont",
                 subplot_type="bar_simple", 
                 title="Unpaired: Primary Power Source")

# Paired
compare_paired(data=paired_clean,
               var_name="power_sources_primary",
               lgd_title="Source Type",
               plot_title="Paired: Pimary Power Source")
```

#### **Un-clean sources: Diesel, Petrol, Kerosene**

```{r}
## What is your primary power source?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 lgd_title ="Is the source non-renewable?",
                 var_name="power_sources_unclean", var_type="non_cont",
                 subplot_type="pie", 
                 title="Unpaired: Usage of unclean sources")

# Paired
compare_paired(data=paired_clean,
               var_name="power_sources_unclean",
               lgd_title="Is the source non-renewable?",
               plot_title="Paired: Usage of unclean sources")
```

### TODO: Light Hours

```{r}
## How many hours of light per day do you currently have at home?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="light_hours_current", var_type="non_cont",
                 subplot_type="bar_discrete", title="Light Hours",
                 char_remove=c(46))

# Paired
# Histogram of differences in paired 
```

### Appliances

#### Count

```{r}
# How many electronic devices or appliances do you currently use in the household
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="appliances_count", var_type="non_cont",
                 subplot_type="bar_discrete", title="Appliances")
```

#### Change

```{r}
# Has the number of electronic devices or appliances increased since connection to minigrid?
plot_func(df=post_clean, var_name="appliances_count_change", 
          var_type="non_cont", lgd = "Change",
          plot_title="Change in No. of Appliances", 
          plot_type="pie")
```

#### Charging Sources

```{r}
# What is your primary power source?
compare_pre_post(df_pre=initial_pre, df_post=post_clean, lgd_title ="Types",
                 var_name="applicances_charging_sources", var_type="non_cont",
                 subplot_type="bar_simple", 
                 title="Unpaired: Appliances Charging Source")

compare_paired(data=paired_clean,
               var_name="applicances_charging_sources",
               lgd_title="Source Type",
               plot_title="Paired: Appliances Charging Source")
```

### Phone Charging

#### Frequency

```{r}
## How often do you need to charge your mobile phone?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="phone_charge_frequency", var_type="non_cont",
                 subplot_type="bar_simple", lgd_title = "Time Intervals",
                 title="Unpaired: Phone Charging Frequency")

# Paired
compare_paired(data=paired_clean,
               var_name="phone_charge_frequency",
               lgd_title="Time Intervals",
               plot_title="Paired: Phone Charging Frequency")
```

#### Location

```{r}
## Where do you typically charge your mobile phone?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="phone_charge_location", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Places",
                 title="Unpaired: Location of Phone Charging")

# Paired
compare_paired(data=paired_clean,
               var_name="phone_charge_location",
               lgd_title="Places",
               plot_title="Paired: Location of Phone Charging")
```

#### Travel Distance

```{r}
# How far must you travel to charge your mobile phone?
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="phone_charge_travel_distance", var_type="non_cont",
                 subplot_type="bar_simple", lgd_title = "Distances",
                 title="Unpaired: Travel Distance to Charge Phone",
                 char_remove=NULL)

# Paired
compare_paired(data=paired_clean,
               var_name="phone_charge_travel_distance",
               lgd_title="Time Intervals",
               plot_title="Paired: Travel Distance to Charge Phone")
```

### Water Collection

#### Travel Distance

```{r}
## How far must you travel to obtain your water supply?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="water_collection_travel_distance", var_type="non_cont",
                 subplot_type="bar", lgd_title = "Distances",
                 title="Travel Distance for Water Collection",
                 char_remove=NULL)

# Paired
compare_paired(data=paired_clean,
               var_name="water_collection_travel_distance",
               lgd_title="Time Intervals",
               plot_title="Paired: Travel Distance for Water Collection")
```

#### Time

```{r}
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="water_collection_time", 
                 var_type="non_cont",
                 subplot_type="bar_simple",
                 lgd_title="Time Intervals",
                 title="Unpaired: Water Collection Time")

# Paired
compare_paired(data=paired_clean,
               var_name="water_collection_time",
               lgd_title="Time Intervals",
               plot_title="Paired: Water Collection Time")
```

### Cooking Fuel 

#### Sources

```{r}
## What is your main source of energy for cooking?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, lgd_title ="Types",
                 var_name="cooking_energy_sources", var_type="non_cont",
                 subplot_type="pie", 
                 title="Unpaired: Cooking Energy Sources")

# Paired
compare_paired(data=paired_clean,
               var_name="cooking_energy_sources",
               lgd_title="Types",
               plot_title="Paired: Cooking Energy Sources")
```

#### **TODO: Un-clean sources: Kerosene, Charcoal**

```{r}
```

#### Time

```{r}
##  How long does the cooking fuel collection process take on a daily basis?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="cooking_fuel_collection_time", 
                 var_type="non_cont",
                 subplot_type="bar_simple",
                 lgd_title="Time Intervals",
                 title="Unpaired: Cooking Fuel Collection Time")

# Paired
compare_paired(data=paired_clean,
               var_name="cooking_fuel_collection_time",
               lgd_title="Time Intervals",
               plot_title="Paired: Cooking Fuel Collection Time")
```

### Households - Academic Performance

```{r}
plot_func(df=post_clean, var_name="school_performance_change", 
          var_type="non_cont", lgd = "Change",
          plot_title="Household - Academic Performance", 
          plot_type="pie")
```

### Schools - Academic Performance

```{r}
plot_func(df=ci_clean, var_name="school_performance", 
          var_type="non_cont", lgd = "Change",
          plot_title="Schools - Academic Performance", 
          plot_type="pie")

```

### Commercial & Institution 

#### Operation Hours Change

```{r}
# Since connection to Renewvia minigrid, have your hours of operation changed at all?
plot_func(df=ci_clean, var_name="operations_hours_change", 
          var_type="non_cont", lgd="Change",
          plot_title="Change in C&I Business Hours", 
          plot_type="pie")
```

#### Additional Operation Hours

```{r}
plot_func(df=ci_clean, var_name="business_hours_increase", 
          var_type="non_cont", lgd="By how much?",
          plot_title="C&I Added Operation Hours", 
          plot_type="pie")
```

#### Change in Workforce

```{r}
# Since connection to Renewvia mingrid, have you had any change in number of workers/employees at your place of work?
plot_func(df=ci_clean, var_name="workforce_change", 
          var_type="non_cont", lgd="Change",
          plot_title="Change in C&I Workforce", 
          plot_type="pie", char_remove=NULL)
```

#### Adding New Products/Services

```{r}
# Have you added any new products or services since connection to Renewvia minigrid?
plot_func(df=ci_clean, var_name="ci_offering_change", 
          var_type="non_cont", lgd="Change",
          plot_title="Change in C&I Products/Services", 
          plot_type="pie", char_remove=NULL)
```

### TODO

-   Annotation & encoding of "light_primary_source"

-   For cooking energy sources, add the unclean sources: charcoal, firewood

## B) Inferential

### No. of Appliances\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
paired_testing(paired_enc, var_name = "appliances_count", 
               plot_diff = TRUE, 
               plot_title = "Difference Pre-Post in No. of Appliances",
               test_type="ttest", remove_outliers=TRUE)
```

### Light Hours\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value between 0 and 24

```{r}
## How many hours of light per day do you currently have at home?
paired_testing(paired_enc, var_name = "light_hours_current", 
               plot_diff = TRUE, plot_title = "Difference Pre-Post in Light Hours",
               test_type="ttest", remove_outliers=TRUE)
```

### Business Operation Hours

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
## Since connection to Renewvia mini-grid, have your hours of operation changed at all?
# Check for increase
community_reg(df=ci_enc, outliers = "feature",
              col_name="operations_hours_change", dep="1", var_type="categorical",
              title="Increase in Business Hours by Community")
```

### Schools - Academic Performance

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
## Have you seen a change in overall school performance?
community_reg(df=ci_enc, outliers = "feature",
              col_name="school_performance", dep="1", var_type="categorical",
              title="Schools - Increase in Academic Performace by Community")
```

```{r}
# Encoding
## Have you seen a change in overall school performance?
# community_reg(df=ci_enc, outliers = "feature",
#               col_name="school_performance", dep="-1", var_type="categorical",
#               title="Schools - Increase in Academic Performace by Community")
```

### TODO: Household - Academic Performance

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
# Encoding
community_reg(df=post_enc, outliers = "feature",
              col_name="school_performance_change",
              dep="1", var_type="categorical",
              title="Households - Increase in Academic Performace by Community")
```

### Commercial & Institution 

#### Operation Hours Change

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}

community_reg(df=ci_enc, outliers = "feature",
              col_name="operations_hours_change", 
              dep="1", var_type="categorical",
              title="Increase in C&I's Operation Hours by Community")
```

```{r}
# Consumption
```

#### Workforce Change

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, we have added workers" = 1, "Yes, we have lost workers" = -1, "No, the number has remained the same" = 0

```{r}
# Since connection to Renewvia mini-grid, have you had any change in number of workers/employees at your place of work?
community_reg(df=ci_enc, outliers = "feature",
              col_name="workforce_change", 
              dep="1", var_type="categorical",
              title="Increase in C&I's Workforce by Community")
```

#### Adding New Products/Services

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes" = 1, "No" = 0

```{r}
# Have you added any new products or services since connection to Renewvia minigrid?
community_reg(df=ci_enc, outliers = "feature",
              col_name="ci_offering_change", 
              dep="1", var_type="categorical",
              title="C&I's Newly Added Offerings by Community")
```

```{r}
consumption_reg(df = ci_enc, reg_type ="logistic",
                dep= "ci_offering_change", 
                exclude_outliers = TRUE, outliers = "feature",
                title="Energy Consumption vs. Newly Added Offerings")
```

# 3- Health

## A) Descriptive

### Water

#### All Sources

```{r}
## What is your source of water?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="water_source", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Sources",
                 title="Unpaired: Water Sources",
                 char_remove=NULL)

# Paired
compare_paired(data=paired_clean,
               var_name="water_source",
               lgd_title="Sources",
               plot_title="Paired: Water Sources")
```

#### Access to Clean Drinking Water

```{r}
# Do you have a source for clean drinking water?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="clean_drinking_water", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Do you have clean drinking water?",
                 title="Unpaired: Clean Drinking Water Access")

# Paired
compare_paired(data=paired_clean,
               var_name="clean_drinking_water",
               lgd_title="Do you have clean drinking water?",
               plot_title="Paired: Clean Drinking Water Access")
```

#### Clean Sources

```{r}
# What is the source for clean drinking water?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="clean_drinking_water_source", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Do you have clean drinking water?",
                 title="Unpaired: Clean Drinking Water Sources")

# Paired
compare_paired(data=paired_clean,
               var_name="clean_drinking_water_source",
               lgd_title="Do you have clean drinking water?",
               plot_title="Paired: Clean Drinking Water Sources")
```

### Kerosene Lamps

#### Count

```{r}
# How many kerosene lamps do you currently have in your household?
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="kerosene_lamps_count", var_type="non_cont",
                 subplot_type="bar_discrete", 
                 title="Unpaired: No. of Kerosene Lamps",
                 char_remove=c(24))
```

#### Usage Change

```{r}
# Has the number of kerosene lamps in your household changed since connection to minigrid?
plot_func(df=post_clean, var_name="kerosene_lamp_usage_change", lgd ="Change", 
          var_type="non_cont", plot_title="Kerosene Lamps Usage", 
          plot_type="pie")
```

### Healthcare

```{r}
# # Does your Health Center have access to electricity?
compare_pre_post(var_name="clinic_electricity_access", var_type="non_cont",
                 subplot_type="pie", title="Clinic Access To Electricity", 
                 char_remove=NULL)
```

```{r}
# How close is the nearest Health Center / Clinic
compare_pre_post(var_name="clinic_travel_distance", var_type="non_cont",
                 subplot_type="bar", title="Clinic Access - Travel Distance", 
                 char_remove=NULL)
```

```{r}
# Does your Health Center / Clinic have access to refrigeration?
compare_pre_post(var_name="clinic_refrigeration_access", var_type="non_cont",
                 subplot_type="pie", title="Clinic Access to Refrigeration")
```

### TODO: New Columns for each type

```{r}
# What services are you able to offer/sell/provide due to connection to Renewvia minigrid that you werent able to offer prior to connection?
```

```{r}
# What is the Clinic / Hospital able to offer or provide due to connection to Renewvia minigrid that it wasnt able to offer before?
```

## B) Inferential

### Access to clean drinking water

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you have a source for clean drinking water? ## McNemar's  Test
paired_testing(paired_enc, var_name="clean_drinking_water", 
               test_type = "mcnemar", plot_diff=FALSE)
```

### Clean drinking water access - change

**Data Source**: C&I Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Since connection to Renewvia mini-grid, has your access to clean drinking water changed at all?
community_reg(df=post_enc, 
              col_name="clean_drinking_water_source", 
              dep="1", var_type="categorical",
              title="Increase in Access to Clean Drinking Water by Community")
```

### Kerosene Lamps Count\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## How many kerosene lamps do you currently use in your household? 
paired_testing(paired_enc, var_name="kerosene_lamps_count", 
               test_type = "ttest", plot_diff=TRUE)
```

```{r}
community_reg(df=paired_enc, calc_diff = TRUE,
              col_name="kerosene_lamps_count", dep="V1", 
              title="Difference in No. of Kerosene Lamps by Community", 
              var_type="ratio")
```

```{r}
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "kerosene_lamps_count", calc_diff=TRUE,
                title="Energy Consumption vs. Difference in No. of Kerosene Lamps")
```

### Kerosene Lamps Usage

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
community_reg(df=post_enc, 
              col_name="kerosene_lamp_usage_change", dep="-1", 
              var_type="categorical",
              title="Decrease in Lamps Water by Community")
```

### New Health Services

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="non_cont", plot_title="Change in Health Services Offered by Clinics", 
          plot_type="bar_discrete", char_remove=NULL)
```

```{r}
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="non_cont", 
          plot_title="Change in Health Services Offered by Clinics", 
          plot_type="pie", char_remove=c(0))
```

```{r}
## For clinics or health services only: Since connection to Renewvia mini-grid, have your health service offerings changed in any of the following ways: (select all that apply).
community_reg(df=ci_enc, 
              col_name="health_offering_change_count", dep="V1", 
              title="New Health Services Offered by Community", 
              var_type="ratio")
```

```{r}
sub <- ci_enc %>% filter(health_offering_change_count != 0)
consumption_reg(df = sub, reg_type ="linear", 
                dep= "health_offering_change_count", calc_diff=FALSE,
                title="Energy Consumption vs. New Health Services Offered")
```

### Clinic Access To Electricity

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
generic_compare(data=paired_clean, var_type="non_cont",
               var1="clinic_electricity_access_pre", 
               var2="clinic_electricity_access_post", 
               var1_title="Pre - Electricity Access", var2_title="Post - Minigrid Access", 
               subplot_type="pie", plot_title="Clinic Access To Electricity")
```

```{r}
paired_testing(paired_enc, var_name="clinic_electricity_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="clinic_electricity_access", dep="1", 
              title="Clinic Access To Electricity", 
              var_type="categorical", calc_diff = TRUE)
```

### Clinic Access To Refrigeration

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
generic_compare(data=paired_clean, var_type="non_cont",
               var1="clinic_refrigeration_access_pre", 
               var2="clinic_refrigeration_access_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", plot_title="Paired - Clinic Access to Refrigeration")
```

```{r}
## Does your Health Center / Clinic have access to refrigeration?
## McNemar's  Test
paired_testing(paired_enc, var_name="clinic_refrigeration_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="clinic_refrigeration_access", dep="1", 
              title="Clinic Access To Refrigeration", 
              var_type="categorical", calc_diff = TRUE)
```

### Better access to healthcare

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you feel that you have better access to health services because of connection to mini-grid?
plot_func(df=post_clean, var_name="better_access_health_minigrid", 
          var_type="non_cont", plot_title="Households - Better Access to Healthcare", 
          plot_type="pie")
```

```{r}
community_reg(df=post_enc, 
              col_name="better_access_health_minigrid", dep="1", var_type="categorical",
              title="Scatterplots For Better Healthcare Access by Community") 
```

```{r}
consumption_reg(df = post_enc, reg_type ="logistic",
                dep= "better_access_health_minigrid", 
                title="Energy Consumption vs. Better Healthcare Access")
```

# 4- Safety

## A) Descriptive

### Feeling Safe

```{r}
# How safe do you feel outside your home when it is dark?
generic_compare(data=paired_enc, var_type="non_cont",
               var1="feel_safe_dark_pre", 
               var2="feel_safe_dark_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar_discrete", plot_title="Feeling Safe When Dark")
```

### Reasons for Feeling Unsafe

```{r}
# What makes you feel the most unsafe?
compare_pre_post(var_name="feel_unsafe_reasons", var_type="non_cont",
                 subplot_type="bar", title="Reasons for Feeling unsafe")
```

### Presence of Community Lights

```{r}
# Does your community currently have outdoor community lights?
compare_pre_post(var_name="community_lights", var_type="non_cont",
                 subplot_type="pie", title="Presence of Community Lights")
```

### Household - Exterior Lights

```{r}
# Does your home have exterior lighting?
plot_func(df=post_clean, var_name="home_exterior_lights", 
          var_type="non_cont", plot_title="Households - Exterior Lights", 
          plot_type="pie")
```

```{r}
# Is this exterior lighting powered by minigrid?
generic_compare(data=post_clean, var_type="non_cont",
              var1="exterior_lights_minigrid", 
               var2="home_exterior_lights", 
               var1_title="Powered by Minigrid?", var2_title="Home With Exterior Light?", 
               subplot_type="pie", plot_title="Households - Exterior Lights")
```

## B) Inferential

### Feeling Safe

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Very unsafe" = 1; "Somewhat unsafe" = 2; "Neither safe nor unsafe"= 3; "Somewhat safe" = 4; "Very safe" = 5

```{r}
# # How safe do you feel outside your home when it is dark?
paired_testing(paired_enc, var_name="feel_safe_dark", 
               test_type = "wilcoxon", plot_diff=TRUE)
```

### Reasons for Feeling Unsafe - Potential Theft

```{r}
# What makes you feel the most unsafe? Testing for Potentiel Theft only
community_reg(df=paired_enc, 
              col_name="unsafe_due_to_theft", dep="-1", 
              title="Unsafe Due to Theft", 
              var_type="categorical", calc_diff = TRUE)
```

### TODO: Presence of Community Lights

```{r}
# Does your community currently have outdoor community lights?
paired_testing(paired_enc, var_name="community_lights", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="community_lights", dep="1", 
              title="Community Lights", 
              var_type="categorical", calc_diff = TRUE)
```

# 5- Economic Activity

## A) Descriptive

### Pre-connection: Employment Type

```{r}
# Type of employment for Primary Provider
plot_func(df=initial_pre, var_name="employement_type", 
          var_type="non_cont", plot_title="Employement Type of Primary Provider", 
          plot_type="pie")
```

### Occupation Change

```{r}
# Has your (or your spouses) occupation changed since youve been connected to minigrid power?
plot_func(df=post_clean, var_name="occupation_change", 
          var_type="non_cont", plot_title="Change in Occupation of Primary Provider", 
          plot_type="pie")
```

### Household Income

```{r}
# What is your average monthly household income:
# compare_pre_post(var_name="avg_household_income", var_type="cont",
#                  subplot_type="hist", char_remove = 0, exclude_outliers = TRUE,
#                  title="Average Household Income", shared_legend=FALSE)
plot_func(df=initial_pre, var_name="avg_household_income", 
          var_type="cont", plot_title="Pre-Connection - Average Household Income", 
          plot_type="hist", char_remove = 0, remove_outliers = TRUE)
plot_func(df=post_clean, var_name="avg_household_income", 
          var_type="cont", plot_title="Post-Connection - Average Household Income", 
          plot_type="hist", char_remove = 0, remove_outliers = TRUE)
```

```{r}
# Has your household income changed since your connection to minigrid power?
plot_func(df=post_clean, var_name="household_income_change", 
          var_type="non_cont", plot_title="Change in Household Income", 
          plot_type="pie")
```

### TODO: Costs - Additional Cleaning

#### Phone Charging

```{r}
# How much do you pay per month to charge your mobile phone?
compare_pre_post(var_name="phone_charge_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Phone Charging Cost", shared_legend=TRUE)
```

#### Appliances Charging

```{r}
# What is approximate monthly cost of energy used strictly for charging appliances?
compare_pre_post(var_name="applicances_charging_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Appliances Charging Cost", shared_legend=TRUE)
```

#### Cooking Energy

```{r}
# What is the approximate monthly cost of energy used strictly for cooking?
compare_pre_post(var_name="cooking_energy_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Cooking Energy Cost", shared_legend=TRUE)
```

#### Kerosene Lamps

```{r}
# How much do you pay monthly for kerosene used only in kerosene lamps?
compare_pre_post(var_name="kerosene_lamps_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Kerosene Lamps Cost", shared_legend=TRUE)
```

### TODO: Local Business Creation

```{r}
# Are any household members business owners?
# Is this business recent (started after connection to minigrid power?)
# If this business is new, do you consider this new business a result of having access to minigrid power?
```

### C&I

#### Operation Status

```{r}
# Is this business, clinic, school still in operation?
plot_func(df=ci_clean, var_name="operation_status", 
          var_type="non_cont", lgd = "Status",
          plot_title="C&I - Type", 
          plot_type="pie")
```

#### Busines Type

```{r}
# Please select your business type
plot_func(df=ci_clean, var_name="business_type", 
          var_type="non_cont", lgd = "Business Type",
          plot_title="C&I - Type", 
          plot_type="pie")
```

### C&I - New Products/Services

```{r}

```

## B) Inferential

### Avg. Household Income\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## What is your average monthly household income?
nigeria_df <- paired_clean %>% filter(country_post == "nigeria")
paired_testing(nigeria_df, var_name="avg_household_income", 
               test_type = "ttest", plot_diff=TRUE)
```

```{r}
kenya_df <- paired_clean %>% filter(country_post == "kenya")
paired_testing(kenya_df, var_name="avg_household_income", 
               test_type = "ttest", plot_diff=TRUE)
```

#### TODO: Needs further Investigation on negative differences

### Household - Income Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Has your household income changed since your connection to mini-grid power?
community_reg(df=post_enc, 
              col_name="household_income_change", dep="1", 
              title="Household Income Increase by Community", 
              var_type="categorical", calc_diff = FALSE)
```

### C&I - Earnings Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
# For businesses or shop owners only: Since connection to Renewvia mini-grid, have you seen any change in your weekly or monthly earnings?
community_reg(df=ci_enc, 
              col_name="earnings_change", dep="1", 
              title="C&I Earnings Increase by Community", 
              var_type="categorical", calc_diff = FALSE)
```

```{r}
# To fix, exclude outliers
df_pos <- ci_enc %>% filter(earnings_change != -1)
consumption_reg(df = df_pos, reg_type ="logistic",
                dep= "earnings_change",  
                exclude_outliers = TRUE,
                outliers = "feature",
                title="Energy Consumption vs. C&I Earnings Increase")
```

### Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

```{r}
# Are any household members business owners?
## McNemar's Test
paired_testing(paired_enc, var_name="business_owners_binary", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, outliers = "feature",
              col_name="business_owners_binary", dep="1", 
              title="Household Business Onwership by Community", 
              var_type="categorical", calc_diff =TRUE)
```

### TODO: Regression with energy consumption in both directions (1, -1)
