---
title: "Renewvia - Survey Impact Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# Overview

## Descriptive

-   Generating summary statistics

-   Plotting graphs/charts

## **Inferential**

-   For the paired data set, we will use the following

    -   Paired t-Test for ratio

    -   Wilcoxon Signed Rank Test (Sign Test if asymmetric) for ordinal variables

    -   McNemar's Test for binary responses

-   Our independent variables will be the following: PV Size (kWh), No. of Customers, CAPEX (USD) and Consumption (Community & Customer).

-   For each dependent variables, we will run a uni-variate regression tests with each of independent variable. When applicable, we will have a Linear regression t-Test or Logistic regression Wald test

# Libraries

```{r}
# Importing libraries
options(warn=-1)
library(ggplot2)
library(dplyr)
library(lessR)
library(tidyr)
library(ggpubr)
library(exact2x2)
library(stringr)
library(epiDisplay)
library(tibble)
library(ggExtra)
library(vtree)
library(CGPfunctions)
library(psych)
library(nonpar)
library(scales)
library(tidyverse)
library(ggrepel)
library(data.table)
library(forcats)
library(glue)
library(aod)
```

# Input Data

## Community

```{r}
## Locading the project& consumption data
consumption <- read.csv("customer_consumption.csv")
customer_info <- read.csv("customers_info.csv")

temp <- merge(consumption, customer_info, 
              by.x = 'Account.Number',
              by.y = 'customerAccountNumber')  
temp_group <- temp %>% 
                    group_by(projectName) %>% 
                    summarise(consumption = sum(Energy.Consumption, na.rm=TRUE))
projects <- read.csv("project_data.csv")
projects <- merge(projects, temp_group, by.x="project_name", by.y="projectName")
```

## Surveys - Clean

```{r}
## Locading the cleaned data sets
# Intial Survey
initial <- read.csv("data_cleaning/datasets_clean/initial_clean.csv",
                          na.strings=c("","NA"))
initial_clean <- merge(initial, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre <- initial_clean %>%
                    filter(status == "pre_connection") 

# Post-connection
initial_post <- initial_clean %>%
                    filter(status == "post_connection") 

# Household Post-Survey
post <- read.csv("data_cleaning/datasets_clean/post_clean.csv",
                          na.strings=c("","NA"))
post_clean <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')%>% 
                    filter(tariff == "Residential")

## Pairing pre and post responses
paired_clean <- merge(initial_pre, post_clean,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')

# Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_clean/ci_post_clean.csv",
                          na.strings=c("","NA"))
ci_clean <- merge(ci, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
# head(ci_clean)
```

## Surveys - Encoded

```{r}
## Locading the encoded data sets
# Intial Survey
initial_enc <- read.csv("data_cleaning/datasets_encoded/initial_encoded.csv",
                          na.strings=c("","NA")) 
initial_enc <- merge(initial_enc, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre_enc <- initial_enc %>%
                    filter(status == 1)
# Pre-connection
initial_post_enc <- initial_enc %>%
                    filter(status == 2)

# Household Post-Survey
post <- read.csv("data_cleaning/datasets_encoded/post_encoded.csv",
                          na.strings=c("","NA"))
post_enc <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')  %>% 
                    filter(tariff == "Residential")

# Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_encoded/ci_post_encoded.csv",
                          na.strings=c("","NA")) 
ci_enc <- merge(ci, temp,
                 by.x = 'renewvia_id', 
                 by.y = 'Account.Number')

paired_enc <- merge(initial_pre_enc, post_enc,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
```

# Utility Functions

## Descriptive

```{r}
get_stats <- function(data, ct, var_name,data_source,
                      remove_outliers = FALSE, 
                      exclude_zeros = FALSE) {
  if (grepl("_pre", var_name, fixed = TRUE)){
    country_data <- data %>% filter(country_pre == ct)
  } else if (grepl("_post", var_name, fixed = TRUE)){
    country_data <- data %>% filter(country_post == ct)
  } else {country_data <- data %>% filter(country == ct)}
    
  if (remove_outliers == TRUE) {
    print("Excluding outliers")
    quartiles <- quantile(country_data[, var_name], 
                        probs=c(.25, .75), na.rm = TRUE)
  
    IQR <- IQR(country_data[, var_name], na.rm = TRUE)
    
    Lower <- quartiles[1] - 1.5*IQR
    Upper <- quartiles[2] + 1.5*IQR 
    
    country_data <- subset(country_data, 
                              country_data[, var_name] > Lower &
                              country_data[, var_name] < Upper)
  } 
  
  var <- country_data[, var_name]
  
  if (exclude_zeros == TRUE) {
    print("Removing Zeros")
    var <- var[var != 0]
  } 
  
  stats <- t(describe(var, IQR=TRUE, quant=c(.1,.25,.5,.75,.90),))
  print(t.test(var, conf.level = 0.95))
  print(stats)
}
```

## Data Visualization

```{r}
remove_y <- theme(
  # axis.text.x = element_blank(),
  # axis.ticks.x = element_blank(),
  # axis.title.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks.y = element_blank(),
  axis.title.y = element_blank()
)
```

### Plot graphs with ggplot

```{r}
# For pie and bar charts
plot_func <- function(df, var_name, var_type, 
                      plot_title, plot_type, char_remove=NULL,
                      remove_outliers = FALSE) {
  if(is.null(char_remove) == FALSE) {
    df <- df %>% filter(.data[[var_name]] != char_remove)
  }
  
  if(remove_outliers == TRUE) {
      print("Removing outliers")
      quartiles <- quantile(df[, var_name], 
                        probs=c(.25, .75), na.rm = TRUE)
  
      IQR <- IQR(df[, var_name], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      df <- subset(df, 
                     df[, var_name] > Lower &
                     df[, var_name]< Upper)
    }
  if(var_type == "non_cont") {
      var <- df[, var_name]
      var <- var[var != ""]
      
      data <- as.data.frame(t(table(var)))[,2:3] 
      setnames(data, 
               old = c('var','Freq'), 
               new = c('labels','counts'))
    

      
      if (plot_type == 'pie') {
          data_tab <- data %>% mutate(csum = rev(cumsum(rev(counts))),
                                 pos = counts/2 + lead(csum, 1),
                                 pos = if_else(is.na(pos), counts/2, pos),
                                 percentage = counts/sum(counts))
          data_tab$labels <- as.factor(data_tab$labels)
          plot <- data_tab %>% ggplot(aes(x = "", y = counts, fill = labels)) +
                              geom_col(width = 1, color = 1) +
                              geom_label_repel(
                                aes(y = pos,
                                    label = glue("{counts} ({percent(percentage)})"),
                                     fill = labels),
                                    show.legend = FALSE) +
                              labs(fill = var_name, title=plot_title) +
                              coord_polar(theta = "y") +
                              theme_void() + 
                              theme(legend.text=element_text(size=6))
      } else if (plot_type == "bar") {
          plot <- data %>% ggplot(aes(y=counts, 
                                      x=reorder(labels, counts), 
                                      fill=labels)) + 
                            geom_col(width = 0.7) +
                            geom_text(aes(label=counts), vjust=-0.3, size=3)+
                            labs(fill = var_name, title=plot_title) + 
                            coord_flip() + 
                            theme(legend.text=element_text(size=6))
      } else if (plot_type == "bar_discrete") {
          plot <- data %>% ggplot(aes(y=counts, x=labels)) + 
                            geom_col(width = 0.7) +
                            labs(title=plot_title, x = var_name) 
      } 
  }else if(var_type == "cont") {
      if(plot_type == "hist") {
        plot <- ggplot(df, aes(x=.data[[var_name]])) + 
                      geom_histogram(stat = "count",
                                     fill = 'yellow',
                                     alpha = 0.7,
                                     col = 'black', bins=10) + 
                      geom_vline(xintercept = mean(df[,var_name], na.rm=TRUE),
                                 col="lightblue", lty=1, lwd = 1) +
                      geom_vline(xintercept = median(df[,var_name], na.rm=TRUE),
                               col="purple", lty=2, lwd = 1) +
                      theme_bw() +
                      labs(title=plot_title) 
      }else if(plot_type == "boxplot") {
        plot <- ggplot(df, aes(x=.data[[var_name]])) + 
                geom_boxplot(outlier.colour="red",
                              outlier.size=4)+
                labs(title=plot_title) +
                theme_void()
    }
  }
  return(plot)
}
```

### Pre-Post Comparison

```{r}
compare_pre_post <- function(var_name, var_type, subplot_type, title, 
                             exclude_outliers = FALSE,
                             char_remove=NULL, shared_legend=TRUE) {

  pre_plot <- plot_func(initial_pre, var_name, var_type,
                         "Initial", subplot_type, 
                        char_remove, remove_outliers=exclude_outliers)
  post_plot <- plot_func(post_clean, var_name, var_type,
                          "Post", subplot_type, 
                         char_remove, remove_outliers=exclude_outliers)
  if (subplot_type == "bar") {
        plot <- ggarrange(post_plot + remove_y, pre_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = shared_legend,legend="bottom")
  } else {
        plot <- ggarrange(post_plot, pre_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = shared_legend,
                        legend="right")
  }
      
  return(annotate_figure(plot, 
                         top = text_grob(title, color = "black", 
                                         face = "bold", size = 12)))

}
```

### Comparison in same data

```{r}
compare_in_df <- function(data, var1, var2, 
                            var1_title, var2_title, 
                            subplot_type, plot_title,
                          var_type,
                          char_remove=NULL){
  var1_plot <- plot_func(data, var1, var_type,
                          var1_title, subplot_type, char_remove)
  var2_plot <- plot_func(data, var2, var_type,
                          var2_title, subplot_type, char_remove)
  if (subplot_type == "bar") {
        plot <- ggarrange(var2_plot + remove_y, var1_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = TRUE,legend="bottom")
  } else {
        plot <- ggarrange(var2_plot, var1_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = TRUE,
                        legend="right")
  }
      
  return(annotate_figure(plot, top = text_grob(plot_title, 
                 color = "black", face = "bold", size = 12)))
}
```

## Hypothesis Testing

```{r}
# Running the paired t-test
paired_testing <- function(data, var_name, test_type, 
                           plot_diff=FALSE, plot_title=NULL, remove_outliers=FALSE) {
  pre_name <- paste(var_name, "pre", sep="_")
  post_name <- paste(var_name, "post", sep="_")
  
  sprintf("Removing outliers for both %s and %s", pre_name, post_name)
  vars <- c(pre_name, post_name) 
  if(remove_outliers==TRUE) {
    for(var in vars){
      quartiles <- quantile(data[, var], 
                        probs=c(.25, .75), na.rm = TRUE)
  
      IQR <- IQR(data[, var], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      data <- subset(data, 
                     data[, var] > Lower &
                     data[, var] < Upper)
    } 
  }
  var_pre <- data[, pre_name]
  var_post <- data[, post_name]
  diff <- var_post - var_pre
  # Running the test
  if(test_type == "wilcoxon"){
    #Wilcoxon Signed-Rank Test
    test <- wilcox.test(var_pre, var_post, paired=TRUE)
  }else if(test_type == "sign") {
    #Sign Test
    test <- signtest(diff, m=0, conf.level=0.95, exact=FALSE)
  } else if (test_type == "ttest") {
    #Paired t-Test
    test <- t.test(var_pre, var_post,
         paired = TRUE, alternative = "two.sided")
  } else if(test_type == "mcnemar") {
    cross_tab <- table(var_pre, var_post)
    print(cross_tab)
    test <- mcnemar.test(cross_tab)
  }
  
  # Visualize distribution of score differences
  if(plot_diff == TRUE) {
      hist(diff, main=plot_title)
  }
  return(test)
}
```

## Regression Testing

### Plotting Scatter-plots

```{r}
plot_reg <- function(data, feature, dependent, 
                     remove_outliers=TRUE, reg_type, 
                     vals_remove=NULL) {
  
  if(is.null(vals_remove) == FALSE) {
    data <- data[!grepl(vals_remove,data$dependent),]
  }
  if(remove_outliers == TRUE) {
    vars <- c(feature, dependent) 
    for(var in vars){
      quartiles <- quantile(data[, var], 
                        probs=c(.25, .75), na.rm = TRUE)
  
      IQR <- IQR(data[, var], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      data <- subset(data, 
                     data[, var] > Lower &
                     data[, var] < Upper)
    }
    
  }
  if(reg_type == "linear") {
    plot <- ggplot(data,
                aes(x=.data[[feature]], y=.data[[dependent]])) +
                geom_point(color='blue') +
                  geom_smooth(color='red', method = "lm", se = FALSE) +
                theme_classic()
  } else if(reg_type == "logistic") {
     plot <- ggplot(data, 
                    aes(x=.data[[feature]], y=.data[[dependent]])) + 
              geom_point(color='blue', alpha=.5) +
              stat_smooth(method="glm", color="red", se=FALSE, 
                        method.args = list(family=binomial)) +
                theme_classic()
  }
 
  return(plot)
}
```

### Community Ind. Variables

```{r}
ind_vars <- c("pv_size_kwh", "customer_count", "capex_usd", "consumption")

community_reg <- function(df, col_name, dep, title, 
                          var_type, calc_diff=FALSE, to_remove=NULL) {
  if (calc_diff == TRUE) {
      pre_name <- paste(col_name, "pre", sep="_")
      post_name <- paste(col_name, "post", sep="_")
      df$col_reg <- df[, post_name] - df[, pre_name]
      names(df)[names(df) == "community_post"] <- "community"
  } else {
      df$col_reg <- df[, col_name]
  }
  
  if(var_type == "categorical") {
    data <- rownames_to_column(as.data.frame.matrix(
                                  prop.table(table(
                                      df[, "community"], 
                                      df[, "col_reg"]),
                                     margin = 1)
                                              )
                                  , var = "community")
  } else if(var_type == "ratio") {
    data <- as.data.frame(rowsum(df[, "col_reg"], 
                                 df[, "community"], na.rm = TRUE))
    data$community <- rownames(data)
    print(data)
    
    
  }
  community_data <- merge(x=projects, y=data, by="community")
  lst <- list()
  
   for(ind in ind_vars) {
        print(ind)
          p <- plot_reg(data=community_data, feature=ind,  
                        dependent=dep, reg_type="linear", vals_remove=to_remove)
          lst <- append(lst, list(p))
          lm <- lm(community_data[,dep] ~ community_data[,ind])
          details <- summary(lm)
          result <- as.data.frame(details$coefficients, row.names = c("Intercept", ind))
          print(details)
          print(confint(lm, level=0.95))
      }
  plot <- ggarrange(plotlist = lst, 
                    ncol = 2, nrow = 2, 
                    common.legend = TRUE,
                    legend="right")
  annotate_figure(plot, top = text_grob(title, 
                 color = "black", face = "bold", size = 12))
}

```

### Customer Consumption

```{r}
consumption_reg <- function(df, dep, title, reg_type, 
                            calc_diff=FALSE, exclude_outliers = FALSE, 
                            to_remove=NULL) {

  if(reg_type == "linear") {
    if (calc_diff == TRUE) {
      pre_name <- paste(dep, "pre", sep="_")
      post_name <- paste(dep, "post", sep="_")
      df$col_reg <- df[, post_name] - df[, pre_name]
    } else {
      df$col_reg <- df[, dep]
    }
    
    model <- lm(df$col_reg ~ df$Energy.Consumption)
    p <- plot_reg(data=df, feature="Energy.Consumption",  
                  dependent="col_reg", reg_type="linear", 
                  remove_outliers=exclude_outliers, 
                  vals_remove=to_remove)
    
  } else if(reg_type == "logistic") {
    model <- glm(df[,dep] ~ df$Energy.Consumption, 
               family=binomial)
    p <- plot_reg(data=df, feature="Energy.Consumption",  
                  dependent=dep, reg_type="logistic", 
                  remove_outliers=exclude_outliers,
                  vals_remove=to_remove)
    test <- wald.test(Sigma = vcov(model), 
                      b = coef(model), Terms = 1)
    print(test)
  }
  
  print(summary(model))
  print(confint(model, level=0.95))
  
  return(p)
  
}
```

# 1- Gender Equality

## A) Descriptive

### Demographics

```{r}
# What was the gender breakdown of survey respondents, pre and post?
compare_pre_post(var_name="gender", var_type="non_cont",
        subplot_type="pie", title="Gender Breakdown")
```

### School Enrollment

```{r}
# What was school enrollment by gender pre-connection?
girls <- sum(initial_pre$girls_headcount,na.rm = TRUE)
girls_in_school <- sum(initial_pre$girls_schooling,na.rm = TRUE)
enrollment_rate <- percent(girls_in_school/girls, accuracy = 0.01)

vals <- c(girls, girls_in_school, enrollment_rate)

# creating matrix
tab <- as.data.frame(t(as.matrix(vals)))
setnames(tab, old = c('V1','V2', 'V3'), 
          new = c("Girls", "Girls.In.School", "Enrollment.Rate"))
tab
```

```{r}
# Was there a change in enrollment by gender afterwards?
compare_in_df(data=post_clean, var_type="non_cont",
               var1="girls_schooling_change", 
               var2="boys_schooling_change", 
               var1_title="Girls", var2_title="Boys", 
               subplot_type="pie", plot_title="School Enrollment Change")
```

### TODO:: Bar charts by groups, Chi-Square goodness of fit, proportions not counts

```{r}
# Dirving factor for non-enrollment in school for boys and girls
# For Girls
compare_pre_post(var_name="girls_unschooled_reasons", var_type="non_cont", 
        subplot_type="bar", title="Girls Schooling: Reasons for non-enrollment",
        char_remove=c("they_all_attend_school", ""))
```

```{r}
# For Boys
compare_pre_post(var_name="boys_unschooled_reasons",  var_type="non_cont",
        subplot_type="bar", title="Boys Schooling: Reasons for non-enrollment",
        char_remove=c("they_all_attend_school", ""))
```

### Household Chores

```{r}
# What is the average age of the person in charge of water collection?
compare_pre_post(var_name="avg_person_age_water_collection", var_type="non_cont",
        subplot_type="bar", title="Age of Person Responsible for Cooking Fuel Collection") 
```

```{r}
# How many houses - subgroup with schol-age children getting water changes answers to 18_or_older? Binarize, school-aged (5-18) vs 18_and_older? Drop pairing, Side-by-side bars
compare_in_df(data=paired_clean, var_type="non_cont", 
               var1="avg_person_age_water_collection_pre", 
               var2="avg_person_age_water_collection_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar", plot_title="Avg. Age")
```

### TODO: Female Businesses Ownership - Subgroup by country, community

```{r}
# How many new women-led businesses were created?
compare_pre_post(var_name="business_owners_female", var_type="non_cont", 
        subplot_type="pie", title="Women Business Owners")
```

```{r}
compare_in_df(data=paired_clean, var_type="non_cont", 
               var1="business_owners_female_pre", 
               var2="business_owners_female_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar", plot_title="Paired Female Business Owners")
```

```{r}
compare_in_df(data=paired_clean, var_type="non_cont", 
               var1="business_owners_binary_pre", 
               var2="business_owners_binary_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar", plot_title="Paired Business Owners")
```

### TODO: Binarize by gender

```{r}
# In respondent's own words, how were women affected from the mini-grid?

## Requires additional cleaning/annotations
# Who is mainly responsible for cooking fuel collection on a daily basis? Select all that apply
# Binarize by gender, (1) adult
# adult_male; child_female; whole_family
```

## B) Inferential

### School Enrollment Change

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

#### TODO: Work with counts instead proportions, Linear Regression - Increase

```{r}
# Check for increase
community_reg(df=post_enc, 
              col_name="girls_schooling_change", dep="1", var_type="categorical",
              title="Scatterplots For Increase in School Change by Community")
```

#### Linear Regression - Decrease

```{r}
# Check for decrease
community_reg(df=post_enc, 
              col_name="girls_schooling_change", dep="-1", var_type="categorical",
              title="Scatterplots For Increase in School Change by Community")
```

### Water Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "less than 1 hour" = 1; "1-2 hours" = 2; "2-3 hours" = 3; "3-4 hours" = 4; "greater than 4 hours" = 5

#### TODO: Pre-Post Comparison, Visualize the paired differences

```{r}
compare_in_df(data=paired_clean, var_type="non_cont", 
               var1="water_collection_time_pre", 
               var2="water_collection_time_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar", plot_title="Water Collection Time")
```

#### Wilcoxon

```{r}
# How long does the water collection process take on a daily basis?
paired_testing(paired_enc, var_name="water_collection_time", 
               test_type = "wilcoxon", plot_diff=TRUE, 
               plot_title="Difference Pre-Post of Water Collection Times")
```

### Cooking Fuel Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "No need to collect fuel" = 1; "less than 1 hour" = 2; "1-2 hours" =3; "3-5 hours" = 4; "greater than 4 hours" = 5

#### Pre-Post Comparison

```{r}
compare_in_df(data=paired_clean, var_type="non_cont",
               var1="cooking_fuel_collection_time_pre", 
               var2="cooking_fuel_collection_time_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar", plot_title="Cooking Fuel Collection Time")
```

#### Wilcoxon Signed-Rank Test

```{r}
# How long does the cooking fuel collection process take on a daily basis?
paired_testing(paired_enc, var_name="cooking_fuel_collection_time", 
               test_type = "wilcoxon", plot_diff=TRUE, 
               plot_title="Difference Pre-Post of Water Collection Times")
```

### Women-led Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Everything else = 0; "adult_female" = 1

```{r}
# Are any household members business owners? Isolate for those with 'adult_'female
paired_testing(paired_enc, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

### New Female workers

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
# If you answered yes to adding new workers, how many new employees are female?
# Check for increase
community_reg(df=ci_enc, 
              col_name="workforce_change_female", dep="V1", 
              title="New Female Workers Change by Community", 
              var_type="ratio")
```

# 2- Productivity

## A) Descriptive

### Power Source

```{r}
# What is your primary power source?
compare_pre_post(var_name="power_sources_primary", var_type="non_cont",
                 subplot_type="bar", title="Power Source",
                 char_remove=NULL)
```

### Light Hours

```{r}
compare_pre_post(var_name="light_hours_current", var_type="non_cont",
                 subplot_type="bar_discrete", title="Light Hours",
                 char_remove=c(46))
```

### No. of Appliances

```{r}
# How many electronic devices or appliances do you currently use in the household
compare_pre_post(var_name="appliances_count", var_type="non_cont",
                 subplot_type="bar_discrete", title="Appliances",
                 char_remove=NULL)
```

```{r}
# Has the number of electronic devices or appliances increased since connection to minigrid?
plot_func(df=post_clean, var_name="appliances_count_change", 
          var_type="non_cont", plot_title="Change in No. of Appliances", 
          plot_type="pie", char_remove=NULL)
```

### Phone Charge - Travel Distance

```{r}
# How far must you travel to charge your mobile phone?
compare_pre_post(var_name="phone_charge_travel_distance", var_type="non_cont",
                 subplot_type="bar", title="Travel Distance to Charge Phone",
                 char_remove=NULL)
```

### Water Collection - Travel Distance

```{r}
# How far must you travel to obtain your water supply?
compare_pre_post(var_name="water_collection_travel_distance", var_type="non_cont",
                 subplot_type="bar", title="Travel Distance for Water Collection",
                 char_remove=NULL)
```

### Water Collection Time

```{r}
compare_pre_post(var_name="water_collection_time", var_type="non_cont",
                 subplot_type="pie", title="Water Collection Time",
                 char_remove=NULL)
```

### C&I - Profile

```{r}
# Is this business, clinic, school still in operation?
plot_func(df=ci_clean, var_name="operation_status", 
          var_type="non_cont", plot_title="C&I - Type", 
          plot_type="pie", char_remove=NULL)
```

```{r}
# Please select your business type
plot_func(df=ci_clean, var_name="business_type", 
          var_type="non_cont", plot_title="C&I - Type", 
          plot_type="bar", char_remove=NULL)
```

### C&I - Operation Hours

```{r}
# Since connection to Renewvia minigrid, have your hours of operation changed at all?
plot_func(df=ci_clean, var_name="operations_hours_change", 
          var_type="non_cont", plot_title="Change in C&I Operation Hours", 
          plot_type="pie", char_remove=NULL)
```

### C&I - Workforce

```{r}
# Since connection to Renewvia mingrid, have you had any change in number of workers/employees at your place of work?
plot_func(df=ci_clean, var_name="workforce_change", 
          var_type="non_cont", plot_title="Change in C&I Workforce", 
          plot_type="pie", char_remove=NULL)
```

### C&I - New Products/Services

```{r}
# Have you added any new products or services since connection to Renewvia minigrid?
plot_func(df=ci_clean, var_name="ci_offering_change", 
          var_type="non_cont", plot_title="Change in C&I Products/Services", 
          plot_type="pie", char_remove=NULL)
```

## B) Inferential

### No. of Appliances\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
paired_testing(paired_enc, var_name = "appliances_count", 
               plot_diff = TRUE, plot_title = "Difference Pre-Post in No. of Appliances",
               test_type="ttest", remove_outliers=TRUE)
```

```{r}
community_reg(df=paired_enc, calc_diff = TRUE,
              col_name="appliances_count", dep="V1", 
              title="Difference in No. of Appliances by Community", 
              var_type="ratio")
```

```{r}
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "appliances_count", calc_diff=TRUE,
                title="Energy Consumption vs. Difference in No. of Appliances")
```

### Light Hours\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value between 0 and 24

```{r}
## How many hours of light per day do you currently have at home?
paired_testing(paired_enc, var_name = "light_hours_current", 
               plot_diff = TRUE, plot_title = "Difference Pre-Post in Light Hours",
               test_type="ttest", remove_outliers=TRUE)
```

```{r}
community_reg(df=paired_enc, calc_diff = TRUE,
              col_name="light_hours_current", dep="V1", 
              title="Difference in Light Hours by Community", 
              var_type="ratio")
```

```{r}
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "light_hours_current", calc_diff=TRUE,
                title="Energy Consumption vs. Difference in Light Hours")
```

### Business Operation Hours

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
plot_func(df=ci_clean, var_name="operations_hours_change", 
          var_type="non_cont", plot_title="Change in C&I Business Hours", 
          plot_type="pie", char_remove=NULL)
```

```{r}
plot_func(df=ci_clean, var_name="business_hours_increase", 
          var_type="non_cont", plot_title="Change in C&I Business Hours", 
          plot_type="pie", char_remove=NULL)
```

```{r}
## Since connection to Renewvia mini-grid, have your hours of operation changed at all?
# Check for increase
community_reg(df=ci_enc, 
              col_name="operations_hours_change", dep="1", var_type="categorical",
              title="Scatterplots For Increase in Business Hours by Community")
```

### Schools - Academic Performance

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
plot_func(df=ci_clean, var_name="school_performance", 
          var_type="non_cont", plot_title="Schools - Academic Performance", 
          plot_type="pie", char_remove=NULL)
```

```{r}
## Have you seen a change in overall school performance?
community_reg(df=ci_enc, 
              col_name="school_performance", dep="1", var_type="categorical",
              title="Schools - Increase in Academic Performace by Community")
```

### Household - Academic Performance

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
plot_func(df=post_clean, var_name="school_performance_change", 
          var_type="non_cont", plot_title="Household - Academic Performance", 
          plot_type="pie", char_remove=NULL)
```

```{r}
community_reg(df=post_enc, 
              col_name="school_performance_change", 
              dep="1", var_type="categorical",
              title="Households - Increase in Academic Performace by Community")
```

### TODO: C&I Workforce

```{r}
# Since connection to Renewvia mini-grid, have you had any change in number of workers/employees at your place of work?
```

# 3- Health

## A) Descriptive

### Water Source

```{r}
# What is your source of water?
compare_pre_post(var_name="water_source", var_type="non_cont",
                 subplot_type="pie", title="Sources Water")
```

```{r}
# Do you have a source for clean drinking water?
compare_pre_post(var_name="clean_drinking_water", var_type="non_cont",
                 subplot_type="pie", title="Clean Drinking Water")
```

```{r}
# What is the source for clean drinking water?
compare_pre_post(var_name="clean_drinking_water_source", var_type="non_cont",
                 subplot_type="pie", title="Clean Drinking Water Sources")
```

### Kerosene Lamps

```{r}
# How many kerosene lamps do you currently have in your household?
compare_pre_post(var_name="kerosene_lamps_count", var_type="non_cont",
                 subplot_type="bar_discrete", title="No. of Kerosene Lamps", 
                 char_remove=c(24))
```

```{r}
# Has the number of kerosene lamps in your household changed since connection to minigrid?
plot_func(df=post_clean, var_name="kerosene_lamp_usage_change", 
          var_type="non_cont", plot_title="Kerosene Lamps Usage", 
          plot_type="pie", char_remove=NULL)
```

### Healthcare

```{r}
# # Does your Health Center have access to electricity?
compare_pre_post(var_name="clinic_electricity_access", var_type="non_cont",
                 subplot_type="pie", title="Clinic Access To Electricity", 
                 char_remove=NULL)
```

```{r}
# How close is the nearest Health Center / Clinic
compare_pre_post(var_name="clinic_travel_distance", var_type="non_cont",
                 subplot_type="bar", title="Clinic Access - Travel Distance", 
                 char_remove=NULL)
```

```{r}
# Does your Health Center / Clinic have access to refrigeration?
compare_pre_post(var_name="clinic_refrigeration_access", var_type="non_cont",
                 subplot_type="pie", title="Clinic Access to Refrigeration")
```

### TODO: New Columns for each type

```{r}
# What services are you able to offer/sell/provide due to connection to Renewvia minigrid that you werent able to offer prior to connection?
```

```{r}
# What is the Clinic / Hospital able to offer or provide due to connection to Renewvia minigrid that it wasnt able to offer before?
```

## B) Inferential

### Access to clean drinking water

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you have a source for clean drinking water? ## McNemar's  Test
paired_testing(paired_enc, var_name="clean_drinking_water", 
               test_type = "mcnemar", plot_diff=FALSE)
```

### Clean drinking water access - change

**Data Source**: C&I Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Since connection to Renewvia mini-grid, has your access to clean drinking water changed at all?
community_reg(df=post_enc, 
              col_name="clean_drinking_water_source", dep="1", var_type="categorical",
              title="Increase in Access to Clean Drinking Water by Community")
```

### Kerosene Lamps Count\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## How many kerosene lamps do you currently use in your household? 
paired_testing(paired_enc, var_name="kerosene_lamps_count", 
               test_type = "ttest", plot_diff=TRUE)
```

```{r}
community_reg(df=paired_enc, calc_diff = TRUE,
              col_name="kerosene_lamps_count", dep="V1", 
              title="Difference in No. of Kerosene Lamps by Community", 
              var_type="ratio")
```

```{r}
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "kerosene_lamps_count", calc_diff=TRUE,
                title="Energy Consumption vs. Difference in No. of Kerosene Lamps")
```

### Kerosene Lamps Usage

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
community_reg(df=post_enc, 
              col_name="kerosene_lamp_usage_change", dep="-1", 
              var_type="categorical",
              title="Decrease in Lamps Water by Community")
```

### New Health Services

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="non_cont", plot_title="Change in Health Services Offered by Clinics", 
          plot_type="bar_discrete", char_remove=NULL)
```

```{r}
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="non_cont", plot_title="Change in Health Services Offered by Clinics", 
          plot_type="pie", char_remove=c(0))
```

```{r}
## For clinics or health services only: Since connection to Renewvia mini-grid, have your health service offerings changed in any of the following ways: (select all that apply).
community_reg(df=ci_enc, 
              col_name="health_offering_change_count", dep="V1", 
              title="New Health Services Offered by Community", 
              var_type="ratio")
```

```{r}
sub <- ci_enc %>% filter(health_offering_change_count != 0)
consumption_reg(df = sub, reg_type ="linear", 
                dep= "health_offering_change_count", calc_diff=FALSE,
                title="Energy Consumption vs. New Health Services Offered")
```

### Clinic Access To Electricity

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
compare_in_df(data=paired_clean, var_type="non_cont",
               var1="clinic_electricity_access_pre", 
               var2="clinic_electricity_access_post", 
               var1_title="Pre - Electricity Access", var2_title="Post - Minigrid Access", 
               subplot_type="pie", plot_title="Clinic Access To Electricity")
```

```{r}
paired_testing(paired_enc, var_name="clinic_electricity_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="clinic_electricity_access", dep="1", 
              title="Clinic Access To Electricity", 
              var_type="categorical", calc_diff = TRUE)
```

### Clinic Access To Refrigeration

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
compare_in_df(data=paired_clean, var_type="non_cont",
               var1="clinic_refrigeration_access_pre", 
               var2="clinic_refrigeration_access_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", plot_title="Paired - Clinic Access to Refrigeration")
```

```{r}
## Does your Health Center / Clinic have access to refrigeration?
## McNemar's  Test
paired_testing(paired_enc, var_name="clinic_refrigeration_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="clinic_refrigeration_access", dep="1", 
              title="Clinic Access To Refrigeration", 
              var_type="categorical", calc_diff = TRUE)
```

### Better access to healthcare

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you feel that you have better access to health services because of connection to mini-grid?
plot_func(df=post_clean, var_name="better_access_health_minigrid", 
          var_type="non_cont", plot_title="Households - Better Access to Healthcare", 
          plot_type="pie")
```

```{r}
community_reg(df=post_enc, 
              col_name="better_access_health_minigrid", dep="1", var_type="categorical",
              title="Scatterplots For Better Healthcare Access by Community") 
```

```{r}
consumption_reg(df = post_enc, reg_type ="logistic",
                dep= "better_access_health_minigrid", 
                title="Energy Consumption vs. Better Healthcare Access")
```

# 4- Safety

## A) Descriptive

### Feeling Safe

```{r}
# How safe do you feel outside your home when it is dark?
compare_in_df(data=paired_enc, var_type="non_cont",
               var1="feel_safe_dark_pre", 
               var2="feel_safe_dark_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar_discrete", plot_title="Feeling Safe When Dark")
```

### Reasons for Feeling Unsafe

```{r}
# What makes you feel the most unsafe?
compare_pre_post(var_name="feel_unsafe_reasons", var_type="non_cont",
                 subplot_type="bar", title="Reasons for Feeling unsafe")
```

### Presence of Community Lights

```{r}
# Does your community currently have outdoor community lights?
compare_pre_post(var_name="community_lights", var_type="non_cont",
                 subplot_type="pie", title="Presence of Community Lights")
```

### Household - Exterior Lights

```{r}
# Does your home have exterior lighting?
plot_func(df=post_clean, var_name="home_exterior_lights", 
          var_type="non_cont", plot_title="Households - Exterior Lights", 
          plot_type="pie")
```

```{r}
# Is this exterior lighting powered by minigrid?
compare_in_df(data=post_clean, var_type="non_cont",
              var1="exterior_lights_minigrid", 
               var2="home_exterior_lights", 
               var1_title="Powered by Minigrid?", var2_title="Home With Exterior Light?", 
               subplot_type="pie", plot_title="Households - Exterior Lights")
```

## B) Inferential

### Feeling Safe

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Very unsafe" = 1; "Somewhat unsafe" = 2; "Neither safe nor unsafe"= 3; "Somewhat safe" = 4; "Very safe" = 5

```{r}
# # How safe do you feel outside your home when it is dark?
paired_testing(paired_enc, var_name="feel_safe_dark", 
               test_type = "wilcoxon", plot_diff=TRUE)
```

### Reasons for Feeling Unsafe - Potential Theft

```{r}
# What makes you feel the most unsafe? Testing for Potentiel Theft only
community_reg(df=paired_enc, 
              col_name="unsafe_due_to_theft", dep="-1", 
              title="Unsafe Due to Theft", 
              var_type="categorical", calc_diff = TRUE)
```

### TODO: Presence of Community Lights

```{r}
# Does your community currently have outdoor community lights?
paired_testing(paired_enc, var_name="community_lights", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="community_lights", dep="1", 
              title="Community Lights", 
              var_type="categorical", calc_diff = TRUE)
```

# 5- Economic Activity

## A) Descriptive

### Pre-connection: Employment Type

```{r}
# Type of employment for Primary Provider
plot_func(df=initial_pre, var_name="employement_type", 
          var_type="non_cont", plot_title="Employement Type of Primary Provider", 
          plot_type="pie")
```

### Occupation Change

```{r}
# Has your (or your spouses) occupation changed since youve been connected to minigrid power?
plot_func(df=post_clean, var_name="occupation_change", 
          var_type="non_cont", plot_title="Change in Occupation of Primary Provider", 
          plot_type="pie")
```

### Household Income

```{r}
# What is your average monthly household income:
# compare_pre_post(var_name="avg_household_income", var_type="cont",
#                  subplot_type="hist", char_remove = 0, exclude_outliers = TRUE,
#                  title="Average Household Income", shared_legend=FALSE)
plot_func(df=initial_pre, var_name="avg_household_income", 
          var_type="cont", plot_title="Pre-Connection - Average Household Income", 
          plot_type="hist", char_remove = 0, remove_outliers = TRUE)
plot_func(df=post_clean, var_name="avg_household_income", 
          var_type="cont", plot_title="Post-Connection - Average Household Income", 
          plot_type="hist", char_remove = 0, remove_outliers = TRUE)
```

```{r}
# Has your household income changed since your connection to minigrid power?
plot_func(df=post_clean, var_name="household_income_change", 
          var_type="non_cont", plot_title="Change in Household Income", 
          plot_type="pie")
```

### TODO: Costs - Additional Cleaning

#### Phone Charging

```{r}
# How much do you pay per month to charge your mobile phone?
compare_pre_post(var_name="phone_charge_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Phone Charging Cost", shared_legend=TRUE)
```

#### Appliances Charging

```{r}
# What is approximate monthly cost of energy used strictly for charging appliances?
compare_pre_post(var_name="applicances_charging_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Appliances Charging Cost", shared_legend=TRUE)
```

#### Cooking Energy

```{r}
# What is the approximate monthly cost of energy used strictly for cooking?
compare_pre_post(var_name="cooking_energy_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Cooking Energy Cost", shared_legend=TRUE)
```

#### Kerosene Lamps

```{r}
# How much do you pay monthly for kerosene used only in kerosene lamps?
compare_pre_post(var_name="kerosene_lamps_cost", var_type="non_cont",
                 subplot_type="bar",
                 title="Kerosene Lamps Cost", shared_legend=TRUE)
```

### TODO: Local Business Creation

```{r}
# Are any household members business owners?
# Is this business recent (started after connection to minigrid power?)
# If this business is new, do you consider this new business a result of having access to minigrid power?
```

## B) Inferential

### Avg. Household Income\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## What is your average monthly household income?
nigeria_df <- paired_clean %>% filter(country_post == "nigeria")
paired_testing(nigeria_df, var_name="avg_household_income", 
               test_type = "ttest", plot_diff=TRUE)
```

```{r}
kenya_df <- paired_clean %>% filter(country_post == "kenya")
paired_testing(kenya_df, var_name="avg_household_income", 
               test_type = "ttest", plot_diff=TRUE)
```

#### TODO: Needs further Investigation on negative differences

### Household - Income Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Has your household income changed since your connection to mini-grid power?
community_reg(df=post_enc, 
              col_name="household_income_change", dep="1", 
              title="Household Income Increase by Community", 
              var_type="categorical", calc_diff = FALSE)
```

### C&I - Earnings Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
# For businesses or shop owners only: Since connection to Renewvia mini-grid, have you seen any change in your weekly or monthly earnings?
community_reg(df=ci_enc, 
              col_name="earnings_change", dep="1", 
              title="C&I Earnings Increase by Community", 
              var_type="categorical", calc_diff = FALSE)
```

```{r}
df_pos <- ci_enc %>% filter(earnings_change != -1)
consumption_reg(df = df_pos, reg_type ="logistic",
                dep= "earnings_change", exclude_outliers = TRUE, 
                title="Energy Consumption vs. C&I Earnings Increase")
```

### Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

```{r}
# Are any household members business owners?
## McNemar's Test
paired_testing(paired_enc, var_name="business_owners_binary", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="business_owners_binary", dep="1", 
              title="Household Business Onwership by Community", 
              var_type="categorical", calc_diff =TRUE)
```

### TODO: Regression with energy consumption in both directions (1, -1)
