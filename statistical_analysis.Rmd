---
title: "Renewvia - Survey Impact Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# Overview

## Descriptive

-   Generating summary statistics

-   Plotting graphs/charts

## **Inferential**

-   For the paired data set, we will use the following

    -   Paired t-Test for ratio

    -   Wilcoxon Signed Rank Test (Sign Test if asymmetric) for ordinal variables

    -   McNemar's Test for binary responses

-   Our independent variables will be the following: PV Size (kWh), No. of Customers, CAPEX (USD) and Consumption (Community & Customer).

-   For each dependent variables, we will run a uni-variate regression tests with each of independent variable. When applicable, we will have a Linear regression t-Test or Logistic regression Wald test

# Libraries

```{r}
# Importing libraries
options(warn=-1)
library(ggplot2)
library(dplyr)
library(lessR)
library(tidyr)
library(ggpubr)
library(exact2x2)
library(stringr)
library(epiDisplay)
library(tibble)
library(ggExtra)
library(vtree)
library(CGPfunctions)
library(psych)
library(nonpar)
library(scales)
library(tidyverse)
library(ggrepel)
library(data.table)
library(forcats)
library(glue)
library(aod)
```

# Input Data

```{r}
## Locading the project& consumption data
consumption <- read.csv("customer_consumption.csv")
customer_info <- read.csv("customers_info.csv")

temp <- merge(consumption, customer_info, 
              by.x = 'Account.Number',
              by.y = 'customerAccountNumber')  
temp_group <- temp %>% 
                    group_by(projectName) %>% 
                    summarise(consumption = sum(Energy.Consumption, na.rm=TRUE))
projects <- read.csv("project_data.csv")
projects <- merge(projects, temp_group, by.x="project_name", by.y="projectName")
```

```{r}
## Locading the cleaned data sets
# Intial Survey
initial <- read.csv("data_cleaning/datasets_clean/initial_clean.csv",
                          na.strings=c("","NA"))
initial_clean <- merge(initial, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre <- initial_clean %>%
                    filter(status == "pre_connection") 

# Post-connection
initial_post <- initial_clean %>%
                    filter(status == "post_connection") 

# head(initial_clean)
# head(initial_pre)
# head(initial_post)

# Household Post-Survey
post <- read.csv("data_cleaning/datasets_clean/post_clean.csv",
                          na.strings=c("","NA"))
post_clean <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')%>% 
                    filter(tariff == "Residential")
# head(post_clean)

# Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_clean/ci_post_clean.csv",
                          na.strings=c("","NA"))
ci_clean <- merge(ci, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
# head(ci_clean)
```

```{r}
## Locading the encoded data sets
# Intial Survey
initial_enc <- read.csv("data_cleaning/datasets_encoded/initial_encoded.csv",
                          na.strings=c("","NA")) 
initial_enc <- merge(initial_enc, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre_enc <- initial_enc %>%
                    filter(status == 1)
# Pre-connection
initial_post_enc <- initial_enc %>%
                    filter(status == 2)

# head(initial_enc)
# head(initial_pre_enc)
# head(initial_post_enc)

# Household Post-Survey
post <- read.csv("data_cleaning/datasets_encoded/post_encoded.csv",
                          na.strings=c("","NA"))
post_enc <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')  %>% 
                    filter(tariff == "Residential")
# Post-Connection
# post_clean_enc <- post_enc 
# head(post_enc)
# head(post_clean_enc)

# Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_encoded/ci_post_encoded.csv",
                          na.strings=c("","NA")) 
ci_enc <- merge(ci, temp,
                 by.x = 'renewvia_id', 
                 by.y = 'Account.Number')
# head(ci_enc)
```

```{r}
## Pairing pre and post responses
paired_clean <- merge(initial_pre, post_clean,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
# paired_clean <- merge(paired_temp, consumption,
#                        by.x = 'renewvia_id', 
#                        by.y = 'Account.Number')
head(paired_clean)


paired_enc <- merge(initial_pre_enc, post_enc,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
# paired_enc <- merge(paired_temp_enc, consumption,
#                        by.x = 'renewvia_id', 
#                        by.y = 'Account.Number')
head(paired_enc)
```

# Initial Descriptive

```{r}
# No. of observations by datasets
# % Missing Values for each variables
# No. of duplicates
```

# Utility Functions

## Descriptive

```{r}
get_stats <- function(data, ct, var_name,data_source, 
                      remove_outliers = FALSE, 
                      exclude_zeros = FALSE) {
  if (grepl("_pre", var_name, fixed = TRUE)){
    country_data <- data %>% filter(country_pre == ct)
  } else if (grepl("_post", var_name, fixed = TRUE)){
    country_data <- data %>% filter(country_post == ct)
  } else {country_data <- data %>% filter(country == ct)}
    
  if (remove_outliers == TRUE) {
    print("Excluding outliers")
    quartiles <- quantile(country_data[, var_name], 
                        probs=c(.25, .75), na.rm = TRUE)
  
    IQR <- IQR(country_data[, var_name], na.rm = TRUE)
    
    Lower <- quartiles[1] - 1.5*IQR
    Upper <- quartiles[2] + 1.5*IQR 
    
    country_data <- subset(country_data, 
                              country_data[, var_name] > Lower &
                              country_data[, var_name] < Upper)
  } 
  
  var <- country_data[, var_name]
  
  if (exclude_zeros == TRUE) {
    print("Removing Zeros")
    var <- var[var != 0]
  } 
  
  stats <- t(describe(var, IQR=TRUE, quant=c(.1,.25,.5,.75,.90),))
  print(t.test(var, conf.level = 0.95))
  hist_title <- paste(filt_ct, data_source, " : ", var_name)
  print(stats)
  return(hist(var, main=hist_title))
}
```

## Data Visualization

```{r}
# For pie and bar charts
plot_func <- function(df, var_name, var_type, plot_title, plot_type, chars_remove=NULL) {
  
  if(var_type == "non_cont") {
      var <- df[, var_name]
      var <- var[var != ""]
      
      data <- as.data.frame(t(table(var)))[,2:3] 
      setnames(data, 
               old = c('var','Freq'), 
               new = c('labels','counts'))
    
      if(is.null(chars_remove) == FALSE) {
        data <- data[!grepl(chars_remove,data$labels),]
      }
      
      if (plot_type == 'pie') {
          data_tab <- data %>% mutate(csum = rev(cumsum(rev(counts))),
                                 pos = counts/2 + lead(csum, 1),
                                 pos = if_else(is.na(pos), counts/2, pos),
                                 percentage = counts/sum(counts))
          data_tab$labels <- as.factor(data_tab$labels)
          plot <- data_tab %>% ggplot(aes(x = "", y = counts, fill = labels)) +
                              geom_col(width = 1, color = 1) +
                              geom_label_repel(
                                aes(y = pos,
                                    label = glue("{counts} ({percent(percentage)})"),
                                     fill = labels),
                                    show.legend = FALSE) +
                              labs(fill = var_name, title=plot_title) +
                              coord_polar(theta = "y") +
                              theme_void()
      } else if (plot_type == "bar") {
          plot <- data %>% ggplot(aes(y=counts, 
                                      x=reorder(labels, counts), 
                                      fill=labels)) + 
                            geom_col(width = 0.7) +
                            geom_text(aes(label=counts), vjust=-0.3, size=3)+
                            labs(fill = var_name, title=plot_title) + 
                            coord_flip()
      } else if (plot_type == "bar_discrete") {
          plot <- data %>% ggplot(aes(y=counts, x=labels)) + 
                            geom_col(width = 0.7) +
                            labs(title=plot_title, x = var_name) 
      } 
  }else if(var_type == "cont") {
      if(plot_type == "hist_cont") {
        plot <- ggplot(df, aes(x=var_name)) + 
                      geom_histogram() +
                      labs(title=plot_title) +
                      theme_void()
      }else if(plot_type == "boxplot") {
        plot <- ggplot(df, aes(x=var_name)) + 
                geom_boxplot(outlier.colour="red",
                              outlier.size=4)+
                labs(title=plot_title) +
                theme_void()
    }
  }

  
  ## boxplot
  plot <- plot + theme(legend.text=element_text(size=6))
  return(plot)
}
```

```{r}
remove_y <- theme(
  # axis.text.x = element_blank(),
  # axis.ticks.x = element_blank(),
  # axis.title.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks.y = element_blank(),
  axis.title.y = element_blank()
)

compare_pre_post <- function(var_name, var_type, subplot_type, title, 
                             chars_remove=NULL, shared_legend=TRUE) {

  pre_plot <- plot_func(initial_pre, var_name, var_type,
                         "Initial", subplot_type, chars_remove)
  post_plot <- plot_func(post_clean, var_name, var_type,
                          "Post", subplot_type, chars_remove)
  if (subplot_type == "bar") {
        plot <- ggarrange(post_plot + remove_y, pre_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = shared_legend,legend="bottom")
  } else {
        plot <- ggarrange(post_plot, pre_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = shared_legend,
                        legend="right")
  }
      
  return(annotate_figure(plot, 
                         top = text_grob(title, color = "black", 
                                         face = "bold", size = 12)))

}

compare_in_df <- function(data, var1, var2, 
                            var1_title, var2_title, 
                            subplot_type, plot_title,
                          var_type,
                          chars_remove=NULL){
  var1_plot <- plot_func(data, var1, var_type,
                          var1_title, subplot_type, chars_remove)
  var2_plot <- plot_func(data, var2, var_type,
                          var2_title, subplot_type, chars_remove)
  if (subplot_type == "bar") {
        plot <- ggarrange(var2_plot + remove_y, var1_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = TRUE,legend="bottom")
  } else {
        plot <- ggarrange(var2_plot, var1_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = TRUE,
                        legend="right")
  }
      
  return(annotate_figure(plot, top = text_grob(plot_title, 
                 color = "black", face = "bold", size = 12)))
}
```

## Hypothesis Testing

```{r}
# Running the paired t-test
paired_testing <- function(data, var_name, test_type, 
                           plot_diff=FALSE, plot_title=NULL, remove_outliers=FALSE) {
  pre_name <- paste(var_name, "pre", sep="_")
  post_name <- paste(var_name, "post", sep="_")
  var_pre <- data[, pre_name]
  var_post <- data[, post_name]
  diff <- var_post - var_pre
  
  # Running the test
  if(test_type == "wilcoxon"){
    #Wilcoxon Signed-Rank Test
    test <- wilcox.test(var_pre, var_post, paired=TRUE)
  }else if(test_type == "sign") {
    #Sign Test
    test <- signtest(diff, m=0, conf.level=0.95, exact=FALSE)
  } else if (test_type == "ttest") {
    #Paired t-Test
    test <- t.test(var_pre, var_post,
         paired = TRUE, alternative = "two.sided")
  } else if(test_type == "mcnemar") {
    cross_tab <- table(var_pre, var_post)
    print(cross_tab)
    test <- mcnemar.test(cross_tab)
  }
  
  # Visualize distribution of score differences
  if(plot_diff == TRUE) {
      hist(diff, main=plot_title)
  }
  return(test)
}
```

## Regression Analysis

```{r}
ind_vars <- c("pv_size_kwh", "customer_count", "capex_usd", "consumption")

community_reg <- function(df, col_name, dep, title, var_type, calc_diff=FALSE) {
  if (calc_diff == TRUE) {
      pre_name <- paste(col_name, "pre", sep="_")
      post_name <- paste(col_name, "post", sep="_")
      df$col_diff <- df[, post_name] - df[, pre_name]
      names(df)[names(df) == "community_post"] <- "community"
  } else {
      df$col_diff <- df[, col_name]
  }
  
  if(var_type == "categorical") {
    data <- rownames_to_column(as.data.frame.matrix(
                                  prop.table(table(
                                      df[, "community"], 
                                      df[, "col_diff"]),
                                     margin = 1)
                                              )
                                  , var = "community")
  } else if(var_type == "ratio") {
    data <- as.data.frame(rowsum(df[, "col_diff"], 
                                 df[, "community"], na.rm = TRUE))
    data$community <- rownames(data)
    
    
  }
  community_data <- merge(x=projects, y=data, by="community")
    lst <- list()
  
   for(ind in ind_vars) {
        print(ind)
          p <- plot_reg(data=community_data, feature=ind,  
                        dependent=dep, reg_type="linear")
          lst <- append(lst, list(p))
          lm <- lm(community_data[,dep] ~ community_data[,ind])
          details <- summary(lm)
          result <- as.data.frame(details$coefficients, row.names = c("Intercept", ind))
          print(result)
          print(confint(lm, level=0.95))
      }
  plot <- ggarrange(plotlist = lst, 
                    ncol = 2, nrow = 2, 
                    common.legend = TRUE,
                    legend="right")
  annotate_figure(plot, top = text_grob(title, 
                 color = "black", face = "bold", size = 12))
}

plot_reg <- function(data, feature, dependent, remove_outliers=TRUE, reg_type) {
  if(remove_outliers == TRUE) {
    vars <- c(feature, dependent) 
    for(var in vars){
      quartiles <- quantile(data[, var], 
                        probs=c(.25, .75), na.rm = TRUE)
  
      IQR <- IQR(data[, var], na.rm = TRUE)
      
      Lower <- quartiles[1] - 1.5*IQR
      Upper <- quartiles[2] + 1.5*IQR 
      
      data <- subset(data, 
                     data[, var] > Lower &
                     data[, var] < Upper)
    }
    
  }
  if(reg_type == "linear") {
    plot <- ggplot(data,
                aes(x=.data[[feature]], y=.data[[dependent]])) +
                geom_point(color='blue') +
                  geom_smooth(color='red', method = "lm", se = FALSE) +
                theme_classic()
  } else if(reg_type == "logistic") {
     plot <- ggplot(data, 
                    aes(x=.data[[feature]], y=.data[[dependent]])) + 
              geom_point(color='blue', alpha=.5) +
              stat_smooth(method="glm", color="red", se=FALSE, 
                        method.args = list(family=binomial)) +
                theme_classic()
  }
  
 
  return(plot)
}
```

# 1- Gender Equality

## A) Descriptive

### Demographics

```{r}
# What was the gender breakdown of survey respondents, pre and post?
compare_pre_post(var_name="gender", var_type="non_cont",
        subplot_type="pie", title="Gender Breakdown")
```

### School Enrollment

```{r}
# What was school enrollment by gender pre-connection?
girls <- sum(initial_pre$girls_headcount,na.rm = TRUE)
girls_in_school <- sum(initial_pre$girls_schooling,na.rm = TRUE)
enrollment_rate <- percent(girls_in_school/girls, accuracy = 0.01)

vals <- c(girls, girls_in_school, enrollment_rate)

# creating matrix
tab <- as.data.frame(t(as.matrix(vals)))
setnames(tab, old = c('V1','V2', 'V3'), 
          new = c("Girls", "Girls.In.School", "Enrollment.Rate"))
tab
```

```{r}
# Was there a change in enrollment by gender afterwards?
compare_in_df(data=post_clean, var_type="non_cont",
               var1="girls_schooling_change", 
               var2="boys_schooling_change", 
               var1_title="Girls", var2_title="Boys", 
               subplot_type="pie", plot_title="School Enrollment Change")
```

```{r}
# Dirving factor for non-enrollment in school for boys and girls
# For Girls
compare_pre_post(var_name="girls_unschooled_reasons", var_type="non_cont", 
        subplot_type="bar", title="Girls Schooling: Reasons for non-enrollment",
        chars_remove=c("they_all_attend_school", ""))
```

```{r}
# For Boys
compare_pre_post(var_name="boys_unschooled_reasons",  var_type="non_cont",
        subplot_type="bar", title="Boys Schooling: Reasons for non-enrollment",
        chars_remove=c("they_all_attend_school", ""))
```

### Household Chores

```{r}
# What is the average age of the person in charge of water collection?
compare_pre_post(var_name="avg_person_age_water_collection", var_type="non_cont",
        subplot_type="bar", title="Age of Person Responsible for Cooking Fuel Collection") 
```

### Female Businesses Ownership

```{r}
# How many new women-led businesses were created?
compare_pre_post(var_name="business_owners_female", var_type="non_cont", 
        subplot_type="pie", title="Women Business Owners")
```

### TODO

```{r}
# In respondent's own words, how were women affected from the mini-grid?

## Requires additional cleaning/annotations
# Who is mainly responsible for cooking fuel collection on a daily basis? Select all that apply
```

## B) Inferential

### School Enrollment Change 

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

#### Linear Regression - Increase

```{r}
# Check for increase
community_reg(df=post_enc, 
              col_name="girls_schooling_change", dep="1", var_type="categorical",
              title="Scatterplots For Increase in School Change by Community")
```

#### Linear Regression - Decrease

```{r}
# Check for decrease
community_reg(df=post_enc, 
              col_name="girls_schooling_change", dep="-1", var_type="categorical",
              title="Scatterplots For Increase in School Change by Community")
```

### Water Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "less than 1 hour" = 1; "1-2 hours" = 2; "2-3 hours" = 3; "3-4 hours" = 4; "greater than 4 hours" = 5

#### Pre-Post Comparison

```{r}
compare_in_df(data=paired_clean, var_type="non_cont", 
               var1="water_collection_time_pre", 
               var2="water_collection_time_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar", plot_title="Water Collection Time")
```

#### Sign-Test

```{r}
# How long does the water collection process take on a daily basis?
paired_testing(paired_enc, var_name="water_collection_time", 
               test_type = "sign", plot_diff=TRUE, 
               plot_title="Difference Pre-Post of Water Collection Times")
```

### Cooking Fuel Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "No need to collect fuel" = 1; "less than 1 hour" = 2; "1-2 hours" =3; "3-5 hours" = 4; "greater than 4 hours" = 5

#### Pre-Post Comparison

```{r}
compare_in_df(data=paired_clean, var_type="non_cont",
               var1="cooking_fuel_collection_time_pre", 
               var2="cooking_fuel_collection_time_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="bar", plot_title="Cooking Fuel Collection Time")
```

#### Wilcoxon Signed-Rank Test

```{r}
# How long does the cooking fuel collection process take on a daily basis?
paired_testing(paired_enc, var_name="cooking_fuel_collection_time", 
               test_type = "wilcoxon", plot_diff=TRUE, 
               plot_title="Difference Pre-Post of Water Collection Times")
```

### Women-led Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Everything else = 0; "adult_female" = 1

```{r}
# Are any household members business owners?
paired_testing(paired_enc, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

### New Female workers

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
# If you answered yes to adding new workers, how many new employees are female?
# Check for increase
community_reg(df=ci_enc, 
              col_name="workforce_change_female", dep="V1", 
              title="New Female Workers Change by Community", 
              var_type="ratio")
```

# 2- Productivity

## A) Descriptive

### Power Source

```{r}
# What is your primary power source?
compare_pre_post(var_name="power_sources_primary", var_type="non_cont",
                 subplot_type="bar", title="Power Source",
                 chars_remove=NULL)
```

### No. of Appliances

```{r}
# How many electronic devices or appliances do you currently use in the household
compare_pre_post(var_name="appliances_count", var_type="non_cont",
                 subplot_type="bar_discrete", title="Appliances",
                 chars_remove=NULL)
```

```{r}
# Has the number of electronic devices or appliances increased since connection to minigrid?
plot_func(df=post_clean, var_name="appliances_count_change", 
          var_type="non_cont", plot_title="Change in No. of Appliances", 
          plot_type="pie", chars_remove=NULL)
```

### Travel Distance - Phone Charge

```{r}
# How far must you travel to charge your mobile phone?
compare_pre_post(var_name="phone_charge_travel_distance", var_type="non_cont",
                 subplot_type="bar", title="Travel Distance to Charge Phone",
                 chars_remove=NULL)
```

### Travel Distance - Water Collection

```{r}
# How far must you travel to obtain your water supply?
compare_pre_post(var_name="water_collection_travel_distance", var_type="non_cont",
                 subplot_type="bar", title="Travel Distance for Water Collection",
                 chars_remove=NULL)
```

### C&I Profile

```{r}
# Is this business, clinic, school still in operation?
plot_func(df=ci_clean, var_name="operation_status", 
          var_type="non_cont", plot_title="C&I - Type", 
          plot_type="pie", chars_remove=NULL)
```

```{r}
# Please select your business type
plot_func(df=ci_clean, var_name="business_type", 
          var_type="non_cont", plot_title="C&I - Type", 
          plot_type="bar", chars_remove=NULL)
```

### C&I - Operation Hours

```{r}
# Since connection to Renewvia minigrid, have your hours of operation changed at all?
plot_func(df=ci_clean, var_name="operations_hours_change", 
          var_type="non_cont", plot_title="Change in C&I Operation Hours", 
          plot_type="pie", chars_remove=NULL)
```

### C&I - Workforce

```{r}
# Since connection to Renewvia mingrid, have you had any change in number of workers/employees at your place of work?
plot_func(df=ci_clean, var_name="workforce_change", 
          var_type="non_cont", plot_title="Change in C&I Workforce", 
          plot_type="pie", chars_remove=NULL)
```

## B) Inferential

### Light Hours

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value between 0 and 24

```{r}
compare_pre_post(var_name="light_hours_current", var_type="non_cont",
                 subplot_type="bar_discrete", title="Light Hours",
                 chars_remove=c(46))
```

```{r}
## How many hours of light per day do you currently have at home?
paired_testing(paired_enc, var_name = "light_hours_current", 
               plot_diff = TRUE, plot_title = "Difference Pre-Post in Light Hours",
               test_type="ttest")
```

### Business Operation Hours

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
plot_func(df=ci_clean, var_name="operations_hours_change", 
          var_type="non_cont", plot_title="Change in C&I Business Hours", 
          plot_type="pie", chars_remove=NULL)
```

```{r}
plot_func(df=ci_clean, var_name="business_hours_increase", 
          var_type="non_cont", plot_title="Change in C&I Business Hours", 
          plot_type="pie", chars_remove=NULL)
```

```{r}
## Since connection to Renewvia mini-grid, have your hours of operation changed at all?
# Check for increase
community_reg(df=ci_enc, 
              col_name="operations_hours_change", dep="1", var_type="categorical",
              title="Scatterplots For Increase in Business Hours by Community")
```

### TODO: Schools - Academic Performance

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
plot_func(df=ci_clean, var_name="school_performance", 
          var_type="non_cont", plot_title="Schools - Academic Performance", 
          plot_type="pie", chars_remove=NULL)
```

```{r}
## Have you seen a change in overall school performance?
# Isolate the dependent variable
community_reg(df=ci_enc, 
              col_name="school_performance", dep="1", var_type="categorical",
              title="Scatterplots For Increase in School Performace by Community")
```

### Household - Academic Performance

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
plot_func(df=post_clean, var_name="school_performance_change", 
          var_type="non_cont", plot_title="Household - Academic Performance", 
          plot_type="pie", chars_remove=NULL)
```

```{r}
community_reg(df=post_enc, 
              col_name="school_performance_change", dep="1", var_type="categorical",
              title="Scatterplots For Increase in School Performace by Community")
```

# 3- Health

## A) Descriptive

### Water Source

```{r}
# What is your source of water?
compare_pre_post(var_name="water_source", var_type="non_cont",
                 subplot_type="pie", title="Sources Water")
```

```{r}
# Do you have a source for clean drinking water?
compare_pre_post(var_name="clean_drinking_water", var_type="non_cont",
                 subplot_type="pie", title="Clean Drinking Water")
```

```{r}
# What is the source for clean drinking water?
compare_pre_post(var_name="clean_drinking_water_source", var_type="non_cont",
                 subplot_type="pie", title="Clean Drinking Water Sources")
```

### Kerosene Lamps

```{r}
# How many kerosene lamps do you currently have in your household?
compare_pre_post(var_name="kerosene_lamps_count", var_type="non_cont",
                 subplot_type="bar_discrete", title="No. of Kerosene Lamps", 
                 chars_remove=c(24))
```

```{r}
# Has the number of kerosene lamps in your household changed since connection to minigrid?
plot_func(df=post_clean, var_name="kerosene_lamp_usage_change", 
          var_type="non_cont", plot_title="Kerosene Lamps Usage", 
          plot_type="pie", chars_remove=NULL)
```

### TODO: Healthcare

```{r}
# # Does your Health Center have access to electricity?
compare_pre_post(var_name="clinic_electricity_access", var_type="non_cont",
                 subplot_type="pie", title="Clinic Access To Electricity", 
                 chars_remove=NULL)
```

```{r}
# How close is the nearest Health Center / Clinic
compare_pre_post(var_name="clinic_travel_distance", var_type="non_cont",
                 subplot_type="bar", title="Clinic Access - Travel Distance", 
                 chars_remove=NULL)
```

```{r}
# Does your Health Center / Clinic have access to refrigeration?
compare_pre_post(var_name="clinic_refrigeration_access", var_type="non_cont",
                 subplot_type="pie", title="Clinic Access to Refrigeration")
```

### TODO: New Columns for each type

```{r}
# What services are you able to offer/sell/provide due to connection to Renewvia minigrid that you werent able to offer prior to connection?
```

```{r}
# What is the Clinic / Hospital able to offer or provide due to connection to Renewvia minigrid that it wasnt able to offer before?
```

## B) Inferential

### Access to clean drinking water

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you have a source for clean drinking water? ## McNemar's  Test
```

### Clean drinking water access - change

**Data Source**: C&I Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Since connection to Renewvia mini-grid, has your access to clean drinking water changed at all?
```

### Kerosene Lamps Count

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## How many kerosene lamps do you currently use in your household? # Running the paired t-test kerosene_pre <- paired_clean$kerosene_lamps_count_pre kerosene_post <- paired_clean$kerosene_lamps_count_post t.test(kerosene_pre, kerosene_post,        paired = TRUE, alternative = "two.sided") 
```

### Kerosene Lamps Usage

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}

```

### New Health Services

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="non_cont", plot_title="Change in Health Services Offered by Clinics", 
          plot_type="bar_discrete", chars_remove=NULL)
```

```{r}
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="non_cont", plot_title="Change in Health Services Offered by Clinics", 
          plot_type="pie", chars_remove=c(0))
```

```{r}
## For clinics or health services only: Since connection to Renewvia mini-grid, have your health service offerings changed in any of the following ways: (select all that apply).
community_reg(df=ci_enc, 
              col_name="health_offering_change_count", dep="V1", 
              title="New Health Services Offered by Community", 
              var_type="ratio")
```

### Clinic Access To Electricity

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
compare_in_df(data=paired_clean, var_type="non_cont",
               var1="clinic_electricity_access_pre", 
               var2="clinic_electricity_access_post", 
               var1_title="Pre - Electricity Access", var2_title="Post - Minigrid Access", 
               subplot_type="pie", plot_title="Clinic Access To Electricity")
```

```{r}
paired_testing(paired_enc, var_name="clinic_electricity_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="clinic_electricity_access", dep="1", 
              title="Clinic Access To Electricity", 
              var_type="categorical", calc_diff = TRUE)
```

### Clinic Access To Refrigeration

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
compare_in_df(data=paired_clean, var_type="non_cont",
               var1="clinic_refrigeration_access_pre", 
               var2="clinic_refrigeration_access_post", 
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", plot_title="Paired - Clinic Access to Refrigeration")
```

```{r}
## Does your Health Center / Clinic have access to refrigeration?
## McNemar's  Test
paired_testing(paired_enc, var_name="clinic_refrigeration_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

```{r}
community_reg(df=paired_enc, 
              col_name="clinic_refrigeration_access", dep="1", 
              title="Clinic Access To Refrigeration", 
              var_type="categorical", calc_diff = TRUE)
```

### Better access to healthcare

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you feel that you have better access to health services because of connection to mini-grid?
plot_func(df=post_clean, var_name="better_access_health_minigrid", 
          var_type="non_cont", plot_title="Households - Better Access to Healthcare", 
          plot_type="pie")
```

```{r}
community_reg(df=post_enc, 
              col_name="better_access_health_minigrid", dep="1", var_type="categorical",
              title="Scatterplots For Better Healthcare Access by Community") 
```

```{r}
ind_reg <- function(df, dep, title) {
  logit <- glm(df[, dep] ~ df$Energy.Consumption, 
               family=binomial)
  print(summary(logit))
  test <- wald.test(Sigma = vcov(logit), b = coef(logit), Terms = 1)
  print(test)
  p <- plot_reg(data=df, feature="Energy.Consumption",  
                   dependent=dep, reg_type="logistic", remove_outliers = FALSE)
  return(p)
  
}
ind_reg(df = post_enc,
        dep= "better_access_health_minigrid", 
        title="Logistic Regression")
```

# 4- Safety

## A) Descriptive

### Feeling Safe

```{r}
# How safe do you feel outside your home when it is dark?
compare_pre_post(var_name="feel_safe_dark", var_type="non_cont",
                 subplot_type="pie", title="Feeling Safe When Dark")
```

```{r}
# Do you feel that having access to minigrid power has made you more safe? Please explain
# Do you feel that having access to minigrid power has made you more safe? Please explain->
# Do you feel that you have better access to health services because of connection to minigrid?
# What makes you feel the most unsafe?
```

```{r}
# Does your community currently have outdoor community lights?
# Does your home have exterior lighting?
# How safe would you feel outside your home at nighttime IF you had exterior lights/community lighting?
# How safe would you feel outside your home at nighttime IF you had exterior lights?
# Is this exterior lighting powered by minigrid?
```

```{r}
# How did the feeling of safety change? For everyone? By Gender? By country? By Community?
# Average scores for everyone and split between men and women
women_initial_pre <- (initial_pre_enc %>% filter(gender == 1))$feel_safe_dark
women_initial_post <- (initial_post_enc %>% filter(gender == 1))$feel_safe_dark
women_post_survey <- (post_enc %>% filter(gender == 1))$feel_safe_dark
women_post_all <- c(women_intial_post, women_post_survey)
avg_scores <- c(mean(women_initial_pre, na.rm = TRUE), 
                mean(women_initial_post, na.rm = TRUE),
                mean(women_post_survey, na.rm = TRUE),
                mean(women_post_all, na.rm = TRUE))

# safety_scores <- paired_women[ , c("renewvia_id", 
#                                    "feel_safe_dark_pre",
#                                    "feel_safe_dark_post")]
# safety_scores_long <- melt(safety_scores, id = "renewvia_id")
# ggplot(safety_scores_long, 
#        aes(x = variable, y = value)) +  # ggplot function
#   geom_boxplot()
```

## B) Inferential

### Feeling Safe

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Very unsafe" = 1; "Somewhat unsafe" = 2; "Neither safe nor unsafe"= 3; "Somewhat safe" = 4; "Very safe" = 5

```{r}
# How safe do you feel outside your home when it is dark?
pre_scores <- paired_enc$feel_safe_dark_pre
post_scores <- paired_enc$feel_safe_dark_post
diff <- post_scores - pre_scores

# Running the test
# wilcox.test(pre_scores, post_scores, paired=TRUE)
signtest(diff, m=0, conf.level=0.95, exact=FALSE)

# Visualize distribution of score differences
hist(diff)
```

```{r}
# What makes you feel the most unsafe?
# 
# Does your community currently have outdoor community lights?
# 
# How safe would you feel outside your home at nighttime IF you had exterior lights?
```

# 5- Economic Activity

## A) Descriptive

### Household

```{r}
# Type of employment for Primary Provider
# What is your average monthly household income:
# Has your household income changed since your connection to minigrid power?
# Has your (or your spouses) occupation changed since youve been connected to minigrid power?
```

```{r}
# What is approximate monthly cost of energy used strictly for charging appliances?
# 
# What is the approximate monthly cost of energy used strictly for charging appliances?
# 
# What is the approximate monthly cost of energy used strictly for cooking?
# How much do you pay per month to charge your mobile phone?
# How much do you pay monthly for kerosene used only in kerosene lamps?
```

```{r}
# Are any household members business owners?
# Is this business recent (started after connection to minigrid power?)
# If this business is new, do you consider this new business a result of having access to minigrid power?
# Is this business, clinic, school still in operation?
# Please select your business type
```

### Commercial

```{r}
# Is this business, clinic, school still in operation?
# 
# Please select your business type
# 
# Since connection to Renewvia mingrid, have you had any change in number of workers/employees at your place of work?
# 
# Since connection to Renewvia minigrid, have your hours of operation changed at all?

# Have you added any new products or services since connection to Renewvia minigrid?
```

## B) Inferential

### Income

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## What is your average monthly household income?
# Running the paired t-test
ct <- "nigeria"
ct
df <- paired_clean %>% filter(country_post == ct)
income_pre <- df$avg_household_income_pre
income_post <- df$avg_household_income_post
t.test(income_pre, income_post,
       paired = TRUE, alternative = "two.sided")
```

```{r}
ct <- "kenya"
ct
df <- paired_clean %>% filter(country_post == ct)
income_pre <- df$avg_household_income_pre
income_post <- df$avg_household_income_post
t.test(income_pre, income_post,
       paired = TRUE, alternative = "two.sided")
```

### Income Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Has your household income changed since your connection to mini-grid power?
# Isolate the dependent variable
```

```{r}
# For businesses or shop owners only: Since connection to Renewvia mini-grid, have you seen any change in your weekly or monthly earnings?
```

### Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

```{r}
# Are any household members business owners?
## McNemar's Test
```

### Workplace

```{r}
# Since connection to Renewvia mini-grid, have you had any change in number of workers/employees at your place of work?
```
