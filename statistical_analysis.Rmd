---
title: "Renewvia - Survey Impact Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# OVERVIEW

## Exploratory Data Analysis (Descriptive)

-   Generating summary statistics

-   Plotting graphs/charts

## **Inferential**:

-   For the paired data set, we will use the following

    -   Paired t-Test for ratio

    -   Wilcoxon Signed Rank Test (Sign Test if asymmetric) for ordinal variables

    -   McNemar's Test for binary responses

-   Our independent variables will be the following: PV Size (kWh), No. of Customers, CAPEX (USD) and Consumption (Community & Customer).

-   For each dependent variables, we will run a uni-variate regression tests with each of independent variable. When applicable, we will have a Linear regression t-Test or Logistic regression Wald test

# Libraries

```{r}
# Importing libraries
library(ggplot2)

library(dplyr)
library(lessR)
library(tidyr)
library(ggpubr)
library(exact2x2)
library(stringr)
library(epiDisplay)
library(tibble)
library(ggExtra)
library(vtree)
library(CGPfunctions)
library(psych)
library(scales)
library(tidyverse)
library(ggrepel)
library(data.table)
library(forcats)
library(glue)
```

# Input Data

```{r}
## Locading the project& consumption data
projects <- read.csv("project_data.csv")
consumption <- read.csv("customer_consumption.csv")
customers_info <- read.csv("customers_info.csv")
```

```{r}
## Locading the cleaned data sets
# Intial Survey
initial_clean <- read.csv("data_cleaning/datasets_clean/initial_clean.csv",
                          na.strings=c("","NA"))

# Pre-connection
initial_pre <- initial_clean %>%
                    filter(status == "pre_connection")

# Post-connection
initial_post <- initial_clean %>%
                    filter(status == "post_connection") 

head(initial_clean)
head(initial_pre)
head(initial_post)

# Household Post-Survey
post_clean <- read.csv("data_cleaning/datasets_clean/post_clean.csv",
                          na.strings=c("","NA"))
post_clean <- merge(post_clean, consumption,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
head(post_clean)

# Commercial & Insitution Post-Survey
ci_clean <- read.csv("data_cleaning/datasets_clean/ci_post_clean.csv",
                          na.strings=c("","NA"))
ci_clean <- merge(ci_clean, consumption,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
head(ci_clean)
```

```{r}
## Locading the encoded data sets
# Intial Survey
initial_enc <- read.csv("data_cleaning/datasets_encoded/initial_encoded.csv",
                          na.strings=c("","NA"))
# Pre-connection
initial_pre_enc <- initial_enc %>%
                    filter(status == 1)
# Pre-connection
initial_post_enc <- initial_enc %>%
                    filter(status == 2)

head(initial_enc)
head(initial_pre_enc)
head(initial_post_enc)

# Household Post-Survey
post_enc <- read.csv("data_cleaning/datasets_encoded/post_encoded.csv",
                          na.strings=c("","NA"))
post_enc <- merge(post_enc, consumption,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
# Post-Connection
# post_clean_enc <- post_enc %>% filter(tariff == "residential")
head(post_enc)
# head(post_clean_enc)

# Commercial & Insitution Post-Survey
ci_enc <- read.csv("data_cleaning/datasets_encoded/ci_post_encoded.csv",
                          na.strings=c("","NA")) 
ci_enc <- merge(ci_enc, consumption,
                 by.x = 'renewvia_id', 
                 by.y = 'Account.Number')
head(ci_enc)
```

```{r}
## Pairing pre and post responses
paired_temp <- merge(initial_pre, post_clean,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
paired_clean <- merge(paired_temp, consumption,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
head(paired_clean)


paired_temp_enc <- merge(initial_pre_enc, post_enc,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
paired_enc <- merge(paired_temp_enc, consumption,
                       by.x = 'renewvia_id', 
                       by.y = 'Account.Number')
head(paired_enc)
```

# Initial Descriptive

```{r}
# No. of observations by datasets
# % Missing Values for each variables
# No. of duplicates
```

# Utility Functions

## Data Visualization

```{r}
# For pie and bar charts
group_plot <- function(df, var_name, plot_title, plot_type) {
  var <- df[, var_name]
  var <- var[var != ""]
  
  data <- as.data.frame(t(table(var)))[,2:3] 
  setnames(data, 
           old = c('var','Freq'), 
           new = c('labels','counts'))

  
  if (plot_type == 'pie') {
      data_tab <- data %>% mutate(csum = rev(cumsum(rev(counts))),
                             pos = counts/2 + lead(csum, 1),
                             pos = if_else(is.na(pos), counts/2, pos),
                             percentage = counts/sum(counts))
      data_tab$labels <- as.factor(data_tab$labels)
      plot <- data_tab %>% ggplot(aes(x = "", y = counts, fill = labels)) +
                          geom_col(width = 1, color = 1) +
                          geom_label_repel(
                            aes(y = pos,
                                label = glue("{counts} ({percent(percentage)})"),
                                 fill = labels),
                                show.legend = FALSE) +
                          labs(fill = var_name, title=plot_title) +
                          coord_polar(theta = "y") +
                          theme_void()
  } else if (plot_type == "bar") {
      plot <- data %>% ggplot(aes(y=counts, 
                                  x=reorder(labels, counts), 
                                  fill=labels)) + 
                        geom_col(width = 0.7) +
                        geom_text(aes(label=counts), vjust=-0.3, size=3)+
                        labs(fill = var_name, title=plot_title) + 
                        coord_flip()
  }
  ## Histogram
  ## boxplot
  return(plot)
}

```

```{r}
compare_btw_dfs <- function(var_name, plot_type, subplot_type, title) {
  if(plot_type == "pre_post") {
      pre_plot <- group_plot(initial_pre, var_name, "Initial", subplot_type)
      post_plot <- group_plot(post_clean, var_name, "Post", subplot_type)
      plot <- ggarrange(pre_plot, post_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = TRUE,
                        legend="right")
      
      return(annotate_figure(plot, top = text_grob(title, 
                     color = "black", face = "bold", size = 20)))
  } 

}

compare_wth_df <- function(data, var1, var2, 
                            var1_title, var2_title, 
                            subplot_type, plot_title){
  var1_plot <- group_plot(data, var1, 
                          var1_title, subplot_type)
  var2_plot <- group_plot(data, var2, 
                          var2_title, subplot_type)
  plot <- ggarrange(var1_plot, var2_plot, 
                    ncol = 2, nrow = 1, 
                    common.legend = TRUE,
                    legend="right")
  return(annotate_figure(plot, top = text_grob(plot_title, 
                 color = "black", face = "bold", size = 20)))
}
```

## Hypothesis Testing

```{r}
hyp_testing <- function(data, test_type, var){
  #McNemar

#Paired t-Test

#Wilcoxon Signed-Rank Test

#Sign Test
  
}

```

## Regression Analysis

```{r}
regression_analysis <- function() {
  #Logistic 

#Linear
}
```

# 1- Gender Equality

## A) Descriptive

### Household

```{r}
# What was the gender breakdown of survey respondents, pre and post?
compare_btw_dfs(var_name="gender", plot_type="pre_post", 
        subplot_type="pie", title="Gender Breakdown")
```

```{r}
# What was school enrollment by gender pre-connection?
girls <- sum(initial_pre$girls_headcount,na.rm = TRUE)
girls_in_school <- sum(initial_pre$girls_schooling,na.rm = TRUE)
enrollment_rate <- percent(girls_in_school/girls, accuracy = 0.01)

vals <- c(girls, girls_in_school, enrollment_rate)

# creating matrix
tab <- as.data.frame(t(as.matrix(vals)))
setnames(tab, old = c('V1','V2', 'V3'), 
          new = c("Girls", "Girls.In.School", "Enrollment.Rate"))
tab
```

```{r}
# Was there a change in enrollment by gender afterwards?
compare_wth_df(data=post_clean, 
               var1="girls_schooling_change", 
               var2="boys_schooling_change", 
               var1_title="Girls", var2_title="Boys", 
               subplot_type="pie", plot_title="School Enrollment Change")
```

```{r}
# For those un-enrolled, what was the driving factor? Did the reason change post-survey?
girls_reasons_pre <- group_plot(initial_pre, "girls_unschooled_reasons", "Girls: Pre-Survey", "bar")
girls_reasons_post <- group_plot(post_clean, "girls_unschooled_reasons", "Girls: Post-Survey", "bar")
boys_reasons_pre <- group_plot(initial_pre, "boys_unschooled_reasons", "Boys: Pre-Survey", "bar")
boys_reasons_post <- group_plot(post_clean, "boys_unschooled_reasons", "Boys: Post-Survey", "bar")

remove_axes <- theme(
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank(),
  axis.title.x = element_blank(),
  axis.text.y = element_blank(),
  axis.ticks.y = element_blank(),
  axis.title.y = element_blank()
)

p <- list(
  girls_reasons_pre + remove_axes,
  girls_reasons_post + remove_axes,
  boys_reasons_pre + remove_axes,
  boys_reasons_post + remove_axes
)

plot <- ggarrange(plotlist = p,
                  ncol = 2,  nrow = 2, 
                  common.legend = TRUE,legend="bottom")
annotate_figure(plot,
                top = text_grob("Renewvia Surveys: Reasons for Unschooled Children",
               color = "black", face = "bold", size = 15))

# How were household chores distributed among male and female within households?
# In respondent's own words, how were women affected from the mini-grid?
```

### Commercial

```{r}
# How many new women-led businesses were created?

# How did women-led businesses' performance change?
```

## B) Inferential

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
var <- post_clean$girls_schooling_change
girls_enrollment <- var[var != ""]

tab1(girls_enrollment, 
     sort.group = "decreasing", cum.percent = TRUE)
```

```{r}
## Girls attending school
# Has there been a change in the number of females in your household who attend school full time since connection to mini-grid power?
# Isolate the dependent variable
var <- post_clean$girls_schooling_change
girls_enrollment <- var[var != ""]

tab1(girls_enrollment, 
     sort.group = "decreasing", cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          post_clean$community, 
                                          post_clean$girls_schooling_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

dep_vars <- reg_df[c(9:10)]
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Water Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "less than 1 hour" = 1; "1-2 hours" = 2; "2-3 hours" = 3; "3-4 hours" = 4; "greater than 4 hours" = 5

```{r}
# How long does the water collection process take on a daily basis?
## Wilcoxon Signed Rank Test
# Scores
# paired_enc <- paired_enc %>% filter(if_all(c(water_collection_time_pre,
#                                             water_collection_time_post), 
#                                            ~ !is.na(.)))
pre_scores <- paired_enc$water_collection_time_pre
post_scores <- paired_enc$water_collection_time_post


# Running the test
wilcox.test(pre_scores, post_scores, paired=TRUE)

# Visualize distribution of score differences
diff <- post_scores - pre_scores
hist(diff)
```

### Cooking Fuel Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "No need to collect fuel" = 1; "less than 1 hour" = 2; "1-2 hours" =3; "3-5 hours" = 4; "greater than 4 hours" = 5

```{r}
# How long does the cooking fuel collection process take on a daily basis?
## Sign Test
# Calculating differences
pre_scores <- paired_enc$cooking_fuel_collection_time_pre
post_scores <- paired_enc$cooking_fuel_collection_time_post
diff <- post_scores - pre_scores

# Running the test
signtest(diff, m=0, conf.level=0.95, exact=FALSE)

# Visualize distribution of score differences
hist(diff)
```

### Women-led Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

```{r}
# Are any household members business owners?
## McNemar's  Test
# Cross tabulation of changes of women business ownership
cross_tab <- table(paired_enc$business_owners_female_pre,
                   paired_enc$business_owners_female_post)
cross_tab

# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$biz_female_change <- paired_enc$business_owners_female_pre - paired_enc$business_owners_female_post

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$biz_female_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### New Female workers

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
# If you answered yes to adding new workers, how many new employees are female?
```

# 2- Productivity

## A) Descriptive

### Household

```{r}
# Has the number of electronic devices or appliances increased since connection to minigrid?
# 
# Have you added any of the following Electronic Devices or Appliances after you were connected to minigrid (POST connection) Select all that apply
# 
# How far must you travel to charge your mobile phone?
# 
# How often do you need to charge your mobile phone?
# 
# How much do you pay per month to charge your mobile phone?
# 
# How far must you travel to obtain your water supply?
# 
# How long does the cooking fuel collection process take on a daily basis?
# 
# How long does the water collection process take on a daily basis?
# 
# Has your (or your spouses) occupation changed since youve been connected to minigrid power?
# 
# Have you added any new products or services since connection to Renewvia minigrid?
# 
# If this business is new, do you consider this new business a result of having access to minigrid power?
# 
# Is this business recent (started after connection to minigrid power?)
```

### Commercial

```{r}
# Is this business, clinic, school still in operation?
# 
# Please select your business type
# 
# Since connection to Renewvia mingrid, have you had any change in number of workers/employees at your place of work?
# 
# Since connection to Renewvia minigrid, have your hours of operation changed at all?
# 
# Type of employment for Primary Provider
# 
# What is approximate monthly cost of energy used strictly for charging appliances?
# 
# What is the approximate monthly cost of energy used strictly for charging appliances?
# 
# What is the approximate monthly cost of energy used strictly for cooking?
# 
# What is your average monthly household income:
```

## B) Inferential

### Light Hours

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value between 0 and 24

```{r}
## How many hours of light per day do you currently have at home?
# Running the paired t-test
light_hours_pre <- paired_clean$light_hours_current_pre
light_hours_post <- paired_clean$light_hours_current_post
t.test(light_hours_pre, light_hours_post,
       paired = TRUE, alternative = "two.sided")
```

### Business Operation Hours

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
## Since connection to Renewvia mini-grid, have your hours of operation changed at all?
# Isolate the dependent variable
var <- ci_clean$operations_hours_change
work_hours <- var[var != ""]

tab1(work_hours, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          ci_clean$community, 
                                          ci_clean$operations_hours_change),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test with outlier: kalobeyei_settlement
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_they_have_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_they_have_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_they_have_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_they_have_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Schools - Academic Performance

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
## Have you seen a change in overall school performance?
# Isolate the dependent variable
var <- ci_clean$school_performance
ci_school_performance <- var[var != ""]

tab1(ci_school_performance, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          ci_clean$community, 
                                          ci_clean$school_performance),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data

## Linear Regression t-Test

reg <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes_overall_school_performance_is_better ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_overall_school_performance_is_better)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg)
```

### Household - Academic Performance

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

```{r}
# Isolate the dependent variable
var <- post_clean$school_performance_change
hs_school_performance <- var[var != ""]

tab1(hs_school_performance, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          post_clean$community, 
                                          post_clean$school_performance_change),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test with outlier: kalobeyei_settlement
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes_its_gotten_better ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_gotten_better)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

# reg_decrease <- function(feature) {
#   ## Fitting the model with reported increase
#   # PV Size (kwH)
#   lm <- lm(yes_its_gotten_worse ~ feature, data=reg_df)
#   print(summary(lm))
#   
#   # Visualizing
#   scatter <- ggplot(data = reg_df, 
#                     aes(feature, yes_its_gotten_worse)) + 
#                     geom_point(color='blue') +
#                     geom_smooth(color='red', method = "lm", se = FALSE) 
#                     theme_classic()
#   ggMarginal(scatter, type = "histogram",
#              xparams = list(fill = 4),
#              yparams = list(fill = 3))
# }

sapply(ind_vars, reg_increase)
# sapply(ind_vars, reg_decrease)
```

# 3- Health

## A) Descriptive

### Household

```{r}

```

```{r}

```

```{r}
# What is your clean community water source?
# What is your clean water source?
# What is your source of water?
# Do you have a source for clean drinking water?
# How much do you pay per month for water?
# What is the source for clean drinking water?
```

```{r}
# Has the number of kerosene lamps in your household changed since connection to minigrid?
# How many kerosene lamps do you currently have in your household?
# How many kerosene lamps do you currently use in your household? (before grid connection)
# How many kerosene lamps do you currently use in your household? (POST minigrid connection)
# How much do you pay monthly for kerosene used only in kerosene lamps?
```

```{r}
# What hours is the Health Center / Clinic open?
# Does your Health Center / Clinic have access to refrigeration?
# Does your Health Center have access to electricity?
# Does your Health Center have access to minigrid electricity?
# How close is the nearest Health Center / Clinic
# How close is the nearest Health Center/Clinic?

```

```{r}
# In what way has minigrid power impacted your life or the life of your family members?
```

### Commercial

```{r}
# For clinics or health services only: Since connection to Renewvia minigrid, have your health service offerings changed in any of the following ways: (select all that apply).
# What is the Clinic / Hospital able to offer or provide due to connection to Renewvia minigrid that it wasnt able to offer before?
# What services are you able to offer/sell/provide due to connection to Renewvia minigrid that you werent able to offer prior to connection?
```

## B) Inferential

### Health Services Offerings

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

```{r}
## For clinics or health services only: Since connection to Renewvia mini-grid, have your health service offerings changed in any of the following ways: (select all that apply).
# Breakdown by response type and Community
dep_var_mat <- ci_clean %>%
                  group_by(community) %>%
                  summarise(new_health_services = sum(
                    health_offering_change_count))

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data %>% replace(is.na(.), 0)
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test

reg <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(new_health_services ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, new_health_services)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg)
```

### Clinic Access To Refrigeration

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Does your Health Center / Clinic have access to refrigeration?
## McNemar's  Test
# Cross tabulation of changes of women business ownership
var_pre <- paired_enc$clinic_refrigeration_access_pre
var_post <- paired_enc$clinic_refrigeration_access_post
cross_tab <- table(var_pre,var_post)
cross_tab

# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$clinic_electricity_change <- var_pre - var_post

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$clinic_electricity_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Better access to healthcare

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you feel that you have better access to health services because of connection to mini-grid?
# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_clean$community_post, 
                                          paired_clean$better_access_health_minigrid),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data %>% replace(is.na(.), 0)
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test

reg <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg)
```

### Access to clean drinking water

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

```{r}
## Do you have a source for clean drinking water?
## McNemar's  Test
# Cross tabulation of changes of women business ownership
var_pre <- paired_enc$clean_drinking_water_pre
var_post <- paired_enc$clean_drinking_water_post
cross_tab <- table(var_pre,var_post)
cross_tab

# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$clean_water_change <- var_pre - var_post

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$clean_water_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Clean drinking water access - change

**Data Source**: C&I Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Since connection to Renewvia mini-grid, has your access to clean drinking water changed at all?
# Isolate the dependent variable
var <- ci_clean$clean_drinking_water_access
hs_school_performance <- var[var != ""]

tab1(hs_school_performance, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          ci_clean$community, 
                                          ci_clean$clean_drinking_water_access),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test with outlier: kalobeyei_settlement
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes_it_has_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_it_has_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}
sapply(ind_vars, reg_increase)
# sapply(ind_vars, reg_decrease)
```

### Kerosene Lamps Count

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## How many kerosene lamps do you currently use in your household?
# Running the paired t-test
kerosene_pre <- paired_clean$kerosene_lamps_count_pre
kerosene_post <- paired_clean$kerosene_lamps_count_post
t.test(kerosene_pre, kerosene_post,
       paired = TRUE, alternative = "two.sided")

```

### Kerosene Lamps Count - Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Has the number of kerosene lamps in your household changed since connection to mini-grid
# Isolate the dependent variable
var <- post_clean$kerosene_lamp_usage_change
kerosene_usage <- var[var != ""]

tab1(kerosene_usage, 
     sort.group = "decreasing", cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(
  as.data.frame.matrix(prop.table(table(post_clean$community, 
                                   post_clean$kerosene_lamp_usage_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, 
                                    y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)

```

```{r}
# Does your Health Center have access to electricity?
```

# 4- Safety

## A) Descriptive

```{r}
# Do you feel that having access to minigrid power has made you more safe? Please explain
# Do you feel that having access to minigrid power has made you more safe? Please explain->
# Do you feel that you have better access to health services because of connection to minigrid?
# What makes you feel the most unsafe?
# How safe do you feel outside your home when it is dark?
```

```{r}
# Does your community currently have outdoor community lights?
# Does your home have exterior lighting?
# How safe would you feel outside your home at nighttime IF you had exterior lights/community lighting?
# How safe would you feel outside your home at nighttime IF you had exterior lights?
# Is this exterior lighting powered by minigrid?
```

```{r}
# How did the feeling of safety change? For everyone? By Gender? By country? By Community?
# Average scores for everyone and split between men and women
women_initial_pre <- (initial_pre_enc %>% filter(gender == 1))$feel_safe_dark
women_initial_post <- (initial_post_enc %>% filter(gender == 1))$feel_safe_dark
women_post_survey <- (post_enc %>% filter(gender == 1))$feel_safe_dark
women_post_all <- c(women_intial_post, women_post_survey)
avg_scores <- c(mean(women_initial_pre, na.rm = TRUE), 
                mean(women_initial_post, na.rm = TRUE),
                mean(women_post_survey, na.rm = TRUE),
                mean(women_post_all, na.rm = TRUE))

# safety_scores <- paired_women[ , c("renewvia_id", 
#                                    "feel_safe_dark_pre",
#                                    "feel_safe_dark_post")]
# safety_scores_long <- melt(safety_scores, id = "renewvia_id")
# ggplot(safety_scores_long, 
#        aes(x = variable, y = value)) +  # ggplot function
#   geom_boxplot()
```

## B) Inferential

### Feeling Safe

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Very unsafe" = 1; "Somewhat unsafe" = 2; "Neither safe nor unsafe"= 3; "Somewhat safe" = 4; "Very safe" = 5

```{r}
# How safe do you feel outside your home when it is dark?
pre_scores <- paired_enc$feel_safe_dark_pre
post_scores <- paired_enc$feel_safe_dark_post
diff <- post_scores - pre_scores

# Running the test
# wilcox.test(pre_scores, post_scores, paired=TRUE)
signtest(diff, m=0, conf.level=0.95, exact=FALSE)

# Visualize distribution of score differences
hist(diff)
```

```{r}
# What makes you feel the most unsafe?
# 
# Does your community currently have outdoor community lights?
# 
# How safe would you feel outside your home at nighttime IF you had exterior lights?
```

# 5- Economic Activity

## A) Descriptive

### Household

```{r}
# Type of employment for Primary Provider
# What is your average monthly household income:
# Has your household income changed since your connection to minigrid power?
# Has your (or your spouses) occupation changed since youve been connected to minigrid power?
```

```{r}
# What is approximate monthly cost of energy used strictly for charging appliances?
# 
# What is the approximate monthly cost of energy used strictly for charging appliances?
# 
# What is the approximate monthly cost of energy used strictly for cooking?

```

```{r}
# Are any household members business owners?
# Is this business recent (started after connection to minigrid power?)
# If this business is new, do you consider this new business a result of having access to minigrid power?
# Is this business, clinic, school still in operation?
# Please select your business type
```

### Commercial

```{r}
# Is this business, clinic, school still in operation?
# 
# Please select your business type
# 
# Since connection to Renewvia mingrid, have you had any change in number of workers/employees at your place of work?
# 
# Since connection to Renewvia minigrid, have your hours of operation changed at all?

# Have you added any new products or services since connection to Renewvia minigrid?
```

## B) Inferential

### Income

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

```{r}
## What is your average monthly household income?
# Running the paired t-test
ct <- "nigeria"
ct
df <- paired_clean %>% filter(country_post == ct)
income_pre <- df$avg_household_income_pre
income_post <- df$avg_household_income_post
t.test(income_pre, income_post,
       paired = TRUE, alternative = "two.sided")
```

```{r}
ct <- "kenya"
ct
df <- paired_clean %>% filter(country_post == ct)
income_pre <- df$avg_household_income_pre
income_post <- df$avg_household_income_post
t.test(income_pre, income_post,
       paired = TRUE, alternative = "two.sided")
```

### Income Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

```{r}
## Has your household income changed since your connection to mini-grid power?
# Isolate the dependent variable
var <- post_clean$household_income_change
income_change <- var[var != ""]

tab1(income_change, 
     sort.group = "decreasing", cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(
  as.data.frame.matrix(prop.table(table(post_clean$community, 
                                   post_clean$household_income_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_it_has_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_it_has_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_it_has_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_it_has_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

```{r}
# For businesses or shop owners only: Since connection to Renewvia mini-grid, have you seen any change in your weekly or monthly earnings?
```

### Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

```{r}
# Are any household members business owners?
## McNemar's Test
# Cross tabulation of changes between business ownership
cross_tab <- table(paired_enc$business_owners_binary_pre,
                   paired_enc$business_owners_binary_post)
cross_tab
# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$biz_change <- paired_enc$business_owners_binary_post - paired_enc$business_owners_binary_pre

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$biz_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Workplace

```{r}
# Since connection to Renewvia mini-grid, have you had any change in number of workers/employees at your place of work?
```
