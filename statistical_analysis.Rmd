---
title: "Renewvia - Survey Impact Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# OVERVIEW: HYPOTHESIS TESTING

**Strategy**:

-   For the paired data set, we will use the Paired t-Test, Wilcoxon Signed Rank Test, Sign Test, and McNemar's Test whenever applicable

-   Our independent variables will be the following: PV Size (kWh), No. of Customers, CAPEX (USD) and Consumption (Community & Customer).

-   For each dependent variables, we will run a uni-variate regression tests with each of independent variable. When applicable, we will have a Linear regression t-Test or Logistic regression Wald test

# Input Data

```{r}
# Importing libraries
library(ggplot2)
library(dplyr)
library(lessR)
library(tidyr)
library(ggpubr)
library(exact2x2)
library(stringr)
library(janitor)
library(epiDisplay)
library(nonpar)
library(tibble)
library(ggExtra)
library(vtree)
library(CGPfunctions)
library(psych)
library(scales)
```

```{r}
## Locading the project& consumption data
projects <- read.csv("project_data.csv")
consumption <- read.csv("customer_consumption.csv")
head(projects)
head(consumption)
```

```{r}
## Locading the cleaned data sets
# Intial Survey
initial_clean <- read.csv("data_cleaning/datasets_clean/initial_clean.csv")

# Pre-connection
initial_pre <- initial_clean %>%
                    filter(status == "pre_connection")

# Post-connection
initial_post <- initial_clean %>%
                    filter(status == "post_connection") 

head(initial_clean)
head(initial_pre)
head(initial_post)

# Household Post-Survey
post_clean <- read.csv("data_cleaning/datasets_clean/post_clean.csv")
head(post_clean)

# Commercial & Insitution Post-Survey
ci_clean <- read.csv("data_cleaning/datasets_clean/ci_post_clean.csv")
head(ci_clean)

```

```{r}
colnames(initial_clean)
```

```{r}
## Locading the encoded data sets
# Intial Survey
initial_enc <- read.csv("data_cleaning/datasets_encoded/initial_encoded.csv")

# Pre-connection
initial_pre_enc <- initial_enc %>%
                    filter(status == 1)
# Pre-connection
initial_post_enc <- initial_enc %>%
                    filter(status == 2)

head(initial_enc)
head(initial_pre_enc)
head(initial_post_enc)

# Household Post-Survey
post_enc <- read.csv("data_cleaning/datasets_encoded/post_encoded.csv")
# Post-Connection
# post_clean_enc <- post_enc %>% filter(tariff == "residential")
head(post_enc)
# head(post_clean_enc)

# Commercial & Insitution Post-Survey
ci_enc <- read.csv("data_cleaning/datasets_encoded/ci_post_encoded.csv") 
head(ci_enc)
```

```{r}
## Pairing pre and post responses
paired_clean <- merge(initial_pre, post_clean,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
head(paired_clean)

paired_enc <- merge(initial_pre_enc, post_enc,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
head(paired_enc)
```

# 1- Gender Equality

## A) EDA

### What was the gender breakdown of survey respondents, pre and post?

```{r}
# var <- initial_clean$gender
# gdr <- var[var != ""]
plot_pie <- function(df, period) {
  data <- df %>% 
            filter(gender != "") %>%
            group_by(gender) %>% 
            count() %>% 
            ungroup() %>% 
            mutate(per=`n`/sum(`n`)) %>% 
            arrange(desc(gender))
  
  data$label <- scales::percent(data$per)
  
  pie_plot <- ggplot(data=data)+
              geom_bar(aes(x="", y=per, fill=gender), 
                       stat="identity", width = 1)+
              coord_polar("y", start=0)+
              theme_void()+
              geom_text(aes(x=1, y = cumsum(per) - per/2, label=label)) +
              labs(title = period)
  return(pie_plot)
}

pre_plot <- plot_pie(initial_clean, "Initial")
post_plot <- plot_pie(post_clean, "Post")
plot <- ggarrange(pre_plot, post_plot, ncol = 2, 
                  nrow = 1, common.legend = TRUE,legend="right")
annotate_figure(plot, top = text_grob("Renewvia Survey - Gender Breakdown", 
               color = "black", face = "bold", size = 20))
```

### What was school enrollment by gender pre-connection?

```{r}
girls <- sum(initial_pre$girls_headcount,na.rm = TRUE)
girls_in_school <- sum(initial_pre$girls_schooling,na.rm = TRUE)
enrollment_rate <- (girls_in_school/girls)*100
sprintf("In the intial survey, respondents reported %d girls of which %d girls attending school, thus placing the enrollment rate at: %.2f%%", girls, girls_in_school, enrollment_rate)
```

### Was there a change in enrollment by gender afterwards?

```{r}
tab_tree <- function(df, var, var_title) {
  var_filt <- var[var != ""]

  tree <- vtree(df, var, vp=TRUE, 
                title = var_title, horiz = FALSE)
  return(tree)
}
  
tab_tree(post_clean, "girls_schooling_change", "Post-Survey Respondents")
```

### For those un-enrolled, what was the driving factor? Did the reason change post-survey?

```{r}
group_tab <- function(var, title){
  var <- var[var != ""]
  change_tab <- tab1(var,
                   sort.group = "decreasing",
                   main=title, cum.percent = FALSE,
                   horiz=FALSE, cex.axis=0.8, 
                   cex.lab=0.8, cex.name=0.8)
  return(change_tab)
}

group_tab(initial_pre$girls_unschooled_reasons,
          "Pre-Connection - Reasons For Un-schooled Girls")

group_tab(post_clean$girls_unschooled_reasons,
          "Post-Connection - Reasons For Un-schooled Girls")
```

### How many new women-led businesses were created?

### How did women-led businesses' performance change?

### How were household chores distributed among male and female within households?

### In respondent's own words, how were women affected from the mini-grid?

## B) Hypothesis Testing

### Has there been a change in the number of females in your household who attend school full time since connection to mini-grid power?

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and increase in girls enrollment

-   ${H_1}$ = A relationship between any independent variable (as described above) and increase in girls enrollment

```{r}
var <- post_clean$girls_schooling_change
girls_enrollment <- var[var != ""]

tab1(girls_enrollment, 
     sort.group = "decreasing", cum.percent = TRUE)
```

```{r}
# Isolate the dependent variable
var <- post_clean$girls_schooling_change
girls_enrollment <- var[var != ""]

tab1(girls_enrollment, 
     sort.group = "decreasing", cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          post_clean$community, 
                                          post_clean$girls_schooling_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

dep_vars <- reg_df[c(9:10)]
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### How long does the water collection process take on a daily basis?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "less than 1 hour" = 1; "1-2 hours" = 2; "2-3 hours" = 3; "3-4 hours" = 4; "greater than 4 hours" = 5

**Hypothesis Testing:**

-   ${H_0}$ = No difference between pre and post scores assigned to water collection time

-   ${H_1}$ = A significant difference between pre and post scores assigned to water collection time

```{r}
## Wilcoxon Signed Rank Test
# Scores
# paired_enc <- paired_enc %>% filter(if_all(c(water_collection_time_pre,
#                                             water_collection_time_post), 
#                                            ~ !is.na(.)))
pre_scores <- paired_enc$water_collection_time_pre
post_scores <- paired_enc$water_collection_time_post


# Running the test
wilcox.test(pre_scores, post_scores, paired=TRUE)

# Visualize distribution of score differences
diff <- post_scores - pre_scores
hist(diff)
```

### How long does the cooking fuel collection process take on a daily basis?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "No need to collect fuel" = 1; "less than 1 hour" = 2; "1-2 hours" =3; "3-5 hours" = 4; "greater than 4 hours" = 5

**Hypothesis Testing:**

-   ${H_0}$ = No difference between pre and post scores assigned to cooking fuel collection time

-   ${H_1}$ = A significant difference between pre and post scores assigned to cooking fuel collection time

```{r}
## Sign Test
# Calculating differences
pre_scores <- paired_enc$cooking_fuel_collection_time_pre
post_scores <- paired_enc$cooking_fuel_collection_time_post
diff <- post_scores - pre_scores

# Running the test
signtest(diff, m=0, conf.level=0.95, exact=FALSE)

# Visualize distribution of score differences
hist(diff)
```

### Are any household members business owners?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

**Hypothesis Testing:**

-   ${H_0}$ = No difference between pre and post number of local female business owners

-   ${H_1}$ = A significant difference between pre and post number of local female business owners

```{r}
## McNemar's  Test
# Cross tabulation of changes of women business ownership
cross_tab <- table(paired_enc$business_owners_female_pre,
                   paired_enc$business_owners_female_post)
cross_tab

# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$biz_female_change <- paired_enc$business_owners_female_pre - paired_enc$business_owners_female_post

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$biz_female_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### If you answered yes to adding new workers, how many new employees are female?

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and number of new female employees

-   ${H_1}$ = A relationship between any independent variable (as described above) and number of new female employees

```{r}

```

# 2- Productivity

### How many hours of light per day do you currently have at home?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value between 0 and 24

**Hypothesis Testing:**

-   ${H_0}$ = No difference between pre and post light hours

-   ${H_1}$ = A significant difference between pre and post light hours

```{r}
# Running the paired t-test
light_hours_pre <- paired_clean$light_hours_current_pre
light_hours_post <- paired_clean$light_hours_current_post
t.test(light_hours_pre, light_hours_post,
       paired = TRUE, alternative = "two.sided")
```

### Since connection to Renewvia mini-grid, have your hours of operation changed at all?

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and increase in local businesses' hours of operations

-   ${H_1}$ = A relationship between any independent variable (as described above) and increase in local businesses' hours of operations

```{r}
# Isolate the dependent variable
var <- ci_clean$operations_hours_change
work_hours <- var[var != ""]

tab1(work_hours, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          ci_clean$community, 
                                          ci_clean$operations_hours_change),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test with outlier: kalobeyei_settlement
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_they_have_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_they_have_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_they_have_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_they_have_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Have you seen a change in overall school performance?

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and school performance by schools

-   ${H_1}$ = A relationship between any independent variable (as described above) and school performance by schools

```{r}
# Isolate the dependent variable
var <- ci_clean$school_performance
ci_school_performance <- var[var != ""]

tab1(ci_school_performance, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          ci_clean$community, 
                                          ci_clean$school_performance),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data

## Linear Regression t-Test

reg <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes_overall_school_performance_is_better ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_overall_school_performance_is_better)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg)
```

### Has school performance changed since connection to mini-grid?

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and school performance by households

-   ${H_1}$ = A relationship between any independent variable (as described above) and school performance by households

```{r}
# Isolate the dependent variable
var <- post_clean$school_performance_change
hs_school_performance <- var[var != ""]

tab1(hs_school_performance, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          post_clean$community, 
                                          post_clean$school_performance_change),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test with outlier: kalobeyei_settlement
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes_its_gotten_better ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_gotten_better)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

# reg_decrease <- function(feature) {
#   ## Fitting the model with reported increase
#   # PV Size (kwH)
#   lm <- lm(yes_its_gotten_worse ~ feature, data=reg_df)
#   print(summary(lm))
#   
#   # Visualizing
#   scatter <- ggplot(data = reg_df, 
#                     aes(feature, yes_its_gotten_worse)) + 
#                     geom_point(color='blue') +
#                     geom_smooth(color='red', method = "lm", se = FALSE) 
#                     theme_classic()
#   ggMarginal(scatter, type = "histogram",
#              xparams = list(fill = 4),
#              yparams = list(fill = 3))
# }

sapply(ind_vars, reg_increase)
# sapply(ind_vars, reg_decrease)
```

# 3- Health

### For clinics or health services only: Since connection to Renewvia mini-grid, have your health service offerings changed in any of the following ways: (select all that apply).

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and number of new health services offered

-   ${H_1}$ = A relationship between any independent variable (as described above) and number of new health services offered

```{r}
# Breakdown by response type and Community
dep_var_mat <- ci_clean %>%
                  group_by(community) %>%
                  summarise(new_health_services = sum(
                    health_offering_change_count))

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data %>% replace(is.na(.), 0)
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test

reg <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(new_health_services ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, new_health_services)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg)
```

### Does your Health Center / Clinic have access to refrigeration?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and reported clinic access to refrigeration

-   ${H_1}$ = A relationship between any independent variable (as described above) and reported clinic access to refrigeration

```{r}
## McNemar's  Test
# Cross tabulation of changes of women business ownership
var_pre <- paired_enc$clinic_refrigeration_access_pre
var_post <- paired_enc$clinic_refrigeration_access_post
cross_tab <- table(var_pre,var_post)
cross_tab

# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$clinic_electricity_change <- var_pre - var_post

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$clinic_electricity_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Do you feel that you have better access to health services because of connection to mini-grid?

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and access to better healthcare

-   ${H_1}$ = A relationship between any independent variable (as described above) and access to better healthcare

```{r}
# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_clean$community_post, 
                                          paired_clean$better_access_health_minigrid),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data %>% replace(is.na(.), 0)
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test

reg <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg)
```

### Do you have a source for clean drinking water?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and access to clean water

-   ${H_1}$ = A relationship between any independent variable (as described above) and access to clean water

```{r}
## McNemar's  Test
# Cross tabulation of changes of women business ownership
var_pre <- paired_enc$clean_drinking_water_pre
var_post <- paired_enc$clean_drinking_water_post
cross_tab <- table(var_pre,var_post)
cross_tab

# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$clean_water_change <- var_pre - var_post

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$clean_water_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Since connection to Renewvia mini-grid, has your access to clean drinking water changed at all?

**Data Source**: C&I Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and increase in access to clean drinking water for C&I

-   ${H_1}$ = A relationship between any independent variable (as described above) and increase in access to clean drinking water for C&I

```{r}
# Isolate the dependent variable
var <- ci_clean$clean_drinking_water_access
hs_school_performance <- var[var != ""]

tab1(hs_school_performance, 
     sort.group = "decreasing", 
     cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          ci_clean$community, 
                                          ci_clean$clean_drinking_water_access),
                                         margin = 1)
                                                  )
                                      , var = "community")

community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test with outlier: kalobeyei_settlement
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  lm <- lm(yes_it_has_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_it_has_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}
sapply(ind_vars, reg_increase)
# sapply(ind_vars, reg_decrease)
```

### How many kerosene lamps do you currently use in your household?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

**Hypothesis Testing:**

-   ${H_0}$ = No difference between pre and post number of kerosene lamps used

-   ${H_1}$ = A significant difference between pre and post number of kerosene lamps used

```{r}
# Running the paired t-test
kerosene_pre <- paired_clean$kerosene_lamps_count_pre
kerosene_post <- paired_clean$kerosene_lamps_count_post
t.test(kerosene_pre, kerosene_post,
       paired = TRUE, alternative = "two.sided")

```

### Has the number of kerosene lamps in your household changed since connection to mini-grid

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and decrease in kerosene lamps usage

-   ${H_1}$ = A relationship between any independent variable (as described above) and decrease in kerosene lamps usage

```{r}
# Isolate the dependent variable
var <- post_clean$kerosene_lamp_usage_change
kerosene_usage <- var[var != ""]

tab1(kerosene_usage, 
     sort.group = "decreasing", cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(
  as.data.frame.matrix(prop.table(table(post_clean$community, 
                                   post_clean$kerosene_lamp_usage_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, 
                                    y=dep_var_mat, by="community")
reg_df <- community_data
reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_its_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_its_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### TODO

-   Does your Health Center have access to electricity?

# 4- Safety

## A) EDA

### How did the feeling of safety change? For everyone? By Gender? By country? By Community?

```{r}
# Average scores for everyone and split between men and women
women_initial_pre <- (initial_pre_enc %>% filter(gender == 1))$feel_safe_dark
women_initial_post <- (initial_post_enc %>% filter(gender == 1))$feel_safe_dark
women_post_survey <- (post_enc %>% filter(gender == 1))$feel_safe_dark
women_post_all <- c(women_intial_post, women_post_survey)
avg_scores <- c(mean(women_initial_pre, na.rm = TRUE), 
                mean(women_initial_post, na.rm = TRUE),
                mean(women_post_survey, na.rm = TRUE),
                mean(women_post_all, na.rm = TRUE))

# safety_scores <- paired_women[ , c("renewvia_id", 
#                                    "feel_safe_dark_pre",
#                                    "feel_safe_dark_post")]
# safety_scores_long <- melt(safety_scores, id = "renewvia_id")
# ggplot(safety_scores_long, 
#        aes(x = variable, y = value)) +  # ggplot function
#   geom_boxplot()
```

## B) Hypothesis Testing

### How safe do you feel outside your home when it is dark?

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Very unsafe" = 1; "Somewhat unsafe" = 2; "Neither safe nor unsafe"= 3; "Somewhat safe" = 4; "Very safe" = 5

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and increase in feeling of safety

-   ${H_1}$ = A relationship between any independent variable (as described above) and increase in feeling of safety

```{r}
pre_scores <- paired_enc$feel_safe_dark_pre
post_scores <- paired_enc$feel_safe_dark_post
diff <- post_scores - pre_scores

# Running the test
# wilcox.test(pre_scores, post_scores, paired=TRUE)
signtest(diff, m=0, conf.level=0.95, exact=FALSE)

# Visualize distribution of score differences
hist(diff)
```

### TODO

-   What makes you feel the most unsafe?

-   Does your community currently have outdoor community lights?

-   How safe would you feel outside your home at nighttime IF you had exterior lights?

## 5- Economic Activity

## A) EDA

### What was the distribution of respondents' income levels?

1.  Report the mean, standard deviation, and quartiles of our surveyed sample, broken down by pre- and post-connection.

2.  Report the expectation with 95% confidence interval of the population mean using the t-statistic.

3.  Repeat the above excluding zeros from the data.

### What is your average monthly household income?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

**Hypothesis Testing:**

-   ${H_0}$ = No difference between pre and post average household income

-   ${H_1}$ = A significant difference between pre and post average household income

```{r}
# Running the paired t-test
ct <- "nigeria"
ct
df <- paired_clean %>% filter(country_post == ct)
income_pre <- df$avg_household_income_pre
income_post <- df$avg_household_income_post
t.test(income_pre, income_post,
       paired = TRUE, alternative = "two.sided")
```

```{r}
ct <- "kenya"
ct
df <- paired_clean %>% filter(country_post == ct)
income_pre <- df$avg_household_income_pre
income_post <- df$avg_household_income_post
t.test(income_pre, income_post,
       paired = TRUE, alternative = "two.sided")
```

### Has your household income changed since your connection to mini-grid power?

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

**Hypothesis Testing:**

-   ${H_0}$ = No relationship between any independent variable (as described above) and decrease in household income change

-   ${H_1}$ = A relationship between any independent variable (as described above) and decrease in household income change

```{r}
# Isolate the dependent variable
var <- post_clean$household_income_change
income_change <- var[var != ""]

tab1(income_change, 
     sort.group = "decreasing", cum.percent = TRUE)

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(
  as.data.frame.matrix(prop.table(table(post_clean$community, 
                                   post_clean$household_income_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
# reg_df <- community_data %>% filter(community != "kalobeyei_settlement")

ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_it_has_increased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_it_has_increased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(yes_it_has_decreased ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, yes_it_has_decreased)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### Are any household members business owners?

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

**Hypothesis Testing:**

-   ${H_0}$ = No difference between pre and post presence of new local business owners

-   ${H_1}$ = A significant difference between pre and post presence of new local business owners

```{r}
## McNemar's Test
# Cross tabulation of changes between business ownership
cross_tab <- table(paired_enc$business_owners_binary_pre,
                   paired_enc$business_owners_binary_post)
cross_tab
# Running the test
mcnemar.test(cross_tab)

# Change
paired_enc$biz_change <- paired_enc$business_owners_binary_post - paired_enc$business_owners_binary_pre

# Breakdown by response type and Community
dep_var_mat <- rownames_to_column(as.data.frame.matrix(
                                      prop.table(table(
                                          paired_enc$community_post, 
                                          paired_enc$biz_change),
                                         margin = 1)
                                                  )
                                      , var = "community")
community_data <- merge(x=projects, y=dep_var_mat, by="community")
reg_df <- community_data
names(reg_df)[7] <- "var_decrease"
names(reg_df)[8] <- "var_neutral"
names(reg_df)[9] <- "var_increase"
# 
ind_vars <- reg_df[c(4:6)]

## Linear Regression t-Test 
# Model with increase
reg_increase <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_increase ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_increase)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

reg_decrease <- function(feature) {
  ## Fitting the model with reported increase
  # PV Size (kwH)
  lm <- lm(var_decrease ~ feature, data=reg_df)
  print(summary(lm))
  
  # Visualizing
  scatter <- ggplot(data = reg_df, 
                    aes(feature, var_decrease)) + 
                    geom_point(color='blue') +
                    geom_smooth(color='red', method = "lm", se = FALSE) 
                    theme_classic()
  ggMarginal(scatter, type = "histogram",
             xparams = list(fill = 4),
             yparams = list(fill = 3))
}

sapply(ind_vars, reg_increase)
sapply(ind_vars, reg_decrease)
```

### TODO

-   For businesses or shop owners only: Since connection to Renewvia mini-grid, have you seen any change in your weekly or monthly earnings?

-   Since connection to Renewvia mini-grid, have you had any change in number of workers/employees at your place of work?
