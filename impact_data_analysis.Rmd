---
title: "Renewvia - Survey Impact Analysis"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# Overview

## Descriptive

-   Summary statistics

-   Visualization with graphs/charts

## **Inferential**

-   For the paired data set, we will use the following

    -   Paired t-Test for ratio

    -   Wilcoxon Signed Rank Test (Sign Test if asymmetric) for ordinal variables

    -   McNemar Test for Pre-Post binary responses

-   Our independent variables will be at two levels:

    -   Community: PV Size (kWh), No. of Customers, CAPEX (USD)

    -   Individual: Avg. Monthly Energy Consumption (kWh)

-   For each dependent variables, we will run a uni-variate regression tests with each of independent variable. When applicable, we will have a Linear regression t-Test or Logistic regression Wald test

# Libraries

```{r results='hide', message=FALSE, warning=FALSE}
# Importing libraries
options(warn=-1)
library(ggplot2)
library(dplyr)
library(lessR)
library(tidyr)
library(ggpubr)
library(exact2x2)
library(stringr)
library(epiDisplay)
library(tibble)
library(ggExtra)
library(vtree)
library(CGPfunctions)
library(psych)
library(nonpar)
library(scales)
library(tidyverse)
library(ggrepel)
library(data.table)
library(forcats)
library(glue)
library(aod)

library(caret)
library(corrplot)
```

# Input Data

## Community

```{r}
## Locading the project& consumption data
consumption_period <- read.csv("consumption_period.csv")
consumption_all <- read.csv("consumption_cumulative.csv")
customer_info <- read.csv("customers_info.csv")

tmp <- merge(customer_info, consumption_period, 
              by.x = 'customerAccountNumber',
              by.y = 'Account.Number')  
temp <- merge(tmp, consumption_all, 
              by.x = 'customerAccountNumber',
              by.y = 'Customer.Account.Number')
# temp_group <- temp %>% 
#                     group_by(projectName) %>% 
#                     summarise(consumption = sum(Energy.Consumption, na.rm=TRUE))
projects <- read.csv("project_data.csv")
# projects <- merge(projects, temp_group, by.x="project_name", by.y="projectName")
```

## Survey Clean Data sets

### Households

```{r}
## Intial Survey
initial <- read.csv("data_cleaning/datasets_clean/initial_clean.csv",
                          na.strings=c("","NA"))
initial_clean <- merge(initial, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre <- initial_clean %>%
                    filter(status == "pre_connection") 

# Post-connection
initial_post <- initial_clean %>%
                    filter(status == "post_connection") 

## Household Post-Survey
post <- read.csv("data_cleaning/datasets_clean/post_clean.csv",
                          na.strings=c("","NA"))
post_clean <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'customerAccountNumber')%>% 
                    filter(tariff == "Residential")

## Pairing pre and post responses
paired_clean <- merge(initial_pre, post_clean,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')

```

### Commercial & Institution

```{r}
## Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_clean/ci_post_clean.csv",
                          na.strings=c("","NA"))
ci_clean <- merge(ci, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'customerAccountNumber')
# head(ci_clean)
# Org Type
schools_clean <- ci_clean %>% filter(business_type == "school")
business_clean <- ci_clean %>% filter(business_type == "shops" | 
                                        business_type == "other_business")
institut_clean <- ci_clean %>% filter(business_type == "religious_institution")
clinic_clean <- ci_clean %>% filter(business_type == "clinic")
```

## Survey Encoded Data sets

### Households

```{r}
## Locading the encoded data sets
# Intial Survey
initial_enc <- read.csv("data_cleaning/datasets_encoded/initial_encoded.csv",
                          na.strings=c("","NA")) 
initial_enc <- merge(initial_enc, customer_info, 
                     by.x = 'renewvia_id', 
                     by.y = 'customerAccountNumber') %>% 
                    filter(tariff == "Residential")
# Pre-connection
initial_pre_enc <- initial_enc %>%
                    filter(status == 1)
# Pre-connection
initial_post_enc <- initial_enc %>%
                    filter(status == 2)

# Household Post-Survey
post <- read.csv("data_cleaning/datasets_encoded/post_encoded.csv",
                          na.strings=c("","NA"))
post_enc <- merge(post, temp,
                       by.x = 'renewvia_id', 
                       by.y = 'customerAccountNumber')  %>% 
                    filter(tariff == "Residential")

paired_enc <- merge(initial_pre_enc, post_enc,
                      suffix = c("_pre", "_post"),
                      by= 'renewvia_id')
```

### Commercial & Institution

```{r}
# Commercial & Insitution Post-Survey
ci <- read.csv("data_cleaning/datasets_encoded/ci_post_encoded.csv",
                          na.strings=c("","NA")) 
ci_enc <- merge(ci, temp,
                 by.x = 'renewvia_id', 
                 by.y = 'customerAccountNumber')

# Org Type
schools_enc <- ci_enc %>% filter(business_type == 3)
business_enc <- ci_enc %>% filter(business_type == 2 | business_type == 5)
institut_enc <- ci_enc %>% filter(business_type == 4)
clinic_enc <- ci_enc %>% filter(business_type == 1)
```

# Utility Functions

## Remove Outliers

```{r}
outliers_removal <- function(data, var) {
  quartiles <- quantile(data[, var], 
                        probs=c(.25, .75), na.rm = TRUE)
  
  IQR <- IQR(data[, var], na.rm = TRUE)
  
  Lower <- quartiles[1] - 1.5*IQR
  Upper <- quartiles[2] + 1.5*IQR 
  
  data <- subset(data, 
                 data[, var] > Lower &
                 data[, var] < Upper)
  return(data)
}
```

## Descriptive

```{r}
get_stats <- function(data_source, var_name,
                      remove_outliers = FALSE, 
                      exclude_zeros = FALSE) {
  if (remove_outliers == TRUE) {
    data <- outliers_removal(data=data_source, var=var_name)
  } 
  
  var <- data[, var_name]
  
  if (exclude_zeros == TRUE) {
    print("Removing Zeros")
    var <- var[var != 0]
  } 
  
  stats <- t(describe(var, IQR=TRUE, quant=c(.1,.25,.5,.75,.90),))
  print(t.test(var, conf.level = 0.95))
  print(stats)
}
```

## Data Visualization

### Remove x and y axes

```{r}
# Remove y-axis if deemed redundant
remove_y <- theme(
  axis.text.y = element_blank(),
  axis.ticks.y = element_blank(),
  axis.title.y = element_blank()
)
# Remove x-axis if deemed redundant
remove_x <- theme(
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank(),
  axis.title.x = element_blank()
)
```

### Plotting Graphs/Charts

```{r}
# For pie and bar charts
plot_func <- function(df, var_name, var_type, 
                      plot_title, lgd, plot_type, 
                      char_remove=NULL,
                      remove_outliers = FALSE,
                      x_axis=NULL, y_axis=NULL) {
  if(is.null(char_remove) == FALSE) {
    df <- df %>% filter(!.data[[var_name]] %in% char_remove)
  }
  
  if(remove_outliers == TRUE) {
      df <- outliers_removal(data=df, var=var_name)
  }
  
  if(var_type == "non_cont") {
      var <- df[, var_name]
      var <- var[var != ""]
      
      data <- as.data.frame(t(table(var)))[,2:3] 
      setnames(data, 
               old = c('var','Freq'), 
               new = c('labels','counts'))
      # print(data)
      data_tab <- data %>% mutate(csum = rev(cumsum(rev(counts))),
                       pos = counts/2 + lead(csum, 1),
                       pos = if_else(is.na(pos), counts/2, pos),
                       percentage = counts/sum(counts))
      data_tab$labels <- as.factor(data_tab$labels)
      if (plot_type == 'pie') {
          plot <- data_tab %>% ggplot(aes(x = "", y = counts, 
                                          fill = labels)) +
                              geom_col(width = 1, color = 1) +
                              geom_label_repel(
                                aes(y = pos,
                                    label = glue("{counts} ({percent(percentage)})"),
                                     fill = labels),
                                    show.legend = FALSE) +
                              labs(fill = lgd, title=plot_title) +
                              coord_polar(theta = "y") +
                              theme_void() + 
                              theme(legend.text=element_text(size=6))
      } else if (plot_type == "bar_simple") {
          plot <- data %>% ggplot(aes(y=counts,
                                      x=reorder(labels, counts),
                                      fill=labels)) +
                            geom_col(width = 0.7) +
                            geom_text(aes(label=counts), vjust=-0.3, size=3)+
                            labs(fill = lgd, title=plot_title) +
                            coord_flip() +
                            theme(legend.text=element_text(size=6))
         
      } else if(plot_type == "bar_stack"){
         plot <- data_tab %>% ggplot(aes(x = "", y = counts, 
                                  fill = labels)) +
                      geom_col(width = 1, color = 1) +
                      geom_label_repel(
                        aes(y = pos,
                            label = glue("{counts} ({percent(percentage)})"),
                             fill = labels),
                            show.legend = FALSE) +
                      labs(fill = lgd, title=plot_title) +
                      # coord_polar(theta = "y") +
                      theme_void() + 
                      theme(legend.text=element_text(size=6))
      }
        else if (plot_type == "bar_discrete") {
          plot <- data %>% ggplot(aes(y=counts, x=labels)) + 
                            geom_col(width = 0.7) +
                            labs(title=plot_title, 
                                 x=x_axis, y=y_axis) 
      } 
  }else if(var_type == "cont") {
        mu <- mean(df[,var_name], na.rm=TRUE)
        med <- median(df[,var_name], na.rm=TRUE) 
      if(plot_type == "hist") {
          
        plot <- ggplot(df, aes(x=.data[[var_name]])) + 
                      geom_histogram(fill = 'yellow',
                                     col = 'black', bins=10) 
        
      }else if(plot_type == "boxplot") {
        plot <- ggplot(df, aes(x=.data[[var_name]])) + 
                geom_boxplot(outlier.colour="red",
                              outlier.size=2)
      }
        plot <- plot +
                geom_vline(xintercept = mu,
                           col="lightblue", lty=1, lwd = 1) +
                geom_vline(xintercept = med, 
                         col="purple", lty=2, lwd = 1) +
                theme_bw() +
                labs(title=plot_title, 
                     subtitle = paste("Mean = ", round(mu, 2), 
                                      "  Median = ", med), 
                     x=x_axis, y=y_axis) 
  }
  return(plot)
}

```

### General Comparison

```{r}
generic_compare <- function(data, var_type, var1, var2, 
                          var1_title, var2_title, 
                          subplot_type, plot_title,
                          lgd_title, x_axis=NULL, y_axis=NULL,
                          char_remove=NULL){
  var1_plot <- plot_func(data, var1, var_type, lgd = lgd_title,
                         var1_title, subplot_type, char_remove,
                         x_axis=x_axis, y_axis=y_axis)
  var2_plot <- plot_func(data, var2, var_type,lgd = lgd_title,
                          var2_title, subplot_type, char_remove,
                         x_axis=x_axis, y_axis=y_axis)
  if (subplot_type == "bar_simple" || subplot_type == "bar_stack") {
        plot <- ggarrange(var2_plot + remove_y, var1_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = TRUE,legend="bottom")
  } else {
        plot <- ggarrange(var2_plot, var1_plot, 
                        ncol = 2, nrow = 1, 
                        common.legend = TRUE,
                        legend="right")
  }
  
  return(annotate_figure(plot, top = text_grob(plot_title, 
                 color = "black", face = "bold", size = 12)))
}
```

### Comparison Unpaired Post-Pre

```{r}
compare_pre_post <- function(df_pre, df_post,
                             var_name, var_type, subplot_type, title, 
                             exclude_outliers = FALSE, lgd_title,
                             x_axis=NULL, y_axis=NULL,
                             char_remove=NULL, shared_legend=TRUE) {

  pre_plot <- plot_func(df_pre, var_name, var_type,
                         "Initial", subplot_type, lgd = lgd_title,
                        x_axis=x_axis, y_axis=y_axis,
                        char_remove=char_remove, 
                        remove_outliers=exclude_outliers)
  post_plot <- plot_func(df_post, var_name, var_type,
                          "Post", subplot_type, lgd = lgd_title,
                         x_axis=x_axis, y_axis=y_axis,
                         char_remove=char_remove, 
                         remove_outliers=exclude_outliers)
  if (subplot_type == "bar_simple" || subplot_type == "bar_stack") {
        plot <- ggarrange(post_plot + remove_y, pre_plot + remove_y, 
                          ncol = 2,  nrow = 1, 
                          common.legend = shared_legend,legend="bottom")
  } else {
        plot <- ggarrange(post_plot, pre_plot, 
                          ncol = 2, nrow = 1, 
                          common.legend = shared_legend,
                          legend="right")
  }
      
  return(annotate_figure(plot, 
                         top = text_grob(title, color = "black", 
                                         face = "bold", size = 12)))

}
```

### Comparison Paired Post-Pre

```{r}
compare_paired <- function(data, var_name, view,
                           lgd_title, plot_title,
                          char_remove=NULL){
    var_pre <- as.factor(data[,paste(var_name, "pre", sep="_")])
    var_post <- as.factor(data[,paste(var_name, "post", sep="_")])
    labels_all <- c(unique(var_pre[is.na(var_pre) == FALSE]),
                    unique(var_post[is.na(var_post) == FALSE]))
  
    x <- list(labels = unique(labels_all))
    paired_df <- as.data.frame(x)
    counts_post <- as.data.frame(t(table(var_post)))[,2:3]
    props_post <- as.data.frame(prop.table(table(var_post)))
    setnames(counts_post,
             old = c('var_post','Freq'),
             new = c('labels','counts_post'))
    setnames(props_post,
             old = c('var_post','Freq'),
             new = c('labels','props_post'))
    
    counts_pre <- as.data.frame(t(table(var_pre)))[,2:3]
    props_pre <- as.data.frame(prop.table(table(var_pre)))
    setnames(counts_pre,
             old = c('var_pre','Freq'),
             new = c('labels','counts_pre'))
    setnames(props_pre,
         old = c('var_pre','Freq'),
         new = c('labels','props_pre'))
    
    df_list <- list(paired_df, counts_post, counts_pre, props_pre, props_post)
    merged <- df_list %>% reduce(left_join, by='labels')
    merged <- merged %>% replace(is.na(.), 0)
    merged$diff_counts <- merged$counts_post - merged$counts_pre
    merged$diff_props <- merged$props_post - merged$props_pre
    merged$count_change <- merged$diff_counts/merged$counts_pre
    print(merged)
    
    # side_plot <- 
    count_plot <- merged %>% ggplot(aes(x = labels, y = diff_counts)) +
                      geom_bar(aes(fill = labels), stat="identity") +
                      geom_label_repel(
                        aes(label = 
                              glue("{diff_counts} ({percent(count_change)})"),
                            fill = labels),
                            show.legend = FALSE) +
                      labs(fill = lgd_title, 
                           y="Difference in Counts") +
                        theme(legend.text=element_text(size=6)) + 
                        remove_x
    
    prop_plot <- merged %>% ggplot(aes(x = labels, y = diff_props)) +
                  geom_bar(aes(fill = labels), stat="identity") +
                  geom_label_repel(
                    aes(label = 
                          glue("{percent(diff_props)}"),
                        fill = labels),
                        show.legend = FALSE) +
                  labs(fill = lgd_title,  
                       y="Difference in Proportions") +
                    theme(legend.text=element_text(size=6)) + 
                    remove_x
    
    plot <- ggarrange(count_plot, prop_plot,
                          ncol = 2,  nrow = 1, 
                          common.legend = TRUE,legend="bottom")

    print(annotate_figure(plot, 
                         top = text_grob(plot_title, color = "black", 
                                         face = "bold", size = 12)))
}
```

## Hypothesis Testing

```{r}
# Running the paired t-test
paired_testing <- function(data, var_name, test_type,
                           diff_type="magnitude",
                           plot_diff=FALSE, plt_title=NULL,
                           threshold=NULL,threshold_bound=NULL,
                           remove_outliers=FALSE, x_axis, y_axis) {
  pre_name <- paste(var_name, "pre", sep="_")
  post_name <- paste(var_name, "post", sep="_")
  #var_pre <- data[, pre_name]
  #var_post <- data[, post_name]
  
  if(diff_type == "direction"){
        data$var_diff <- ifelse(data[, post_name] > data[, pre_name], 1,
                               ifelse((data[, post_name] < data[, pre_name]), -1, 0))
      }else if(diff_type == "magnitude") {
        data$var_diff <- data[, post_name] - data[, pre_name]
      }
      
  data$diff_abs <- abs(data$var_diff)
  if(remove_outliers==TRUE) {
    data <- outliers_removal(data=data, var="diff_abs")
  }
  
  if(is.null(threshold) == FALSE) {
    if(threshold_bound == "lower"){
      data <- data %>% filter(diff_abs < threshold)
    }else if(threshold_bound == "upper"){
      data <- data %>% filter(diff_abs > threshold)
    }
  }

  # Running the test
  if(test_type == "wilcoxon"){
    #Wilcoxon Signed-Rank Test
    test <- wilcox.test(data[, pre_name], data[, post_name], paired=TRUE, 
                        conf.int = T, correct = T, exact = F, conf.level = .95)
  }else if(test_type == "sign") {
    #Sign Test
    test <- signtest(data$var_diff, m=0, conf.level=0.95, exact=FALSE)
  } else if (test_type == "ttest") {
    #Paired t-Test
    test <- t.test(data[, pre_name], data[, post_name],
         paired = TRUE, alternative = "two.sided")
  } else if(test_type == "mcnemar") {
    cross_tab <- table(data[, pre_name], data[, post_name])
    print(cross_tab)
    test <- mcnemar.test(cross_tab)
  }
  print(test)
  # Visualize distribution of score differences
  if(plot_diff == TRUE) {
      data$var_diff <- as.integer(data$var_diff)
      plot <- plot_func(df=data, var_name="var_diff", var_type="cont", 
                        plot_title=plt_title, plot_type="hist",
                        x_axis=x_axis, y_axis=y_axis)
      return(plot)
  }
  # return(test)
}
```

## Regression Analysis

### Plotting Scatter-plots

```{r}
plot_reg <- function(data, feature, dependent, 
                     remove_outliers=FALSE, which_outliers=NULL,
                     reg_type, vals_remove=NULL,title=NULL,
                     x_axis=NULL, y_axis=NULL) {
  
  if(is.null(vals_remove) == FALSE) {
    data <- data %>% filter(!.data[[dependent]] %in% vals_remove)
  }
  
  if(remove_outliers == TRUE) {
      if(which_outliers=="dependent"){
        data <- outliers_removal(data=data, var=dependent)
        
      }else if(which_outliers=="feature"){
        data <- outliers_removal(data=data, var=feature)
        
      }else if(which_outliers=="all"){
        temp <- outliers_removal(data=data, var=feature)
        data <- outliers_removal(data=data, var=dependent)
      }
  }
  

  if(reg_type == "linear") {
    plot <- ggplot(data,
                aes(x=.data[[feature]], y=.data[[dependent]])) +
                geom_point(color='blue') +
                  geom_smooth(color='red', method = "lm", se = TRUE) +
                theme_classic()
    
  } else if(reg_type == "logistic") {
    
     plot <- ggplot(data, 
                    aes(x=.data[[feature]], y=.data[[dependent]])) + 
              geom_jitter(width = 0.05, height = 0.05) +
              #geom_point(color='blue', alpha=.5) +
             geom_smooth(method = "glm", color='red',
                         method.args= list(binomial(link = 'logit')), se=FALSE)
                theme_classic()
                
  }else if(reg_type == "poisson") {
     plot <- ggplot(data, 
                    aes(x=.data[[feature]], y=.data[[dependent]])) + 
              #geom_point(color='blue', alpha=.5) +
              geom_jitter(width = 0.05, height = 0.05) +
              geom_smooth(method = "glm", color='red',
                         method.args= list(family="poisson"), se=TRUE)+
                theme_classic()
                
  }
  plot <- plot + labs(title=title, y=y_axis) 
  return(plot)
}
```

### Regression - Community

```{r}
ind_vars <- c("PV_Size_kWp",	"Customers",	"CAPEX_USD")

community_reg <- function(df, col_name, dep, customer_type,
                          title, var_type, 
                          calc_diff=FALSE, diff_type=NULL,
                          to_remove=NULL, exclude_outliers = FALSE, 
                          outliers=NULL, y_axis=NULL) {
  if (calc_diff == TRUE) {
      pre_name <- paste(col_name, "pre", sep="_")
      post_name <- paste(col_name, "post", sep="_")
      if(diff_type == "direction"){
        df$col_reg <- ifelse(df[, post_name] > df[, pre_name], 1,
                               ifelse((df[, post_name] < df[, pre_name]), -1, 0))
      }else if(diff_type == "magnitude") {
        df$col_reg <- df[, post_name] - df[, pre_name]
      }
      
      names(df)[names(df) == "community_post"] <- "community"
      
  } else {
      df$col_reg <- df[, col_name]
  }
  
  if(var_type == "categorical") {
    data <- rownames_to_column(as.data.frame.matrix(
                                  prop.table(table(
                                      df[, "community"], 
                                      df[, "col_reg"]),
                                     margin = 1)), 
                               var = "community")
    community_data <- merge(x=projects, y=data, by="community")
    community_data$target <- as.integer(community_data[, dep]*community_data[, customer_type])
  } else if(var_type == "ratio") {
    data <- as.data.frame(rowsum(df[, "col_reg"], 
                                 df[, "community"], na.rm = TRUE))
    data$community <- rownames(data)
    community_data <- merge(x=projects, y=data, by="community")
    names(community_data)[names(community_data) == "V1"] <- "target"
  }
  
  
  if(is.null(to_remove) == FALSE) {
    #community_data <- community_data[!grepl(to_remove,data$target),]
    community_data <- community_data %>% filter(!.data[["target"]] %in% to_remove)
  }
  

  print(community_data)
  target_dist_data <- outliers_removal(data=community_data, var="target")
  dist <- plot_func(df=target_dist_data, var_name="target", var_type="cont", 
                    plot_title="Dependent Variable Boxplot", plot_type="boxplot", 
                    char_remove=NULL,
                    remove_outliers = FALSE,
                    x_axis=NULL, y_axis=NULL)
  
  lst <- list(dist)
  
   for(ind in ind_vars) {
       print(ind)
       if(exclude_outliers == TRUE) {
            community_data <- outliers_removal(data=community_data, var=ind)
        }
        p <- plot_reg(data=community_data, feature=ind,  
                      dependent="target", reg_type="linear",
                      # remove_outliers = exclude_outliers,
                      # which_outliers = outliers,
                      y_axis=y_axis)
        lst <- append(lst, list(p))
        pearson_test <- cor.test(community_data[, "target"], 
                                 community_data[,ind], 
                                 method="pearson")
        print(pearson_test)
        
        lm <- lm(community_data[,"target"] ~ community_data[,ind])
        details <- summary(lm)
        print(details)
        print(confint(lm, level=0.95))
      }
  plot <- ggarrange(plotlist = lst, 
                    ncol = 2, nrow = 2, 
                    common.legend = TRUE,
                    legend="right")
  annotate_figure(plot, top = text_grob(title, 
                 color = "black", face = "bold", size = 12))
  }
```

### Regression - Consumption

```{r}
consumption_reg <- function(df, dep, ind, title, reg_type, 
                            calc_diff=FALSE, diff_type=NULL,
                            exclude_outliers = FALSE,
                            outliers=NULL, to_remove=NULL,
                            x_axis=NULL, y_axis=NULL,
                            #normalize=FALSE, 
                            threshold=NULL, 
                            threshold_bound=NULL,
                            log_direction=NULL) {

  if (calc_diff == TRUE) {
      pre_name <- paste(dep, "pre", sep="_")
      post_name <- paste(dep, "post", sep="_")
      if(diff_type == "direction"){
        df$col_reg <- ifelse(df[, post_name] > df[, pre_name], 1,
                               ifelse((df[, post_name] < df[, pre_name]), -1, 0))
      }else if(diff_type == "magnitude") {
        df$col_reg <- df[, post_name] - df[, pre_name]
      }
      
    } else {
      df$col_reg <- df[, dep]
    }
  
  if(is.null(threshold) == FALSE) {
    if(threshold_bound == "lower"){
      df <- df %>% filter(col_reg < threshold)
    }else if(threshold_bound == "higher"){
      df <- df %>% filter(col_reg > threshold)
    }
  }
      
  # if(normalize==TRUE) {
  #   mu <- mean(df$col_reg, na.rm = TRUE)
  #   std <- sd(df$col_reg, na.rm = TRUE)
  #   df$col_reg <- (df$col_reg - mu) / std
  # }
  print(dim(df))
  print(head(df[, c(ind, "col_reg")]))
  
  if(reg_type == "linear") {
    model <- lm(df$col_reg ~ df[, ind])
    print(summary(model))
    print(confint(model, level=0.95))
    p <- plot_reg(data=df, feature=ind,  
                  dependent="col_reg", reg_type="linear", 
                  remove_outliers=exclude_outliers, 
                  which_outliers = outliers,
                  vals_remove=to_remove,
                  title=title, x_axi=x_axis, y_axis=y_axis)
    test <- cor.test(df$col_reg, df[, ind], 
                     method="pearson")
    print(test)
    
  } else if(reg_type == "logistic") {
    #if(calc_diff == TRUE) {
    if(log_direction == 1) {
      df <- df %>% filter(col_reg >= 0)
    }else if(log_direction == -1) {
      df <- df %>% filter(col_reg <= 0)
      df$col_reg <- ifelse(df$col_reg == -1, 1, 0)
    }
    model <- glm(df$col_reg ~ df[, ind], 
               family="binomial")
    print(summary(model))
    print(confint(model, level=0.95))
    p <- plot_reg(data=df, feature=ind,  
                  dependent="col_reg", reg_type="logistic", 
                  remove_outliers=exclude_outliers,
                  which_outliers = outliers,
                  vals_remove=to_remove,
                  title=title, x_axi=x_axis, y_axis=y_axis)
    test <- wald.test(Sigma = vcov(model), 
                      b = coef(model), Terms = 1)
    print(test)
  }else if(reg_type == "poisson") {
    model <- glm(df$col_reg ~ df[, ind], 
               family="poisson")
    print(summary(model))
    print(confint(model, level=0.95))
    p <- plot_reg(data=df, feature=ind,  
                  dependent="col_reg", reg_type="poisson", 
                  remove_outliers=exclude_outliers,
                  which_outliers = outliers,
                  vals_remove=to_remove,
                  title=title, x_axi=x_axis, y_axis=y_axis)
    test <- wald.test(Sigma = vcov(model), 
                      b = coef(model), Terms = 1)
    print(test)
  }
  return(p)
  
}
```

```{r}
# rg <- preProcess(as.data.frame(paired_enc$kerosene_lamps_count_post), 
#                    method=c("range"))
#  
# temp <- predict(rg, as.data.frame(paired_enc$kerosene_lamps_count_post))
# temp$consumption <- paired_enc$avg_mon_consumption_period
# paired_enc$test <- log(paired_enc$water_cost_post)
# ggplot(paired_enc,
#         aes(x=avg_mon_consumption_period, 
#             y=test)) +
#         geom_point(color='blue') +
#           geom_smooth(color='red', method = "lm", se = TRUE) +
#         theme_classic()
```

# 1- General

## A) Gender

```{r}
## What was the gender breakdown of survey respondents, pre and post?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="gender", var_type="non_cont",
                 lgd_title ="Gender",
                 subplot_type="pie", title="Unpaired: Gender Breakdown")

# Paired
plot_func(df=paired_clean, 
          var_name="gender_post", var_type="non_cont", lgd = "Gender",
          plot_title="Paired: Gender Breakdown", 
          plot_type="pie")
```

## B) Age

```{r}
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="age", var_type="cont",
                 subplot_type="hist", shared_legend=FALSE,
                 exclude_outliers = TRUE,
                 x_axis="Age", y_axis="Count",
                 title="Unpaired: Age")

# Paired
plot_func(df=paired_clean, 
          var_name="age_post", 
          var_type="cont", lgd = "Gender",
          plot_title="Paired: Age", 
          remove_outliers = TRUE,
          plot_type="hist")
```

## C) Occupation

```{r}
# Type of employment for Primary Provider
# plot_func(df=initial_pre, var_name="primary_provider_occupation", 
#           var_type="non_cont", lgd="Type",
#           plot_title="Occupation of Primary Provider", 
#           plot_type="bar_stack")
```

## D) Employment Type

```{r}
# Type of employment for Primary Provider
plot_func(df=initial_pre, var_name="employement_type", 
          var_type="non_cont", lgd="Type",
          plot_title="Employement Type of Primary Provider", 
          plot_type="pie")
```

## E) Correlation - Dependent Variables

```{r}
corr_simple <- function(data,sig=0){
  #convert data to numeric in order to run correlations
  #convert to factor first to keep the integrity of the data - each value will become a number rather than turn into NA
  data <- data[, !names(data) %in% c("renewvia_id","X", 
                                     "end", "end_date", "displayName",
                                     "meterSerial", "projectName",
                                     "Sum.of.kWh.Consumed.y",
                                     "avg_mon_consumption_cum")]
  df_cor <- data %>% mutate_if(is.character, as.factor)
  df_cor <- df_cor %>% mutate_if(is.factor, as.numeric)
  #run a correlation and drop the insignificant ones
  corr <- cor(df_cor)
  #prepare to drop duplicates and correlations of 1     
  corr[lower.tri(corr,diag=TRUE)] <- NA 
  #drop perfect correlations
  corr[corr == 1] <- NA 
  #turn into a 3-column table
  corr <- as.data.frame(as.table(corr))
  #remove the NA values from above 
  corr <- na.omit(corr) 
  #select significant values  
  corr <- subset(corr, abs(Freq) > sig) 
  #sort by highest correlation
  corr <- corr[order(-abs(corr$Freq)),] 
  #print table
  print(corr)
  #turn corr back into matrix in order to plot with corrplot
  mtx_corr <- reshape2::acast(corr, Var1~Var2, value.var="Freq")
  #plot correlations visually
  corrplot(mtx_corr, is.corr=FALSE, tl.col="black", na.label=" ")
}
```

```{r}
# HS Pre-survey
corr_simple(initial_enc)
```

```{r}
# HS Post-survey
corr_simple(post_enc)
```

```{r}
# C&I Post-survey
corr_simple(ci_enc)
```

# 2- Gender Equality

## A) Descriptive

### Pre-Connection School Enrollment

```{r}
# What was school enrollment by gender pre-connection?
girls <- sum(initial_pre$girls_headcount,na.rm = TRUE)
girls_in_school <- sum(initial_pre$girls_schooling,na.rm = TRUE)
enrollment_rate <- percent(girls_in_school/girls, accuracy = 0.01)

vals <- c(girls, girls_in_school, enrollment_rate)

# creating matrix
tab <- as.data.frame(t(as.matrix(vals)))
setnames(tab, old = c('V1','V2', 'V3'), 
          new = c("Girls", "Girls.In.School", "Enrollment.Rate"))
```

```{r}
# What was school enrollment by gender pre-connection?
boys <- sum(initial_pre$boys_headcount,na.rm = TRUE)
boys_in_school <- sum(initial_pre$boys_schooling,na.rm = TRUE)
enrollment_rate <- percent(boys_in_school/boys, accuracy = 0.01)

vals <- c(boys, boys_in_school, enrollment_rate)

# creating matrix
tab <- as.data.frame(t(as.matrix(vals)))
setnames(tab, old = c('V1','V2', 'V3'),
          new = c("Boys", "Boys.In.School", "Enrollment.Rate"))
tab
```

### School Enrollment Change

```{r}
# Was there a change in enrollment by gender afterwards?
# Unpaired
generic_compare(data=post_clean, var_type="non_cont",
               var1="girls_schooling_change", 
               var2="boys_schooling_change", 
               lgd_title ="Change",
               var1_title="Girls", var2_title="Boys", 
               subplot_type="pie", plot_title="Unpaired: School Enrollment Change")

# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="girls_schooling_change", 
               var2="boys_schooling_change", 
               lgd_title ="Change",
               var1_title="Girls", var2_title="Boys", 
               subplot_type="pie", 
               plot_title="Paired: School Enrollment Change")
```

### Reasons for (un)enrollment

#### TODO: Girls' Schooling

```{r}
# Dirving factor for non-enrollment in school for boys and girls
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="girls_unschooled_reasons", 
                 var_type="non_cont",
                 lgd_title ="Reasons",
                 subplot_type="bar_simple", 
                 title="Unpaired - Girls Schooling: Reasons for non-enrollment")

# For Girls
compare_paired(data=paired_clean,
               var_name="girls_unschooled_reasons",
               lgd_title="Reasons",
               plot_title="Girls Schooling: Reasons for non-enrollment")
```

#### Boys' Schooling

```{r}
# For Boys
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="boys_unschooled_reasons", 
                 var_type="non_cont",lgd_title ="Reasons",
                 subplot_type="bar_simple", 
                 title="Unpaired - Boys Schooling: Reasons for non-enrollment")

# Paired
compare_paired(data=paired_clean,
               var_name="boys_unschooled_reasons",
               lgd_title="Reasons",
               plot_title="Paired - Boys Schooling: Reasons for non-enrollment")
```

### Household Chores

#### Water Collection - Responsibility

```{r}
# What is the average age of the person in charge of water collection?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="avg_person_age_water_collection", 
                 var_type="non_cont",
                 lgd_title="Age Group",
                 subplot_type="bar_simple", 
                 title="Unpaired: Age of Person Responsible 
                 for Water Collection")

# Paired
compare_paired(data=paired_clean,
               var_name="avg_person_age_water_collection",
               lgd_title="Age Group",
               plot_title="Paired: Age of Person Responsible 
               for Water Collection")
```

#### Is the person responsible school-aged?

```{r}
# What is the average age of the person in charge of water collection? Binarized as school-aged vs not
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="water_collection_school_aged", 
                 var_type="non_cont", subplot_type="pie",
                 lgd_title="School-Aged?",
                 title="Unpaired: Water Collection Responsibility (School-Aged)")

# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="water_collection_school_aged_pre", 
               var2="water_collection_school_aged_post", 
               lgd_title ="School-Aged?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Breakdown of Water Collection Responsibility (School-Aged)")

# Paired
compare_paired(data=paired_clean,
               var_name="water_collection_school_aged",
               lgd_title="School-Aged?",
               plot_title="Paired: Change of Water Collection Responsibility (School-Aged)")
```

#### Cooking Fuel Collection - Are men involved?

```{r}
# Who is mainly responsible for cooking fuel collection on a daily basis? Binarized as presence of "adult_male" vs not
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="cooking_fuel_responsible_binary", 
                 var_type="non_cont",
                 subplot_type="pie",
                 lgd_title="Are men involved?",
                 title="Unpaired: Shcool-Aged Person responsible 
                 for Cooking Fuel Collection")

# Paired
compare_paired(data=paired_clean,
               var_name="cooking_fuel_responsible_binary",
               lgd_title="Are men involved?",
               plot_title="Paired: Shcool-Aged Person responsible 
                 for Cooking Fuel Collection")
```

### Female Businesses Ownership - Subgroup by country, community

```{r}
# How many new women-led businesses were created?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Unpaired - Women Business Owners")

# Paired
compare_paired(data=paired_clean,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Paired: Women Business Owners")
```

#### Subgroup Analysis - Country

```{r}
ctr <- "nigeria"
country_pre <- initial_pre %>% filter(country == ctr)
country_post <- post_clean %>% filter(country == ctr)
compare_pre_post(df_pre=country_pre, df_post=country_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Nigeria Unpaired: Women Business Owners")

# Paired
country_paired <- paired_clean %>% filter(country_post == ctr)
compare_paired(data=country_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Nigeria Paired: Women Business Owners")
```

```{r}
ctr <- "kenya"
country_pre <- initial_pre %>% filter(country == ctr)
country_post <- post_clean %>% filter(country == ctr)
compare_pre_post(df_pre=country_pre, df_post=country_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Kenya Unpaired: Women Business Owners")

# Paired
country_paired <- paired_clean %>% filter(country_post == ctr)
compare_paired(data=country_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Kenya Paired: Women Business Owners")
```

#### Subgroup Analysis - Gender

```{r}
gdr <- "male"
gender_pre <- initial_pre %>% filter(gender == gdr)
gender_post <- post_clean %>% filter(gender == gdr)
compare_pre_post(df_pre=gender_pre, df_post=gender_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Men Unpaired: Women Business Owners")

# Paired
gender_paired <- paired_clean %>% filter(gender_post == gdr)
compare_paired(data=gender_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Men Paired: Women Business Owners")
```

```{r}
gdr <- "female"
gender_pre <- initial_pre %>% filter(gender == gdr)
gender_post <- post_clean %>% filter(gender == gdr)
compare_pre_post(df_pre=gender_pre, df_post=gender_post,
                 var_name="business_owners_female", 
                 var_type="non_cont", 
                 lgd_title = "Is there a woman business owner?",
                  subplot_type="pie", 
                  title="Women Unpaired: Women Business Owners")

# Paired
gender_paired <- paired_clean %>% filter(gender_post == gdr)
compare_paired(data=gender_paired,
               var_name="business_owners_female",
               lgd_title="Is there a woman business owner?",
               plot_title="Women Paired: Women Business Owners")
```

### TODO

-   Bar charts by groups, Chi-Square goodness of fit, proportions not counts

-   Qualitative Methods: In respondent's own words, how were women affected from the mini-grid?

## B) Inferential

### School Enrollment Change

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

#### Regression - Community (Girls)\*

```{r}
## Has there been a change in the number of females in your household who attend school full time since connection to minigrid power?
# Check for increase
community_reg(df=post_enc,
              col_name="girls_schooling_change", dep="1", 
              var_type="categorical", customer_type="hs",
              exclude_outliers = TRUE, outliers = "feature",
              y_axis= "Households",
              title="Increase in Girls' School Enrollment by Community")
```

#### TODO: Investigate, RESOLVED

```{r}
# Check for decrease
community_reg(df=post_enc,
              col_name="girls_schooling_change", dep="-1", 
              var_type="categorical", customer_type="hs",
              exclude_outliers = TRUE, outliers = "feature",
              y_axis= "Households",
              title="Decrease in Girls' School Enrollment by Community")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = post_enc, reg_type ="logistic",
                dep= "girls_schooling_change", ind="avg_mon_consumption_period",
                calc_diff=FALSE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Water Collection Time", log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Increase in Girls' School Enrollment vs Consumption")
```

#### Regression - Community (Boys)\*

```{r}
## Has there been a change in the number of males in your household who attend school FULL TIME since connection to minigrid power?
# Check for increase
community_reg(df=post_enc,
              col_name="boys_schooling_change", dep="1", 
              var_type="categorical", 
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="hs", y_axis= "Households",
              title="Increase in Boys' School Enrollment by Community")
```

```{r}
# Check for decrease
community_reg(df=post_enc,
              col_name="boys_schooling_change", dep="-1", 
              var_type="categorical", exclude_outliers = TRUE, 
              outliers = "feature",
              customer_type="hs", y_axis= "Households",
              title="Decrease in Boys' School Enrollment by Community")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = post_enc, reg_type ="logistic",
                dep= "boys_schooling_change", ind="avg_mon_consumption_period",
                calc_diff=FALSE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Water Collection Time", log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Increase in Boys' School Enrollment vs Consumption")
```

### Water Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "less than 1 hour" = 1; "1-2 hours" = 2; "2-3 hours" = 3; "3-4 hours" = 4; "greater than 4 hours" = 5

#### Paired Test\*

```{r}
# How long does the water collection process take on a daily basis?
paired_testing(paired_enc, var_name="water_collection_time", 
               test_type = "sign", plot_diff=TRUE, 
               x_axis="Differences", y_axis="Count",
               remove_outliers = TRUE,
               plt_title="Difference in Pre-Post of Water Collection Time")
```

#### Linear Regression - Community\*

```{r}
## Community Paired Differences
# Directional 
community_reg(df=paired_enc, 
              col_name="water_collection_time", dep="-1", 
              var_type="categorical", 
              calc_diff = TRUE, diff_type = "direction",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="hs", y_axis= "Households",
              title="Decrease (Direction) in Water Collection Time by Community")
```

```{r}
# Magnitude 
community_reg(df=paired_enc, 
              col_name="water_collection_time", dep="target", 
              var_type="ratio", 
              calc_diff = TRUE, diff_type = "magnitude",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="hs", y_axis= "Sum of Differences",
              title="Decrease (Magnitude) in Water Collection Time by Community")
```

#### Linear Regression - Individual

```{r}
## Paired Individual Directional Change
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "water_collection_time", ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "magnitude",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Water Collection Time", 
                threshold = 4, threshold_bound = "lower",
                title="Individual Directional Change vs Consumption")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = paired_enc, reg_type ="logistic",
                dep= "water_collection_time", ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Water Collection Time", log_direction = -1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### Water Collection School-Aged

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

#### Paired Test\*

```{r}
paired_testing(paired_enc, var_name="water_collection_school_aged", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community\*

```{r}
community_reg(df=paired_enc, 
              col_name="water_collection_school_aged", dep="-1", 
              title="Water Collection Responsibility (School-Aged) by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff =TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = paired_enc, reg_type ="logistic",
                dep= "water_collection_school_aged", 
                ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Water Collection Responsibility (School-Aged)",
                log_direction = -1,
                #exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### Cooking Fuel Collection Time

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "No need to collect fuel" = 1; "less than 1 hour" = 2; "1-2 hours" =3; "3-5 hours" = 4; "greater than 4 hours" = 5

#### Paired Test\*

```{r}
# How long does the cooking fuel collection process take on a daily basis?
paired_testing(paired_enc, var_name="cooking_fuel_collection_time", 
               test_type = "ttest", plot_diff=TRUE, 
               x_axis="Differences", y_axis="Count",
               remove_outliers = TRUE,
               plt_title="Difference in Pre-Post Cooking Fuel Collection Times")
```

#### Regression - Community

```{r}
## Community Paired Differences
# Directional 
community_reg(df=paired_enc, 
              col_name="cooking_fuel_collection_time", dep="-1", 
              var_type="categorical", 
              calc_diff = TRUE, diff_type = "direction",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="hs", y_axis= "Households",
              title="Decrease (Direction) in 
              Cooking Fuel Collection Time by Community")

```

#### Linear Regression - Individual

```{r}
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "cooking_fuel_collection_time", 
                ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "magnitude",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Water Collection Time", 
                #threshold = 4, threshold_bound = "lower",
                title="Individual Directional Change vs Consumption")
```

#### Logistic Regression - Individual

```{r}
# Regression - Pre-Post Differences
consumption_reg(df = paired_enc, reg_type ="logistic",
                dep= "cooking_fuel_collection_time", 
                ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Cooking Fuel Collection Time",
                log_direction = -1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")

# Monthly consumption between pre and post: 
# avg_monthly_consumption = (365* (Consumption_period / no.of days))/12  
```

### Women-led Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Everything else = 0; "adult_female" = 1

#### Paired Test\*

```{r}
# Are any household members business owners? Isolate for those with 'adult_'female
print("All")
paired_testing(paired_enc, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)

## Subgroup Analysis: Country
# Nigeria
print("Nigeria")
ctr <- 1
country_paired <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)

# Kenya
print("Kenya")
ctr <- 2
country_paired <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)

## Subgroup Analysis: Country
# Women
print("Women")
gdr <- 1
gender_paired <- paired_enc %>% filter(gender_post == gdr)
paired_testing(gender_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)

# Men
print("Men")
gdr <- 2
gender_paired <- paired_enc %>% filter(gender_post == gdr)
paired_testing(gender_paired, var_name="business_owners_female", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community

```{r}
community_reg(df=paired_enc, 
              col_name="business_owners_female", 
              dep="1", var_type="categorical", 
              calc_diff = TRUE, diff_type = "direction",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="hs", y_axis= "Households",
              title="New Female Business Owners Change by Community")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = paired_enc, reg_type ="logistic",
                dep= "business_owners_female", 
                ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="New Female Business Owners Change",
                log_direction = 1,
                #exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### New Female workers

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

#### Regression - Community\*

```{r}
ci_enc$hired_women <- ifelse(ci_enc$workforce_change_female > 0, 1, 0)
```

```{r}
# If you answered yes to adding new workers, how many new employees are female?
community_reg(df=ci_enc, 
              col_name="hired_women", 
              dep="1", var_type="categorical", 
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="ci", y_axis= "C&I",
              title="New Female Workers Change by Community")
```

#### Linear Regression - Individual

```{r}
# Regression - Pre-Post Differences
consumption_reg(df = ci_enc, reg_type ="linear",
                ind="avg_mon_consumption_cum",
                dep= "workforce_change_female", 
                exclude_outliers = TRUE, outliers = "feature",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kwH)", 
                y_axis="Women Workers", to_remove=c(0),
                threshold = 4, threshold_bound = "lower",
                title="New Female Workers vs. Consumption")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = ci_enc, reg_type ="logistic",
                dep= "hired_women", 
                ind="avg_mon_consumption_cum",
                calc_diff=FALSE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="New Female Workers",
                log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

# 3- Productivity

## A) Descriptive

### Power

#### Sources

```{r}
## What is your primary power source?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, lgd_title ="Types",
                 var_name="power_sources_primary", var_type="non_cont",
                 subplot_type="bar_simple", 
                 title="Unpaired: Primary Power Source")

# Paired
compare_paired(data=paired_clean,
               var_name="power_sources_primary",
               lgd_title="Source Type",
               plot_title="Paired: Pimary Power Source")
```

#### **Un-clean sources: Diesel, Petrol, Kerosene**

```{r}
## What is your primary power source?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 lgd_title ="Non-renewable?",
                 var_name="power_sources_unclean", var_type="non_cont",
                 subplot_type="pie", 
                 title="Unpaired: Breakdown of Power Sources (Non-Renewable)")

# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="power_sources_unclean_pre", 
               var2="power_sources_unclean_post", 
               lgd_title ="Non-renewable?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Breakdown of Power Sources (Non-Renewable)")

# Paired
compare_paired(data=paired_clean,
               var_name="power_sources_unclean",
               lgd_title="Non-renewable?",
               plot_title="Paired: Change of Power Sources (Non-Renewable)")
```

### Light Hours

```{r}
## How many hours of light per day do you currently have at home?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="light_hours_current", var_type="cont",
                 subplot_type="hist", title="Light Hours",
                 char_remove=c(46, 200))
```

### Appliances

#### Count

```{r}
# How many electronic devices or appliances do you currently use in the household
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="appliances_count", var_type="cont",
                 exclude_outliers = TRUE, 
                 subplot_type="hist", title="Appliances")
```

#### Change

```{r}
# Has the number of electronic devices or appliances increased since connection to minigrid?
plot_func(df=post_clean, var_name="appliances_count_change", 
          var_type="non_cont", lgd = "Change",
          plot_title="Change in No. of Appliances", 
          plot_type="pie")
```

#### Charging Sources

```{r}
# What is your primary power source?
compare_pre_post(df_pre=initial_pre, df_post=post_clean, lgd_title ="Types",
                 var_name="applicances_charging_sources", var_type="non_cont",
                 subplot_type="bar_simple", 
                 title="Unpaired: Appliances Charging Source")

compare_paired(data=paired_clean,
               var_name="applicances_charging_sources",
               lgd_title="Source Type",
               plot_title="Paired: Appliances Charging Source")
```

### Phone Charging

#### Frequency

```{r}
## How often do you need to charge your mobile phone?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="phone_charge_frequency", var_type="non_cont",
                 subplot_type="bar_simple", lgd_title = "Time Intervals",
                 title="Unpaired: Phone Charging Frequency")

# Paired
compare_paired(data=paired_clean,
               var_name="phone_charge_frequency",
               lgd_title="Time Intervals",
               plot_title="Paired: Phone Charging Frequency")
```

#### Location

```{r}
## Where do you typically charge your mobile phone?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="phone_charge_location", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Places",
                 title="Unpaired: Location of Phone Charging")

# Paired
compare_paired(data=paired_clean,
               var_name="phone_charge_location",
               lgd_title="Places",
               plot_title="Paired: Location of Phone Charging")
```

#### Travel Distance

```{r}
# How far must you travel to charge your mobile phone?
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="phone_charge_travel_distance", var_type="non_cont",
                 subplot_type="bar_simple", lgd_title = "Distances",
                 title="Unpaired: Travel Distance to Charge Phone",
                 char_remove=NULL)

# Paired
compare_paired(data=paired_clean,
               var_name="phone_charge_travel_distance",
               lgd_title="Time Intervals",
               plot_title="Paired: Travel Distance to Charge Phone")
```

### Water Collection

#### Travel Distance

```{r}
## How far must you travel to obtain your water supply?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="water_collection_travel_distance", var_type="non_cont",
                 subplot_type="bar", lgd_title = "Distances",
                 title="Travel Distance for Water Collection",
                 char_remove=NULL)

# Paired
compare_paired(data=paired_clean,
               var_name="water_collection_travel_distance",
               lgd_title="Time Intervals",
               plot_title="Paired: Travel Distance for Water Collection")
```

#### Time

```{r}
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="water_collection_time", 
                 var_type="non_cont",
                 subplot_type="bar_simple",
                 lgd_title="Time Intervals",
                 title="Unpaired: Water Collection Time")

# Paired
compare_paired(data=paired_clean,
               var_name="water_collection_time",
               lgd_title="Time Intervals",
               plot_title="Paired: Water Collection Time")
```

### Cooking Fuel

#### Sources

```{r}
## What is your main source of energy for cooking?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, lgd_title ="Types",
                 var_name="cooking_energy_sources", var_type="non_cont",
                 subplot_type="pie", 
                 title="Unpaired: Cooking Energy Sources")

# Paired
compare_paired(data=paired_clean,
               var_name="cooking_energy_sources",
               lgd_title="Types",
               plot_title="Paired: Cooking Energy Sources")
```

#### **Un-clean sources: Kerosene, Charcoal**

#### Time

```{r}
##  How long does the cooking fuel collection process take on a daily basis?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean,
                 var_name="cooking_fuel_collection_time", 
                 var_type="non_cont",
                 subplot_type="bar_simple",
                 lgd_title="Time Intervals",
                 title="Unpaired: Cooking Fuel Collection Time")

# Paired
compare_paired(data=paired_clean,
               var_name="cooking_fuel_collection_time",
               lgd_title="Time Intervals",
               plot_title="Paired: Cooking Fuel Collection Time")
```

### Households - Academic Performance

```{r}
# Has school performance changed since connection to minigrid?
plot_func(df=post_clean, var_name="school_performance_change", 
          var_type="non_cont", lgd = "Change",
          plot_title="Unpaired: Household - Academic Performance", 
          plot_type="pie")

# Paired
plot_func(df=paired_clean, var_name="school_performance_change", 
          var_type="non_cont", lgd = "Change",
          plot_title="Paired: Household - Academic Performance", 
          plot_type="pie")
```

### Schools - Academic Performance

```{r}
plot_func(df=schools_clean, var_name="school_performance", 
          var_type="non_cont", lgd = "Change",
          plot_title="Schools - Academic Performance", 
          plot_type="pie")
```

### Commercial & Institution

#### Operation Hours Change

```{r}
# Since connection to Renewvia minigrid, have your hours of operation changed at all?
plot_func(df=ci_clean, var_name="operations_hours_change", 
          var_type="non_cont", lgd="Change",
          plot_title="Change in C&I Business Hours", 
          plot_type="pie")
```

#### Additional Operation Hours

```{r}
plot_func(df=ci_clean, var_name="business_hours_increase", 
          var_type="non_cont", lgd="By how much?",
          plot_title="C&I Added Operation Hours", 
          plot_type="pie")
```

#### Change in Workforce

```{r}
# Since connection to Renewvia mingrid, have you had any change in number of workers/employees at your place of work?
plot_func(df=business_clean, var_name="workforce_change", 
          var_type="non_cont", lgd="Change",
          plot_title="Change in C&I Workforce", 
          plot_type="pie")
```

#### Adding New Products/Services

```{r}
# Have you added any new products or services since connection to Renewvia minigrid?
plot_func(df=ci_clean, var_name="ci_offering_change", 
          var_type="non_cont", lgd="Change",
          plot_title="Change in C&I Products/Services", 
          plot_type="pie")
```

### TODO

-   Annotation & encoding of "light_primary_source"

-   For cooking energy sources, add the unclean sources: charcoal, firewood

## B) Inferential

### Power Source

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

#### Paired Test\*

```{r}
## What is your primary power source? Binarized as renewable vs. non-renewable sources (Diesel, Petrol, Kerosene)
paired_testing(paired_enc, var_name="power_sources_unclean", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community\*

```{r}
community_reg(df=paired_enc, 
              col_name="power_sources_unclean", dep="-1", 
              title="Power Source (Non-Renewable) by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff =TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Linear Regression - Individual

#### Logistic Regression - Individual

```{r}
consumption_reg(df = paired_enc, reg_type ="logistic",
                dep= "power_sources_unclean", 
                ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Unclean Power Sources",
                log_direction = -1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### No. of Appliances

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

#### Paired Test

```{r}
paired_testing(paired_enc, var_name = "appliances_count", 
               plot_diff = TRUE, 
               test_type="ttest", remove_outliers=TRUE,
               x_axis="Differences", y_axis="Count",
               plt_title="Difference in Pre-Post House Appliances")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = paired_enc, reg_type ="logistic",
                dep= "appliances_count", 
                ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="No. of Appliances",
                log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### Light Hours

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value between 0 and 24

#### TODO: Paired Test\*

```{r}
## How many hours of light per day do you currently have at home?
reg_temp <- paired_enc %>% filter(!light_hours_current_pre %in% c(46, 25) |
                                  !light_hours_current_post %in% c(200))
paired_testing(reg_temp, var_name = "light_hours_current", 
               plot_diff = TRUE, 
               test_type="ttest", 
               remove_outliers=TRUE,
               x_axis="Differences", y_axis="Count",
               plt_title="Difference in Pre-Post House Light Hours")

ctr <- "nigeria"
print(ctr)
country_df <- reg_temp %>% filter(country_post == 1)
paired_testing(country_df, var_name = "light_hours_current", 
               plot_diff = TRUE, 
               test_type="ttest", remove_outliers=TRUE,
               x_axis="Differences", y_axis="Count",
               plt_title="Nigeria: Difference in Pre-Post House Light Hours")

#country_df[, c("light_hours_current_pre", "light_hours_current_post")]

ctr <- "kenya"
print(ctr)
country_df <- reg_temp %>% filter(country_post == 2)
paired_testing(country_df, var_name = "light_hours_current", 
               plot_diff = TRUE, 
               test_type="ttest", remove_outliers=TRUE,
               x_axis="Differences", y_axis="Count",
               plt_title="Kenya: Difference in Pre-Post House Light Hours")
```

### Households - Academic Performance

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

#### Regression - Community\*

```{r}
# Has school performance changed since connection to minigrid?
community_reg(df=post_enc, 
              col_name="school_performance_change", 
              dep="1", var_type="categorical",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="hs", y_axis= "Households",
              title="Households - Increase in Academic Performace by Community")
```

#### TODO: Logistic Regression - Individual\*

```{r}
# Found an undesired effect
consumption_reg(df = post_enc, reg_type ="logistic",
                dep= "school_performance_change", 
                ind="avg_mon_consumption_period",
                #calc_diff=FALSE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Households - School Performance Change",
                log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

```{r}
consumption_reg(df = post_enc, reg_type ="logistic",
                dep= "school_performance_change", 
                ind="avg_mon_consumption_cum",
                #calc_diff=FALSE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kwH)", 
                y_axis="Households - School Performance Change",
                log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### Schools - Academic Performance

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

#### Regression - Community\*

```{r}
## Have you seen a change in overall school performance?
community_reg(df=schools_enc, 
              col_name="school_performance", dep="1", var_type="categorical",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="school", y_axis= "Schools",
              title="Schools - Increase in Academic Performace by Community")
```

### Operation Hours Change

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, they have increased" = 1, "Yes, they have decreased" = -1, "No, it is pretty much the same" = 0

#### Regression - Community

```{r}
## Since connection to Renewvia mini-grid, have your hours of operation changed at all?
community_reg(df=ci_enc, 
              col_name="operations_hours_change", 
              dep="1", var_type="categorical",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="ci", y_axis= "C&I",
              title="Increase in Operation Hours by Community")
```

#### TODO: Logistic Regression - Individual

```{r}
consumption_reg(df = ci_enc, reg_type ="logistic",
                dep= "operations_hours_change", 
                ind="avg_mon_consumption_cum",
                #calc_diff=FALSE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kwH)", 
                y_axis="Hours of Operations Change",
                log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### Workforce Change

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes, we have added workers" = 1, "Yes, we have lost workers" = -1, "No, the number has remained the same" = 0

#### Regression - Community\*

```{r}
# Since connection to Renewvia mini-grid, have you had any change in number of workers/employees at your place of work?
community_reg(df=business_enc, 
              col_name="workforce_change", 
              dep="1", var_type="categorical",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="business", y_axis= "Businesses",
              title="Increase in C&I's Workforce by Community")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df = business_enc, reg_type ="logistic",
                dep= "workforce_change", 
                ind="avg_mon_consumption_cum",
                #calc_diff=FALSE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kwH)", 
                y_axis="Workforce Change",
                log_direction = 1,
                exclude_outliers = TRUE, outliers = "feature",
                title="Individual Directional Change vs Consumption")
```

### Adding New Products/Services

**Data Source**: C&I Post-Survey

**Value (Encoding if applied)**: "Yes" = 1, "No" = 0

#### Regression - Community\*

```{r}
# Have you added any new products or services since connection to Renewvia minigrid?
community_reg(df=ci_enc, 
              col_name="ci_offering_change", 
              dep="1", var_type="categorical",
              exclude_outliers = TRUE, outliers = "feature",
              customer_type="ci", y_axis= "C&I",
              title="Newly Added Offerings by Community")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=ci_enc, reg_type ="logistic",
                dep= "ci_offering_change", ind="avg_mon_consumption_cum",
                #calc_diff=FALSE, diff_type = "direction",
                exclude_outliers = TRUE, outliers = "feature",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kwH)", 
                y_axis="Product Offering Change", log_direction = 1,
                title="Newly Added Offerings vs. Energy Consumption")
```

# 4- Health

## A) Descriptive

### Water

#### All Sources

```{r}
## What is your source of water?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="water_source", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Sources",
                 title="Unpaired: Water Sources",
                 char_remove=NULL)

# Paired
compare_paired(data=paired_clean,
               var_name="water_source",
               lgd_title="Sources",
               plot_title="Paired: Water Sources")
```

#### Access to Clean Drinking Water

```{r}
# Do you have a source for clean drinking water?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="clean_drinking_water", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Accessible?",
                 title="Unpaired: Breakdown of Clean Drinking Water Access")

# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="clean_drinking_water_pre", 
               var2="clean_drinking_water_post", 
               lgd_title ="Accessible?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Breakdown of Clean Drinking Water Access")

# Paired
compare_paired(data=paired_clean,
               var_name="clean_drinking_water",
               lgd_title="Accessible?",
               plot_title="Paired: Chnage in Clean Drinking Water Access")
```

#### Clean Sources

```{r}
# What is the source for clean drinking water?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="clean_drinking_water_source", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Do you have clean drinking water?",
                 title="Unpaired: Clean Drinking Water Sources")

# Paired
compare_paired(data=paired_clean,
               var_name="clean_drinking_water_source",
               lgd_title="Do you have clean drinking water?",
               plot_title="Paired: Clean Drinking Water Sources")
```

### Kerosene Lamps

#### Count

```{r}
# How many kerosene lamps do you currently have in your household?
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="kerosene_lamps_count", var_type="cont",
                 subplot_type="hist", exclude_outliers = TRUE, 
                 title="Unpaired: No. of Kerosene Lamps",
                 char_remove=c(24))
```

#### Usage Change

```{r}
# Has the number of kerosene lamps in your household changed since connection to minigrid?
plot_func(df=post_clean, var_name="kerosene_lamp_usage_change", lgd ="Change", 
          var_type="non_cont", plot_title="Kerosene Lamps Usage", 
          plot_type="pie")
```

### Healthcare

#### Clinic's Electricity

```{r}
# # Does your Health Center have access to electricity?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="clinic_electricity_access", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Electrified?",
                 title="Unpaired: Breakdown of Clinic Access To Electricity")

# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="clinic_electricity_access_pre", 
               var2="clinic_electricity_access_post", 
               lgd_title ="Electrified?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Breakdown of of Clinic Access To Electricity")

# Paired
compare_paired(data=paired_clean,
               var_name="clinic_electricity_access",
               lgd_title="Electrified?",
               plot_title="Paired: Change in Clinic Access To Electricity")
```

#### Clinic Travel Distance

```{r}
## How close is the nearest Health Center / Clinic
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="clinic_travel_distance", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Distances",
                 title="Unpaired: Clinic Travel Distance")


# Paired
compare_paired(data=paired_clean,
               var_name="clinic_travel_distance",
               lgd_title="Distances",
               plot_title="Paired: Clinic Travel Distance")
```

#### Clinic's Refrigeration

```{r}
# Does your Health Center / Clinic have access to refrigeration?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="clinic_refrigeration_access", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Has refrigeration?",
                 title="Unpaired: Clinic Access to Refrigeration")

# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="clinic_refrigeration_access_pre", 
               var2="clinic_refrigeration_access_post", 
               lgd_title ="Has refrigeration?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Breakdown of of Clinic Access to Refrigeration")

# Paired
compare_paired(data=paired_clean,
               var_name="clinic_refrigeration_access",
               lgd_title="Has refrigeration?",
               plot_title="Paired: Change in Clinic Access to Refrigeration")
```

#### New Health Services

```{r}
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="non_cont", plot_title="No. of New Health Services", 
          plot_type="pie", lgd="No. of Health Services", char_remove = 0)
```

```{r}
# What is the Clinic / Hospital able to offer or provide due to connection to Renewvia minigrid that it wasnt able to offer before?
plot_func(df=ci_clean, var_name="health_offering_change_count", 
          var_type="cont", plot_title="No. of New Health Services", 
          plot_type="hist", char_remove = 0)
```

#### Types of Services

```{r}
# What were those added services?
wait <- sum(ci_clean$shorter_wait, na.rm = TRUE)
vaccines <- sum(ci_clean$vaccine_cold_storage, na.rm = TRUE)
patients <- sum(ci_clean$more_patients_treated, na.rm = TRUE)
hours <- sum(ci_clean$clinic_longer_hours, na.rm = TRUE)

vals <- c(wait, vaccines, patients, hours)

# creating matrix
tab <- as.data.frame(as.matrix(vals), 
                     row.names = c("Shorter.Wait.Times", 
                                   "Vaccines.Cold.Storage", 
                                   "More.Patients", 
                                   "Longer.Hours"))
setnames(tab, old = c('V1'),
          new = c("Count"))
# t(tab)
tab
```

## B) Inferential

### Access to clean drinking water

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

#### Paired Test\*

```{r}
# Do you have a source for clean drinking water?
paired_testing(paired_enc, var_name="clean_drinking_water", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community

```{r}
# Regression - Pre-Post Differences
community_reg(df=paired_enc, 
              col_name="clean_drinking_water", dep="1", 
              var_type="categorical", 
              calc_diff = TRUE,diff_type="direction",
              exclude_outliers = TRUE, 
              customer_type="hs", y_axis= "Households",
              title="Increase in Access to clean drinking water by Community")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="clean_drinking_water", ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Access Change", log_direction = 1,
                title="Access To Clean Drinking Water vs. Energy Consumption")
```

### Kerosene Lamps

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

#### Paired Test\*

```{r}
## How many kerosene lamps do you currently use in your household? 
paired_testing(paired_enc, var_name="kerosene_lamps_count", 
               test_type = "ttest", x_axis="Differences", y_axis="Count",
               plt_title="Difference in Pre-Post Kerosone Lamps",
               plot_diff=TRUE, remove_outliers = TRUE)
```

#### Regression - Community

```{r}
community_reg(df=paired_enc, 
              col_name="kerosene_lamps_count", dep="-1", 
              title="Difference in Kerosene Lamps by Community", 
              var_type="categorical", 
              calc_diff = TRUE, diff_type="direction",
              exclude_outliers = TRUE,
              customer_type="hs", y_axis= "Households")
```

#### TODO: Regression - Consumption\*

```{r}
# Differences in period
consumption_reg(df = paired_enc, reg_type ="linear",
                dep= "kerosene_lamps_count", 
                ind="avg_mon_consumption_period",
                calc_diff=TRUE, diff_type="magnitude",
                exclude_outliers = TRUE, outliers = "dependent", 
                to_remove = c(0),
                # threshold = -4, threshold_bound = "higher",
                x_axis="Avg. Monthly Energy Consumption In Period (kWh)", 
                y_axis="Usage Change", 
                title="Difference Kersone Lamps Use vs. Consumption")
```

```{r}
# Post use
consumption_reg(df = post_enc, reg_type ="linear",
                dep= "kerosene_lamps_count", 
                ind="avg_mon_consumption_cum",
                #calc_diff=TRUE, diff_type="magnitude",
                exclude_outliers = TRUE, outliers = "dependent", 
                to_remove = c(0),
                # threshold = -4, threshold_bound = "higher",
                x_axis="Avg. Monthly Energy Consumption In Period (kWh)", 
                y_axis="No. of Kerosene Lamps", 
                title="Kerosene Use vs. Consumption")
```

#### TODO: Logistic Regression - Individual\*

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="kerosene_lamps_count", ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption In Period (kWh)", 
                y_axis="Usage Change (Decrease)", log_direction = -1,
                title="Kerosene Lamps Usage vs. Energy Consumption")
```

### Kerosene Lamps Usage

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

#### Regression - Community\*

```{r}
community_reg(df=post_enc, 
              col_name="kerosene_lamp_usage_change", dep="-1", 
              var_type="categorical",
              exclude_outliers = TRUE, outliers = "feature", 
              title="Decrease in Kerosene Lamps Usage by Community",
              customer_type="hs", y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=post_enc,  reg_type ="logistic",
                dep="kerosene_lamp_usage_change", ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption In Period (kWh)", 
                y_axis="Usage Change (Decrease)", log_direction = -1,
                title="Kerosene Lamps Usage vs. Energy Consumption")
```

### New Health Services

**Data Source**: Commercial & Institution Post Survey

**Value (Encoding if applied)**: Any value

#### Regression - Community

```{r}
## For clinics or health services only: Since connection to Renewvia mini-grid, have your health service offerings changed in any of the following ways: (select all that apply).
community_reg(df=clinic_enc, 
              col_name="health_offering_change_count", dep="V1", 
              exclude_outliers = TRUE, outliers = "feature", 
              title="New Health Services Offered in Communities", 
              var_type="ratio", to_remove =c(0),
              customer_type="clinic", y_axis= "Clinics")
```

#### Logistic Regression - Individual

```{r}
clinic_enc$health_add <- ifelse(clinic_enc$health_offering_change_count > 0, 1, 0)
consumption_reg(df=clinic_enc,  reg_type ="logistic",
                dep="health_add", 
                ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Health Services (Increase)", log_direction = 1,
                title="Health Service Offering vs. Consumption")
```

### Clinic Access To Electricity

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

#### Paired Test\*

```{r}
## Does your Health Center / Clinic have access to electricity?
paired_testing(paired_enc, var_name="clinic_electricity_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="clinic_electricity_access", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption In Period (kWh)", 
                y_axis="Access Change (Increase)", log_direction = 1,
                title="Clinic's Electricity Access vs. Consumption")
```

### Clinic Access To Refrigeration

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

#### Paired Test\*

```{r}
## Does your Health Center / Clinic have access to refrigeration?
paired_testing(paired_enc, var_name="clinic_refrigeration_access", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="clinic_refrigeration_access", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption In Period (kWh)", 
                y_axis="Access Change (Increase)", log_direction = 1,
                title="Clinic's Refrigeration Access vs. Consumption")
```

### TODO: Better access to healthcare

**Data Source**: Household Post-Survey

**Value (Encoding if applied)**: "yes" = 1; "no" = 0

#### Regression - Community\*

```{r}
# Do you feel that you have better access to health services because of connection to minigrid?
community_reg(df=post_enc, 
              col_name="better_access_health_minigrid", 
              dep="1", var_type="categorical",
              exclude_outliers = TRUE, 
              #  outliers = "feature", 
              title="Better Healthcare Access by Community",
              customer_type="hs", y_axis= "Households") 
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=post_enc,  reg_type ="logistic",
                dep="better_access_health_minigrid", 
                ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Access Change (Increase)", log_direction = 1,
                title="Better Access To Healthcare vs. Consumption")
```

# 5- Safety

## A) Descriptive

### Feeling Safe

```{r}
# How safe do you feel outside your home when it is dark?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="feel_safe_dark", var_type="non_cont",
                 subplot_type="bar_simple", lgd_title = "Scores",
                 title="Unpaired: Feeling Safe When Dark")

# Paired
compare_paired(data=paired_clean,
               var_name="feel_safe_dark",
               lgd_title="Score",
               plot_title="Paired: Feeling Safe When Dark")
```

```{r}
for(i in 1: 5) {
  safe_i <- paired_enc %>% filter(feel_safe_dark_pre == i)
  compare_paired(data=safe_i,
               var_name="feel_safe_dark",
               lgd_title=paste("Scores When Equal to ", i),
               plot_title="Paired: Feeling Safe When Dark")
}
```

### Reasons for Feeling Unsafe

```{r}
# What makes you feel the most unsafe?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="feel_unsafe_reasons", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Reasons",
                 title="Unpaired: Reasons for Feeling unsafe")

# Paired
compare_paired(data=paired_clean,
               var_name="feel_unsafe_reasons",
               lgd_title="Reasons",
               plot_title="Paired: Reasons for Feeling unsafe")

## Subgroup analysis using pre-survey reasons, what was their post-survey
```

```{r}
as.data.frame.matrix(table(paired_enc$feel_safe_levels_pre, 
                        paired_enc$feel_safe_levels_post)
            )
```

### Presence of Community Lights

```{r}
# Does your community currently have outdoor community lights?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="community_lights", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Present?",
                 title="Unpaired: Presence of Community Lights")

# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="community_lights_pre", 
               var2="community_lights_post", 
               lgd_title ="Present?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Presence of Community Lights")

# Paired
compare_paired(data=paired_clean,
               var_name="community_lights",
               lgd_title="Present?",
               plot_title="Paired: Change in Presence of Community Lights")
```

### Household - Exterior Lights

```{r}
# Does your home have exterior lighting?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="home_exterior_lights", var_type="non_cont",
                 subplot_type="pie", 
                 lgd_title = "Does the home have exterior lights?",
                 title="Unpaired: Presence of Home Exterior Lights")
# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="home_exterior_lights_pre", 
               var2="home_exterior_lights_post", 
               lgd_title ="Present?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Presence of Home Exterior Lights")

# Paired
compare_paired(data=paired_clean,
               var_name="home_exterior_lights",
               lgd_title="Does the home have exterior lights?",
               plot_title="Paired: Change in Presence of Home Exterior Lights")
```

### Exterior Lights By Mini-Grid

```{r}
# Is this exterior lighting powered by minigrid?
plot_func(df=post_clean, var_name="exterior_lights_minigrid", 
          var_type="non_cont", lgd="Powered by Mini-Grid",
          plot_title="Households - Exterior Lights Powered by Mini-Grid", 
          plot_type="pie")
```

## B) Inferential

### Feeling Safe

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "Very unsafe" = 1; "Somewhat unsafe" = 2; "Neither safe nor unsafe"= 3; "Somewhat safe" = 4; "Very safe" = 5

#### TODO: Paired Test\*

```{r}
# # How safe do you feel outside your home when it is dark?
print("All")
paired_testing(paired_enc, var_name="feel_safe_levels", 
               test_type = "sign", plot_diff=TRUE, diff_type = "direction",
               #remove_outliers = TRUE, 
               #threshold = 4, threshold_bound = "lower",
               x_axis="Differences", y_axis="Count",
               plt_title="All - Difference in Pre-Post Safety Scores")

## Subgroup Analysis - Country
# Nigeria
print("Nigeria")
ctr <- 1
country_paired <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_paired, var_name="feel_safe_levels", 
               test_type = "sign", plot_diff=TRUE,
               diff_type = "direction",
               #remove_outliers = TRUE, 
              # threshold = 4, threshold_bound = "lower",
               x_axis="Differences", y_axis="Count",
               plt_title="Nigeria - Difference in Pre-Post Safety Scores")
# Kenya
print("Kenya")
ctr <- 2
country_paired <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_paired, var_name="feel_safe_levels", 
               test_type = "sign", plot_diff=TRUE,
               diff_type = "direction",
               #remove_outliers = TRUE, 
               #threshold = 4, threshold_bound = "lower",
               x_axis="Differences", y_axis="Count",
               plt_title="Kenya - Difference in Pre-Post Safety Scores")
```

### Unsafe Travel

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "Yes" = 1; "No" = 0

#### Paired Test\*

```{r}
paired_testing(paired_enc, var_name="unsafe_due_to_unsafe_travel", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community

```{r}
community_reg(df=paired_enc, 
              col_name="unsafe_due_to_unsafe_travel", dep="-1", 
              title="Decrease in Feeling Unsafe Due to Travel", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="unsafe_due_to_unsafe_travel", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kWh)", 
                y_axis="Feeling Unsafe Change (Decrease)", log_direction = -1,
                title="Due To Travel vs. Consumption")
```

### Communnity Lighting

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "Yes" = 1; "No" = 0

#### Paired Test\*

```{r}
paired_testing(paired_enc, var_name="unsafe_due_to_lack_of_community_lighting", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community

```{r}
community_reg(df=paired_enc, 
              col_name="unsafe_due_to_lack_of_community_lighting", dep="-1", 
              title="Decrease in Feeling Unsafe Due to Lack of Community Lighting", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="unsafe_due_to_lack_of_community_lighting", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kWh)", 
                y_axis="Feeling Unsafe Change (Decrease)", log_direction = -1,
                title="Due To Community Lighting vs. Consumption")
```

### Potential Theft

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "Yes" = 1; "No" = 0

#### TODO: Paired Test\*

```{r}
# Undesired outcome
paired_testing(paired_enc, var_name="unsafe_due_to_theft", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community

```{r}
# What makes you feel the most unsafe? Testing for Potentiel Theft only
community_reg(df=paired_enc, 
              col_name="unsafe_due_to_theft", dep="-1", 
              title="Decrease in Feeling Unsafe Due to Theft", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="unsafe_due_to_theft", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kWh)", 
                y_axis="Feeling Unsafe Change (Increase)", log_direction = -1,
                title="Due To Theft vs. Consumption")
```

### Presence of House Exterior Lights\*

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "Yes" = 1; "No" = 0

#### Paired Test\*

```{r}
# Does your home have exterior lighting?
paired_testing(paired_enc, var_name="home_exterior_lights", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community

```{r}
community_reg(df=paired_enc, 
              col_name="home_exterior_lights", dep="1", 
              title="Increase in Home Exterior Lighting", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="home_exterior_lights", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kWh)", 
                y_axis="Access Change (Increase)", log_direction = -1,
                title="Home Exterior Lighting vs. Consumption")
```

# 6- Economic Activity

## A) Descriptive

### Occupation Change

```{r}
# Has your (or your spouses) occupation changed since youve been connected to minigrid power?
plot_func(df=post_clean, var_name="occupation_change", 
          var_type="non_cont", lgd="Change in Occupation?",
          plot_title="Change in Occupation of Primary Provider", 
          plot_type="pie")
```

### Household Income

#### Nigeria

```{r}
# What is your average monthly household income:
# Unpaired
ctr <- "nigeria"
country_pre <- initial_pre %>% filter(country == ctr)
country_post <- post_clean %>% filter(country == ctr)
compare_pre_post(df_pre=country_pre, df_post=country_post, 
                 var_name="avg_household_income", var_type="cont",
                 subplot_type="hist", shared_legend=FALSE,
                 exclude_outliers = TRUE,
                 x_axis="Value ( Naira)", y_axis="Count",
                 title="Unpaired: Nigeria - Average Household Income")
```

#### Kenya

```{r}
# Unpaired
ctr <- "kenya"
country_pre <- initial_pre %>% filter(country == ctr)
country_post <- post_clean %>% filter(country == ctr)
compare_pre_post(df_pre=country_pre, df_post=country_post, 
                 var_name="avg_household_income", var_type="cont",
                 subplot_type="hist", shared_legend=FALSE,
                 exclude_outliers = TRUE,
                 x_axis="Value (Ksh)", y_axis="Count",
                 title="Unpaired: Kenya - Average Household Income")
```

### Household Income Change

```{r}
# Has your household income changed since your connection to minigrid power?
plot_func(df=post_clean, var_name="household_income_change", 
          var_type="non_cont", lgd="Change",
          plot_title="Change in Household Income", 
          plot_type="pie")
```

### Household Expenses

#### Phone Charging

```{r}
# How much do you pay per month to charge your mobile phone?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="phone_charge_cost", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Costs",
                 title="Unpaired: Phone Charging Cost")

# Paired
compare_paired(data=paired_clean,
               var_name="phone_charge_cost",
               lgd_title="Costs",
               plot_title="Paired: Phone Charging Cost")
```

#### Appliances Charging

```{r}
# What is approximate monthly cost of energy used strictly for charging appliances?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="applicances_charging_cost", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Costs",
                 title="Unpaired: Appliances Charging Cost")

# Paired
compare_paired(data=paired_clean,
               var_name="applicances_charging_cost",
               lgd_title="Costs",
               plot_title="Paired: Appliances Charging Cost")
```

#### Cooking Energy

```{r}
# What is the approximate monthly cost of energy used strictly for cooking?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="cooking_energy_cost", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Costs",
                 title="Unpaired: Cooking Energy Cost")

# Paired
compare_paired(data=paired_clean,
               var_name="cooking_energy_cost",
               lgd_title="Costs",
               plot_title="Paired: Cooking Energy Cost")
```

#### Kerosene Lamps

```{r}
# How much do you pay monthly for kerosene used only in kerosene lamps?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="kerosene_lamps_cost", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Costs",
                 title="Unpaired: Kerosene Lamps Cost")

# Paired
compare_paired(data=paired_clean,
               var_name="kerosene_lamps_cost",
               lgd_title="Costs",
               plot_title="Paired: Kerosene Lamps Cost")
```

### Local Business Creation

#### Business Owners

```{r}
# Are any household members business owners?
# Unpaired
compare_pre_post(df_pre=initial_pre, df_post=post_clean, 
                 var_name="business_owners_binary", var_type="non_cont",
                 subplot_type="pie", lgd_title = "Own a Business?",
                 title="Unpaired: Household Business Ownership")
# Paired
generic_compare(data=paired_clean, var_type="non_cont",
               var1="business_owners_binary_pre", 
               var2="business_owners_binary_post", 
               lgd_title ="Own a Business?",
               var1_title="Pre", var2_title="Post", 
               subplot_type="pie", 
               plot_title="Paired: Household Business Ownership")
# Paired
compare_paired(data=paired_clean,
               var_name="business_owners_binary",
               lgd_title="Own a Business?",
               plot_title="Paired: Change in Household Business Ownership")
```

#### Recently Open

```{r}
# Is this business recent (started after connection to minigrid power?)
plot_func(df=post_clean, var_name="business_recent", 
          var_type="non_cont", lgd="Recent?",
          plot_title="Recent Business Ownership", 
          plot_type="pie")
```

#### Mini-grid related

```{r}
# If this business is new, do you consider this new business a result of having access to minigrid power?
plot_func(df=post_clean, var_name="business_use_minigrid", 
          var_type="non_cont", lgd="Recent?",
          plot_title="Business, A Result From Mini-Grid", 
          plot_type="pie")
```

### C&I

#### Operation Status

```{r}
# Is this business, clinic, school still in operation?
plot_func(df=ci_clean, var_name="operation_status", 
          var_type="non_cont", lgd = "Status",
          plot_title="C&I - Type", 
          plot_type="pie")
```

#### Business Type

```{r}
# Please select your business type
plot_func(df=ci_clean, var_name="business_type", 
          var_type="non_cont", lgd = "Business Type",
          plot_title="C&I - Type", 
          plot_type="pie")
```

## B) Inferential

### Avg. Household Income - Nigeria

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

#### TODO: Paired Testing\*

```{r}
## What is your average monthly household income? 
ctr <- "nigeria"
nigeria_paired_enc <- paired_enc %>% filter(country_post == 1)
paired_testing(nigeria_paired_enc, var_name="avg_household_income",
               test_type = "ttest", plot_diff=TRUE, 
               remove_outliers = TRUE,
               x_axis="Value ( Naira)", y_axis="Count",
               plt_title="Nigeria - Income Differences")
```

#### Linear Regression - Individual\*

```{r}
consumption_reg(df = post_enc, reg_type ="linear",
                dep= "avg_household_income", ind="avg_mon_consumption_period",
                #calc_diff=TRUE, diff_type = "magnitude",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kwH)", 
                y_axis="Income ( Naira)", 
                exclude_outliers = TRUE, outliers = "dependent",
                #threshold = 0, threshold_bound = "lower",
                title="Avg. Household Income vs Consumption")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=nigeria_paired_enc,  reg_type ="logistic",
                dep="avg_household_income", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kWh)", 
                y_axis="Income (Increase)", log_direction = 1,
                title="Avg. Household Income vs. Consumption")

consumption_reg(df=nigeria_paired_enc,  reg_type ="logistic",
                dep="avg_household_income", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kWh)", 
                y_axis="Income (Decrease)", log_direction = -1,
                title="Avg. Household Income vs. Consumption")
```

### Avg. Household Income - Kenya

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: Any numeric value

#### TODO: Paired Testing\*

```{r}
ctr <- "kenya"
country_df <- paired_clean %>% filter(country_post == ctr)
paired_testing(country_df, var_name="avg_household_income", 
               test_type = "ttest", plot_diff=TRUE,
               remove_outliers = TRUE,
               x_axis="Value (Ksh)", y_axis="Count",
               plt_title="Kenya - Income Differences")
```

### Household - Income Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

#### Regression - Community

```{r}
## Has your household income changed since your connection to mini-grid power?
community_reg(df=post_enc, 
              col_name="household_income_change", dep="1", 
              title="Household Income Increase by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = FALSE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

```{r}
nigeria_post_enc <- post_enc %>% filter(country == 1)
community_reg(df=nigeria_post_enc, 
              col_name="household_income_change", dep="1", 
              title="Nigeria - Household Income Increase by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = FALSE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

```{r}
kenya_post_enc <- post_enc %>% filter(country == 2)
community_reg(df=kenya_post_enc, 
              col_name="household_income_change", dep="1", 
              title="Kenya - Household Income Increase by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = FALSE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=post_enc,  reg_type ="logistic",
                dep="household_income_change", 
                ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Change (Increase)", log_direction = 1,
                title="Household Income vs. Consumption")
```

```{r}
consumption_reg(df=nigeria_post_enc,  reg_type ="logistic",
                dep="household_income_change", 
                ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Change (Increase)", log_direction = 1,
                title="Nigeria - Household Income vs. Consumption")
```

```{r}

```

### C&I - Earnings Change

**Data Source**: Household Post Survey

**Value (Encoding if applied)**: "Yes, it's decreased" = -1; "No, it's the same" = 0; "Yes, it's increased" = 1

#### Regression - Community\*

```{r}
# For businesses or shop owners only: Since connection to Renewvia mini-grid, have you seen any change in your weekly or monthly earnings?
community_reg(df=ci_enc, 
              col_name="earnings_change", dep="1", 
              title="C&I Earnings Increase by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = FALSE,
              diff_type="direction", customer_type="ci", 
              y_axis= "C&I")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=ci_enc,  reg_type ="logistic",
                dep="earnings_change", 
                ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Change (Increase)", log_direction = 1,
                title="Earnings vs. Consumption")
```

```{r}
nigeria_ci_enc <- ci_enc %>% filter(country == 1)
consumption_reg(df=nigeria_ci_enc,  reg_type ="logistic",
                dep="earnings_change", 
                ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Change (Increase)", log_direction = 1,
                title="Nigeria - C&I Earnings vs. Consumption")
```

```{r}
kenya_ci_enc <- ci_enc %>% filter(country == 2)
consumption_reg(df=kenya_ci_enc,  reg_type ="logistic",
                dep="earnings_change", 
                ind="avg_mon_consumption_cum",
                exclude_outliers = TRUE, outliers = "feature",
                #calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Cumulative (kWh)", 
                y_axis="Change (Increase)", log_direction = 1,
                title="Nigeria - C&I Earnings vs. Consumption")
```

### Business Ownership

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "None" = 0; "Not None" = 1

#### Paired Test\*

```{r}
# Are any household members business owners?
paired_testing(paired_enc, var_name="business_owners_binary", 
               test_type = "mcnemar", plot_diff=FALSE)
```

#### Regression - Community\*

```{r}
community_reg(df=paired_enc, 
              col_name="business_owners_binary", dep="1", 
              title="Household Business Onwership by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff =TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

#### Logistic Regression - Individual

```{r}
consumption_reg(df=paired_enc,  reg_type ="logistic",
                dep="business_owners_binary", 
                ind="avg_mon_consumption_period",
                exclude_outliers = TRUE, outliers = "feature",
                calc_diff=TRUE, diff_type = "direction",
                x_axis="Avg. Monthly Energy Consumption Pre-Post Period (kWh)", 
                y_axis="Change (Increase)", log_direction = 1,
                title="Business Ownership vs. Consumption")
```

### Phone Charging Cost

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "Nothing" = 0; "0_100_nkes" = 1, "100_500_nkes" = 2, "500_750_nkes": 3, "750_1000_nkes" = 4, "1000_nkes_and_above" = 5, "1000_n_and_above" = 5

#### TODO: Paired Test\*

```{r}
paired_testing(paired_enc, var_name="phone_charge_cost", 
               test_type = "wilcoxon", x_axis="Differences", y_axis="Count",
               plt_title="Nigeria: Difference in Pre-Post Phone Charging Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )
```

#### Paired Test by Country

```{r}
# Phone Charging
# Nigeria
ctr <- 1
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="phone_charge_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Nigeria: Difference in Pre-Post Phone Charging Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )


# Kenya
ctr <- 2
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="phone_charge_cost", 
               test_type = "wilcoxon", x_axis="Differences", y_axis="Count",
               plt_title="Kenya: Difference in Pre-Post Phone Charging Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )
```

#### Regression - Community

```{r}
# ctr <- 1
# country_df <- paired_enc %>% filter(country_post == ctr)
community_reg(df=paired_enc, 
              col_name="phone_charge_cost", dep="-1", 
              title="Phone Charging Cost Savings by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

```{r}

```

### Appliance Charging Cost

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "nothing" = 0, "0_150_nkes" = 1, "150_1000_nkes" = 2, "1000_3000_nkes" = 3, "3000_4000_nkes" = 4, "4000_6000_nkes" = 5

#### Paired Test\*

```{r}
# Nigeria
ctr <- 1
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="applicances_charging_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Nigeria: Difference in Pre-Post Appliances Charging Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )


# Kenya
ctr <- 2
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="applicances_charging_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Kenya: Difference in Pre-Post Appliances Charging Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
)
```

#### Regression - Community

```{r}
community_reg(df=paired_enc, 
              col_name="applicances_charging_cost", dep="-1", 
              title="Appliance Charging Cost Savings by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

### Cooking Energy Cost

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "nothing" = 0, "0_1000_nkes" = 1, "1000_1500_nkes" = 2, "1500_2000_nkes" = 3, "2000_3000_nkes" = 4, "3000_4000_nkes" = 5

#### Paired Test\*

```{r}
# Nigeria
ctr <- 1
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="cooking_energy_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Nigeria: Difference in Pre-Post Cooking Energy Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )


# Kenya
ctr <- 2
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="cooking_energy_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Kenya: Difference in Pre-Post Cooking Energy Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )
```

```{r}
community_reg(df=paired_enc, 
              col_name="cooking_energy_cost", dep="-1", 
              title="Cooking Energy Cost Savings by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

### Kerosene Lamps Cost

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "nothing" = 0,"0_200_nkes" = 1,"200_600_nkes" = 2,"600_1000_nkes" = 3,"1000_1400_nkes" = 4,"1400_nkes_and_above" = 5

#### Paired Test\*

```{r}
# Nigeria
ctr <- 1
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="kerosene_lamps_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Nigeria: Difference in Pre-Post Kerosene Lamps Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )


# Kenya
ctr <- 2
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="kerosene_lamps_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Kenya: Difference in Pre-Post Kerosene Lamps Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )
```

```{r}
community_reg(df=paired_enc, 
              col_name="kerosene_lamps_cost", dep="-1", 
              title="Kerosene Lamps Cost Savings by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```

### Water Cost

**Data Source**: Paired Household Surveys (Pre & Post)

**Value (Encoding if applied)**: "nothing" = 0, "0_500_nkes" = 1, "500_3000_nkes" = 2, "3000_5000_nkes" = 3, "5000_nkes_and_above" = 4

#### Paired Test\*

```{r}
# Nigeria
ctr <- 1
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="water_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Nigeria: Difference in Pre-Post Water Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )


# Kenya
ctr <- 2
country_df <- paired_enc %>% filter(country_post == ctr)
paired_testing(country_df, var_name="water_cost", 
               test_type = "sign", x_axis="Differences", y_axis="Count",
               plt_title="Kenya: Difference in Pre-Post Water Cost",
               plot_diff=TRUE, 
               #remove_outliers = TRUE
               )
```

```{r}
community_reg(df=paired_enc, 
              col_name="water_cost", dep="-1", 
              title="Water Cost Savings by Community", 
              exclude_outliers = TRUE, outliers = "feature",
              var_type="categorical", calc_diff = TRUE,
              diff_type="direction", customer_type="hs", 
              y_axis= "Households")
```
